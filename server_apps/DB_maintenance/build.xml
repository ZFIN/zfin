<?xml version="1.0" encoding="UTF-8"?>

<project name="Download" default="timestamp-download" basedir="../../">

    <property name="web.dir" value="${basedir}/home"/>
    <property name="web-inf.dir" value="${web.dir}/WEB-INF"/>
    <property name="classbin.dir" value="${web-inf.dir}/classes"/>
    <property name="lib" value="${basedir}/lib/Java"/>
    <property name="web.lib" value="${web-inf.dir}/lib"/>

    <property environment="env"/>

    <!-- Classpath definitions -->
    <path id="classpath">
        <pathelement location="${classbin.dir}"/>
        <pathelement location="${basedir}/server_apps/DB_maintenance/conf"/>
        <fileset dir="${web.lib}">
            <include name="*.jar"/>
        </fileset>
    </path>
	
    <taskdef name="loadProperties"
             classname="org.zfin.properties.ant.LoadPropertiesTask"
             classpathref="classpath"/>

    <loadProperties file="${web-inf.dir}/zfin.properties" />

    <path id="extended.classpath">
        <path refid="classpath"/>
        <fileset dir="${CATALINA_HOME}/endorsed">
            <include name="*.jar"/>
            <include name="*.zip"/>
        </fileset>
    </path>

    <path id="log4j">
        <fileset dir="${basedir}">
            <include name="log4j.xml"/>
        </fileset>
    </path>

    <target name="init">
        <tstamp/>
        <echo message="Set Timestamp on unload."/>
    </target>

    <target name="timestamp-download" description="Set the timestamp of the download files int database_info table">
        <echo message="Update time stamp in DATABASE_INFO table:"/>
        <echo message="Use database: ${DBNAME}"/>
        <run-db-query db-query-file="set_unload_timestamp.sql" instanceName="${DBNAME}"/>
    </target>

    <property name="unloadDir" value="${basedir}/server_apps/DB_maintenance"/>

    <macrodef name="run-db-query">
        <attribute name="db-query-file"/>
        <attribute name="instanceName"/>
        <sequential>
            <java classname="org.zfin.properties.RunSqlQueryTask" fork="yes" classpathref="extended.classpath"
                  failonerror="true">
                <classpath refid="log4j"/>
                <arg value="@{instanceName}"/>
                <arg value="@{db-query-file}"/>
                <arg value="${unloadDir}"/>
            </java>
        </sequential>
    </macrodef>

    <target name="usage">
        <echo>
            TARGETS
        </echo>
    </target>

</project>

