<?xml version="1.0" encoding="UTF-8"?>

<project name="Download" default="timestamp-download" basedir="../../">

    <property name="web.dir" value="${basedir}/home"/>
    <property name="web-inf.dir" value="${web.dir}/WEB-INF"/>
    <property name="classbin.dir" value="${web-inf.dir}/classes"/>
    <property name="lib" value="${basedir}/lib/Java"/>
    <property name="web.lib" value="${web-inf.dir}/lib"/>

    <property environment="env"/>

    <!-- Classpath definitions -->
    <path id="classpath">
        <pathelement location="${classbin.dir}"/>
        <pathelement location="${basedir}/server_apps/DB_maintenance/conf"/>
        <fileset dir="${web.lib}">
            <include name="*.jar"/>
        </fileset>
    </path>
	
    <taskdef name="loadProperties"
             classname="org.zfin.properties.ant.LoadPropertiesTask"
             classpathref="classpath"/>

    <loadProperties file="${web-inf.dir}/zfin.properties" />

    <path id="extended.classpath">
        <path refid="classpath"/>
        <fileset dir="${CATALINA_HOME}/endorsed">
            <include name="*.jar"/>
            <include name="*.zip"/>
        </fileset>
    </path>

    <path id="log4j">
        <fileset dir="${basedir}">
            <include name="log4j.xml"/>
        </fileset>
    </path>

    <target name="init">
        <tstamp/>
        <echo message="Set Timestamp on unload."/>
    </target>

    <target name="timestamp-download" description="Set the timestamp of the download files int database_info table">
        <echo message="Update time stamp in DATABASE_INFO table:"/>
        <echo message="Use database: ${DBNAME}"/>
        <run-db-query db-query-file="set_unload_timestamp.sql" instanceName="${DBNAME}"/>
    </target>

    <property name="validateData" value="${basedir}/server_apps/DB_maintenance"/>

    <target name="report-stage-range-validation" description="Set the timestamp of the download files int database_info table">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
	    <arg value="${DBNAME}" />
	    <arg value="${basedir}/server_apps/DB_maintenance/validatedata/stageRangeValidation.sql"/>
        </exec>
	<echo file="${validateData}/column.header" append="false">Pub ID|Figure ID|Start Stage ID|Xpat Start Stage|End Stage ID|Xpat End Stage|Term ID|Term OBO ID|Term Name|Term Start Stage|Term End Stage|Xpatres ID</echo>
	<echo file="${validateData}/description.txt" append="false">
	  There are expression_result records whose stage window don't overlap with the anatomy term's stage window.
	  </echo>
	<fail message="Failed: There are records that violate the stage range">
	  <condition>
        <resourcecontains resource="reportRecords.txt" substring="ZDB"/>
	  </condition>
	</fail>
    </target>

    <target name="report-linkage-has-member" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
	    <arg value="${DBNAME}" />
	    <arg value="${validateData}/validatedata/linkageHasMember.sql"/>
        </exec>
	<echo file="${validateData}/column.header" append="false">Linkage ID|Linkage Group|Linkage Source ID</echo>
	<echo file="${validateData}/description.txt" append="false">
	  There are records in LINKAGE table that do not have a LINKAGE_MEMBER record.
	</echo>
	<fail message="Failed: There are records in violation">
	  <condition>
        <resourcecontains resource="reportRecords.txt" substring="ZDB"/>
	  </condition>
	</fail>
    </target>

    <target name="report-str-gene-abbrev" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
	    <arg value="${DBNAME}" />
	    <arg value="${validateData}/validatedata/StrGeneAbbreviation.sql"/>
        </exec>
	<echo file="${validateData}/column.header" append="false">STR Abbreviation|Gene Abbreviation</echo>
	<echo file="${validateData}/description.txt" append="false">
        There are STRs without corresponding gene abbreviations.
	</echo>
	<fail message="Failed: There are records in violation">
	  <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
	  </condition>
	</fail>
    </target>

    <target name="report-marker-go-duplicate" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
	    <arg value="${DBNAME}" />
	    <arg value="${validateData}/validatedata/MarkerGoEvidenceDuplicate.sql"/>
        </exec>
	<echo file="${validateData}/column.header" append="false">Count|Marker ID|Term ID|Term OBO ID|Publiction ID|Evidence Code</echo>
	<echo file="${validateData}/description.txt" append="false">
        There are duplicate marker_go_term_evidence records.
	</echo>
	<fail message="Failed: There are records in violation">
	  <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
	  </condition>
	</fail>
    </target>

    <target name="report-marker-go-secondary-annotation" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/MarkerGoSecondaryAnnotation.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">MarkerGOEvidence ID|Marker Symbol|Term Name|Publiction ID</echo>
        <echo file="${validateData}/description.txt" append="false">
        There are marker_go_term_evidence records with secondary terms.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

    <target name="report-publication-duplicate" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/PublicationDuplicate.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">Publication Title|Accession Number|Publication ID|Authors|Publication Date|Journal|Publication Volume|Publication Pages|</echo>
        <echo file="${validateData}/description.txt" append="false">
        Check that there are no duplicate publications.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

    <target name="report-probe-gene-relationship" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/ProbeGeneRelationship.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">ExpressionExperiment ID|Probe ID|Marker ID</echo>
        <echo file="${validateData}/description.txt" append="false">
        Check that there is a marker relationship for every probe / gene in expression_experiment table.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>


   <target name="report-est-contained-in-relationship" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
       	    <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/EstContainedInRelationship.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">Marker 1 ID|Marker 2 ID|Marker Type|Relationship Type</echo>
        <echo file="${validateData}/description.txt" append="false">
	ESTs have 'contained in' relationships.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

   <target name="report-marker-go-inference" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/MarkerGoInference.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">MarkerGoEvidence 1 ID|Marker 1 ID|MarkerGoEvidence 2 ID|Marker 2 ID|Count</echo>
        <echo file="${validateData}/description.txt" append="false">
	Possible duplicate records in marker_go_term_evidence, inference_group_member
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

   <target name="report-associate-curate-orthology" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/AssoicateDataCurationOrthology.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">Data ID|</echo>
        <echo file="${validateData}/description.txt" append="false">
	 Invalid Data associated with ZDB-PUB-030905-1: Either the entity has no attributed GENE or
	 does not have attributed orthologue evidence
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

	<target name="report-est-one-marker" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/ESTOneMarker.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">EST ID|EST Name| EST Abbreviation</echo>
        <echo file="${validateData}/description.txt" append="false">
	ESTs have 0 or more than 1 associated gene.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

	<target name="report-xx-genes-no-clones" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/XXGenesNoClones.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">Marker ID|Marker Name|Marker Abbreviation</echo>
        <echo file="${validateData}/description.txt" append="false">
        <![CDATA[ xx:<xxx> genes should have no clones.]]>
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
       	<resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>

   <target name="report-refseq-accession-format" description="">
        <echo message="Create Validation Report"/>
        <echo message="Use database: ${DBNAME}"/>
        <exec executable="dbaccess"  failifexecutionfails="true">
            <arg value="-a"/>
            <arg value="${DBNAME}" />
            <arg value="${validateData}/validatedata/RefseqAccessionFormat.sql"/>
        </exec>
        <echo file="${validateData}/column.header" append="false">Record ID|DB Name|Accession Number</echo>
        <echo file="${validateData}/description.txt" append="false">
       	RefSeq accession number in wrong format. Needs to have an underscore as the third position.
        </echo>
        <fail message="Failed: There are records in violation">
          <condition>
        <resourcecontains resource="reportRecords.txt" substring="|"/>
          </condition>
        </fail>
    </target>


    <property name="unloadDir" value="${basedir}/server_apps/DB_maintenance"/>

    <macrodef name="run-db-query">
        <attribute name="db-query-file"/>
        <attribute name="instanceName"/>
        <sequential>
            <java classname="org.zfin.properties.RunSqlQueryTask" fork="yes" classpathref="extended.classpath"
                  failonerror="true">
                <classpath refid="log4j"/>
                <arg value="@{instanceName}"/>
                <arg value="@{db-query-file}"/>
                <arg value="${unloadDir}"/>
            </java>
        </sequential>
    </macrodef>

    <target name="usage">
        <echo>
            TARGETS
        </echo>
    </target>

</project>

