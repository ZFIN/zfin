version: '3.8'

services:
  compile:
    container_name: compile_container
    build: ./compile/
    profiles:
      - compile
    environment:
      PGHOST: db
      PGUSER: postgres
      SOLR_HOME: /var/solr
    volumes: 
      #- /opt/zfin/docker/www_homes/zfin.org:/opt/zfin/www_homes/zfin.org
      - www_data:/opt/zfin/www_homes/zfin.org
      - catalina_base:/opt/zfin/catalina_bases/zfin.org
      - ../:/opt/zfin/source_roots/zfin.org
      - nfs-zunloads:/research/zunloads
      - solr_data:/var/solr
      #- ./pg_pass:/run/secrets/pg_pass
  db:
    container_name: pg_container
    build: ./postgresql/
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD_FILE: /run/secrets/pg_pass
      POSTGRES_INITDB_ARGS: "-E SQL_ASCII"
      POSTGRES_DB: zfindb
      POSTGRES_HOST_AUTH_METHOD: trust
    #ports:
    #  - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data/
      - ./pg_pass:/run/secrets/pg_pass:ro
  solr:
    container_name: solr_container
    build: ./solr/
    restart: always
    #ports:
    #  - "8988:8983"
    volumes:
      - solr_data:/var/solr
  httpd:
    container_name: httpd_container
    build: ./httpd/
    restart: always
    ports:
      - "8080:80"
    volumes:
      - www_data:/opt/zfin/www_homes/zfin.org
      - nfs-loadup:/opt/zfin/loadUp
      - /etc/pki/tls/certs/incommon_intermediate_bundle.crt:/etc/pki/tls/certs/incommon_intermediate_bundle.crt
      - /etc/pki/tls/certs/zfin_2021.crt:/etc/pki/tls/certs/zfin_2021.crt
      - /etc/pki/tls/private/zfin_2021.key:/etc/pki/tls/private/zfin_2021.key
  tomcat:
    container_name: tomcat_container
    build: ./tomcat/
    restart: always
    environment:
      CATALINA_BASE: /opt/zfin/catalina_bases/zfin.org
      INSTANCE: docker
    volumes:
      - www_data:/opt/zfin/www_homes/zfin.org
      - catalina_base:/opt/zfin/catalina_bases/zfin.org
      - /opt/zfin/catalina_bases/keystore:/opt/apache/apache-tomcat/conf/keystore

volumes:
  www_data:
  catalina_base:
  pg_data:
  solr_data:
  nfs-zunloads:
    driver_opts:
      type: nfs
      o: addr=10.128.116.85,ro
      device: :/vol/unloads/
  nfs-loadup:
    driver_opts:
      type: nfs
      o: addr=10.128.116.85,ro
      device: :/vol/central/loadUp
