<HTML>

<?MIVAR Name=page_name>$(IF,$(XST,$query_results),ZFIN Accession Search Results,ZFIN Accession Search)<?/MIVAR>

<?MIVAR><TITLE>$page_name</TITLE><?/MIVAR>

<SCRIPT>


</SCRIPT>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>

<?MIVAR NAME=$accession>exists<?/MIVAR>

<?MIBLOCK COND="$(XST,$query_results)">

  <?MIVAR NAME=$MI_NULL>NULL<?/MIVAR>
  <?MIVAR NAME=gcount>0<?/MIVAR>
  <?MIVAR NAME=mcount>0<?/MIVAR>
  <?MIVAR NAME=pcount>0<?/MIVAR>
  <?MIVAR name=jtype>any<?/MIVAR>
  <?MIVAR name=pub_status>any<?/MIVAR>
  <?MIVAR name=cur_status>any<?/MIVAR>
  <?MIVAR name=order_pref>name<?/MIVAR>
  <?MIVAR name=line_type>accession<?/MIVAR>
  <?MIVAR name=mutagen>any<?/MIVAR>
  <?MIVAR name=chrom_change>any<?/MIVAR>
  <?MIVAR name=chrom_num>0<?/MIVAR>
  <?MIVAR name=searchtype>begins<?/MIVAR>
  <?MIVAR name=query_results>exists<?/MIVAR>

  <?MIVAR name=aname>$(TRIM,$(UPPER,$aname))<?/MIVAR>
  <?MIVAR name=OID>$aname<?/MIVAR>

  <!--   THIS BLOCK HANDLES ACCESSION NUMBER SEARCHES ONLY NON ZDB_ID -->
  <?MIBLOCK COND="$(=,$(POSITION,$aname,ZDB),0)">

    <?MIVAR name=$inputaname>$aname <?/MIVAR>
    <!-- if the accession number specified has contains mgi:, omim: or gdb: , get rid of them -->
    <?MIBLOCK COND="$(>,$(POSITION,$aname,:),0)">
      <?MIVAR NAME=$newaname>$(SUBSTR,$aname,$(+,$(POSITION,$aname,:),1),$(STRLEN,$aname))<?/MIVAR>
      <?MIVAR name=$inputaname>$aname <?/MIVAR>
      <?MIVAR NAME=$aname>$newaname<?/MIVAR>
    <!-- DEBUGGING <?MIVAR> newaname = $newaname <?/MIVAR> -->
    <?/MIBLOCK>


    <!-- look if accession number links to publication -->

    <?MISQL SQL="select count(*)::integer from publication where accession_no = '$aname' and status ='active';"> 
      $(SETVAR,$pcount,$1)
    <?/MISQL>
    <?MIBLOCK COND="$(NC,$pcount,0)">
	<?MIVAR NAME=$start_page>aa-pubselect2.apg<?/MIVAR>	
	<?MIVAR NAME=$pub_acc_constraint> accession_no = '$aname' and status='active' <?/MIVAR> 
        <?MISQL SQL="select WebExplode(object,'') from webPages where ID='$start_page';">$1<?/MISQL>
     <?/MIBLOCK>


   <!-- look if accession number links to any marker, significance 11 and 12 signify orthologue or accession numbers -->
    <?MIVAR NAME=$done_mrkr>f<?/MIVAR>
    <?MIVAR NAME=$done_mseg>f<?/MIVAR>
    <?MIVAR NAME=$input_acc>$aname<?/MIVAR>
    <?MISQL SQL="select distinct allmapnm_zdb_id from all_map_names where allmapnm_name_lower = lower('$aname') and allmapnm_precedence = 'Accession number' order by allmapnm_zdb_id;">
        $(SETVAR,$gcount,1)
        <?MIBLOCK COND="$(AND,$(EC,$done_mseg,f),$(>,$(POSITION,$1,BAC),0))">
	  
          <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-msegselect.apg';">$1<?/MISQL>
	  <?MIVAR NAME=$done_mseg>t<?/MIVAR>
        <?MIELSE COND="$(AND,$(EC,$done_mseg,f),$(>,$(POSITION,$1,EST),0))">
	  <?MIVAR NAME=$todo_mseg>t<?/MIVAR>
        <?MIELSE COND="$(AND,$(EC,$done_mseg,f),$(>,$(POSITION,$1,CDNA),0))">
	  <?MIVAR NAME=$todo_mseg>t<?/MIVAR>
        <?MIELSE COND="$(AND,$(EC,$done_mrkr,f),
			    $(=,$(POSITION,$1,EST),0),		            
			    $(=,$(POSITION,$1,BAC),0),
		   	    $(=,$(POSITION,$1,PAC),0))">
	  
          <?MIBLOCK COND="$(EC,$done_mseg,t)">
            <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-markerselect.apg';">$1<?/MISQL>
	    <?MIVAR NAME=$done_mrkr>t<?/MIVAR>
          <?MIELSE>
		<?MIVAR NAME=$todo_mrkr><?/MIVAR>
	  <?/MIBLOCK> 
        <?MIELSE COND="$(AND,$(EC,$done_mseg,f),$(>,$(POSITION,$1,PAC),0))">
	  
          <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-msegselect.apg';">$1<?/MISQL>
	  <?MIVAR NAME=$done_mseg>t<?/MIVAR>
	<?/MIBLOCK>     

    <?/MISQL>

    <?MIVAR COND="$(XST,$todo_mrkr)">
	<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-markerselect.apg';">$1<?/MISQL>
    <?/MIVAR>
    <?MIVAR COND="$(XST,$todo_mseg)">
	<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-msegselect.apg';">$1<?/MISQL>
    <?/MIVAR>


    <?MIBLOCK COND="$(AND,$(EC,$pcount,0),$(EC,$mcount,0),$(EC,$gcount,0))">
      <form><center><font size=4><?MIVAR><b>Requested acession number is not available in ZFIN.</b></font></center> <?/MIVAR>
      </form>
    <?/MIBLOCK>

  <?/MIBLOCK> <!-- no ZDB in the accession num -->


  <!--  THIS BLOCK HANDLES ZDB ID SEARCHES  -->

  <?MIBLOCK COND="$(>,$(POSITION,$aname,ZDB),0)">
    
     <?MICOMMENT> ** Most of this logic really shouldn't be here, it should be in an SPL function
                     that can be shared in lots of places.  Currently (3/4/09) a method like that
                     exists for marker - so we'll try that method first, and only if it fails
                     will the rest of the logic in this page go forward **   <?/MICOMMENT>

     <?MICOMMENT> ** First, try get_mrkr_url($aname) - then split on the zdb_id if that fails ** <?/MICOMMENT>
     <?MISQL SQL="select get_mrkr_url('$aname') from marker where mrkr_zdb_id = '$aname';">
       <?MIVAR NAME="$full_url">$1<?/MIVAR>
     <?/MISQL>     

     <?MIBLOCK COND="$(XST,$full_url)">
       <?MIVAR>
       <script>
         window.location.replace("$full_url")
       </script>
       <?/MIVAR>
     <?MIELSE> <?MICOMMENT> ** didn't find full url, build one from the zdb_id ** <?/MICOMMENT>


     <?MIVAR NAME=$start_page>NULL<?/MIVAR>
     <!-- if a zdb is passed in,  set second frame to it's viewer with specified zdb_id! -->

      <?MIVAR NAME=$constraint> where zdb_id = '$OID' <?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,LAB),0)">aa-labview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,PERS),0)">aa-persview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,COMPANY),0)">aa-companyview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,PUB),0)">aa-pubview2.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,GENO),0)">aa-genotypeview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,FISH),0)">aa-genotypeview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,REFCROSS),0)">aa-crossview.apg<?/MIVAR>

<?MICOMMENT>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,GENE),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,LOCUS),0)">aa-markerview.apg<?/MIVAR>	
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,SSLP),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,CDNA),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,GENEP),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,MRPHLNO),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,EST),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,BAC),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,PAC),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,CONSTRCT),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,REGION),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,BAC_END),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,PAC_END),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,RAPD),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,STS),0)">aa-markerview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,RFLP),0)">aa-markerview.apg<?/MIVAR>
<?/MICOMMENT>

      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,ANAT),0)">/action/anatomy/term-detail?anatomyItem.zdbID=$OID<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,ALT),0)">/action/feature/detail?feature.zdbID=$OID<?/MIVAR>

      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,IMAGE),0)">aa-imageview.apg<?/MIVAR>
      <?MIVAR NAME=$start_page COND="$(>,$(POSITION,$aname,FIG),0)">aa-fxfigureview.apg<?/MIVAR>



      <?MICOMMENT> there is no longer an expression page, a publication's all figure page is 
          the best place to go right now. For direct submission pub, like Thisse, there isn't 
          a truely all figures page, but all figures page per probe. 
      <?/MICOMMENT>
      <?MIBLOCK COND="$(>,$(POSITION,$aname,XPAT),0)">
        <?MISQL SQL="
		select xpatex_source_zdb_id,jtype, xpatex_probe_feature_zdb_id
                  from expression_experiment
		       join publication on xpatex_source_zdb_id = zdb_id
	         where xpatex_zdb_id = '$aname';">
         <?/MISQL>
    	 <?MIVAR NAME=xpat_pub_id>$1<?/MIVAR>
    	 <?MIVAR NAME=xpat_pub_type>$2<?/MIVAR>
   	 <?MIVAR NAME=xpat_probe_id>$3<?/MIVAR>
   	 <?MIVAR NAME=$conditional_probe><?/MIVAR>
    	 <?MIVAR COND="$(EC,$xpat_pub_type,Unpublished)">
	    $(SETVAR,$conditional_probe,fxallfig_probe_zdb_id=$xpat_probe_id)
    	 <?/MIVAR>
         <?MIVAR NAME=$start_page>aa-fxallfigures.apg&$conditional_probe<?/MIVAR>
         <?MIVAR>$(SETVAR,$OID,$xpat_pub_id)<?/MIVAR>
      <?/MIBLOCK>   

    <?MIBLOCK COND="$(EC,$start_page,NULL)">
      <form><center><font size=4><?MIVAR><b>Requested ID is not available in ZFIN.</b> </font></center><?/MIVAR>
      </form>
      <?/MIBLOCK>
    <?MIBLOCK COND="$(>,$(POSITION,$start_page,action),0)">
    <?MIVAR>
    <script>
      window.location.replace("$start_page")
    </script>
      <?/MIVAR>
    <?/MIBLOCK>
    <?MIBLOCK COND="$(=,$(POSITION,$start_page,action),0)">
    <script>
      <?MIVAR>location.replace("/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=$start_page&OID=$OID")<?/MIVAR>
    </script>
    <?/MIBLOCK>
  <!-- ends if valid start page, not null  -->


  <?/MIBLOCK> <?MICOMMENT> ** ends XST $full_url ** <?/MICOMMENT>

  <?/MIBLOCK>  <!-- ENDS IF SEARCHTYPE ZDB ID -->


<?/MIBLOCK> <!--XST query_results-->



<!------------- search ------------->


    <Table class=search width="100%" border=0 cellpadding=1 cellspacing=0>
      <TR>
	<td class=titlebar>
          &nbsp;&nbsp;

  <?MIBLOCK COND="$(NXST,$query_results)">
	  <b>Search for ACCESSION Number</b>
  <?MIELSE>
          <a name=modify></a><b>Modify your search</b>
  <?/MIBLOCK>

        </td>
        <td class=titlebar align=right>
        <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-input_button_generic.apg';">$1<?/MISQL>          
        </td>
      </tr>

<form name="critform" method="get" action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->" >

  <TR>
   <TD class="fullwidth">
    <?MIVAR>
    <b>Accession Number:</b> <input type=text name=aname size=50 value=$(IF,$(XST,$aname),$aname, )> </font>
    <?/MIVAR>
   </TD>
  </TR>
  <TR> 
   <TD class="submitbar" colspan=2 align="right">
    <input type=submit name=action value="SEARCH">
    <input type=button value="RESET" onClick='document.critform.aname.value = ""'> 
   </TD> 
  </TR>
</TABLE>


<input type=hidden name=MIval value=aa-accessionselect.apg>
<input type=hidden name=query_results value="exists">


<!-- This next little block executes only if we are using the browser as a
selector. That is we want user to ultimately CHOOSE a browsed value. All
we have to do at this point is pass the return record along the appropriate form.
-->
<?MIVAR COND="$(XST,$return_rec)">
<input type=hidden NAME="return_rec" value=$return_rec>
<?/MIVAR>

<?MIVAR COND="$(XST,$query_results)">
    </td>
  </tr>
</table>
<?/MIVAR>

</form>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>






