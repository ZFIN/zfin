<?MICOMMENT>
FILE: IMAGEVIEW.APG. 
PREFIX: fimgview_

INPUT VARS: 
 -- OID -- the OID of the fish image record to view
 -- PDATE -- a flag variable to indicate we're in update mode
 -- temp_oid -- could be passed instead of fimgview_OID --

OUTPUT VARS:
none

OUTPUT

 -- url redirect to mrkr, xpat, pub pages.  these are links that the
 -- user can click from this page to get to others.
 -- if they are logged in, it takes them to pages that allow selection
 -- of ids to add to the image record.

EFFECTS:
This file implements a viewer for IMAGE records. 
The goal is to display all of the information associated with the IMAGE 
record, and to provide an interface for updating certain values
as well.

User can change stage range, and image details (like direction or view)
from this page, all changes go through do-imageupdate.apg and imageupdate.apg


<?/MICOMMENT>

<?MIERROR>
  <?MIVAR COND=$(XST,$MI_SQL)>
    SQL: $MI_SQL<br><br>
  <?/MIVAR>

  Code:    $MI_ERRORCODE <br>
  State:   $MI_ERRORSTATE <br>
  Message: $MI_ERRORMSG <br>
<?/MIERROR>

<HTML>

<head>

<style type="text/css">
        div { font-family: arial }
        .fig { line-height: 1.5; text-align:justify; }
</style>

<META HTTP-EQUIV="EXPIRES" CONTENT="Wed Sep 11 09:35:25 PDT 1996">

<?MIVAR COND="$(AND,$(NXST,$OID),$(XST,$temp_oid))" NAME=$OID>$temp_oid<?/MIVAR>
<?MIVAR COND="$(NXST,$image_table)" NAME=image_table>image<?/MIVAR>

<SCRIPT>

  function doit(attr,attr_type,print_name,table,zdb_id) {
    document.doUpdate.MIval.value='aa-imageupdate.apg';
    document.doUpdate.attr.value=attr;
    document.doUpdate.attr_type.value=attr_type;
    document.doUpdate.print_name.value=print_name;
    document.doUpdate.table.value=table;
    document.doUpdate.zdb_id.value=zdb_id;
    /* check_annotations(); */
    document.doUpdate.submit();
  }


  // Comment out call to annotator applet until it's installed!
  // Basically disables this function.
  /*
  function check_annotations(old_annotations) {
    var new_annotations=document.annotator.getAnnotations();
    if (old_annotations!=new_annotations) {
      document.doUpdate.annotations.value=new_annotations;
    }
  }
  */

  function dopopup(new_value,old_value,field,table,zdb_id) {
    document.doUpdate.MIval.value='aa-do-imageupdate.apg';
    document.doUpdate.attr.value=field;
    document.doUpdate.attr_type.value='text';
    document.doUpdate.old_value.value=old_value;
    document.doUpdate.new_value.value=new_value;
    document.doUpdate.table.value=table;
    document.doUpdate.zdb_id.value=zdb_id;
    /* check_annotations(); */
    document.doUpdate.submit();
  }

  function all_done() {
    document.doUpdate.MIval.value='aa-do-imageupdate.apg';
    document.doUpdate.attr.value='dummy';
    document.doUpdate.attr_type.value='special-done';
    /* check_annotations(); */
    document.doUpdate.submit();
  }


<?MIVAR>
  <?MIVAR NAME=$fimgview_window_name DELIMIT="-" REPLACE="d">$OID<?/MIVAR>
  function popup_image(url) {
    open(url,"$fimgview_window_name","toolbar=yes,scrollbars=yes,resizable=yes");
  }
<?/MIVAR>

</SCRIPT>

</HEAD>

<?MIVAR name=$fimgview_highlight><!--|HIGHLIGHT_COLOR|--><?/MIVAR>

<?MIBLOCK COND="$(NXST,$fimgview_accession)">
  <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>
<?/MIBLOCK>

<?MISQL SQL="select img_fig_zdb_id from image where img_zdb_id='$OID'"><?/MISQL>
<?MIVAR NAME=fig_zdb_id>$1<?/MIVAR>

<?MISQL SQL="select pub_mini_ref, fig_label , pub_doi from publication, figure where fig_zdb_id='$fig_zdb_id' and fig_source_zdb_id=zdb_id ">
<?/MISQL>
<?MIBLOCK COND="$(>,$MI_ROWCOUNT,0)">
  <?MIVAR NAME=$fimgview_miniref>$1<?/MIVAR>
  <?MIVAR NAME=$fimgview_label>$2<?/MIVAR>
<?/MIBLOCK>

<?MISQL SQL="
  select img_image, img_annotation, img_image_with_annotation, 
	 img_width, 
	 HTML_breaks(img_comments), img_view, img_direction, 
	 img_form, img_preparation, 
	 img_thumbnail, img_fig_zdb_id, img_is_video_still
    from $image_table 
    where img_zdb_id='$OID';">
<?/MISQL>

<?MIVAR NAME=$fimgview_fimg_image>$1<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_annotation>$2<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_image_with_annotation>$3<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_width>$4<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_comments>$5<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_view>$6<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_direction>$7<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_form>$8<?/MIVAR>
<?MIVAR NAME=$fimgview_fimg_preparation>$9<?/MIVAR>
<?MIVAR NAME=$fimgview_thumbnail>$10<?/MIVAR>
<?MIVAR NAME=$fimgview_fig_image_zdb_id>$11<?/MIVAR>
<?MIVAR NAME=$fimgview_img_is_video_still>$12<?/MIVAR>
<?MIVAR NAME=$fimgview_image_zdb_id>$OID<?/MIVAR>
<?MICOMMENT>
  for the purpose of having consistant parameter names when pass to showpub.apg
<?/MICOMMENT>
<?MIVAR NAME=$fimgview_title>Stock<?/MIVAR>
<?MIVAR NAME=$fimgview_abbrev><?/MIVAR>
<?MIVAR NAME=$puback><?/MIVAR>


<?MIBLOCK COND="$(=,$MI_ROWCOUNT,0)">
    
  <?MICOMMENT> look to see if replaced zdb_id <?/MICOMMENT>

  <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-zdb_history.apg';">$1<?/MISQL>
    
  <?MIBLOCK COND="$(NXST,$new_oid)">
    <form><center><font size=+2>
      <b>Requested ID not found on ZFIN.</b>
    </form>
  <?/MIBLOCK>

<?MIELSE>
<?MIBLOCK COND="$(XST,$fimgview_miniref)">
 <?MIVAR NAME=$fimgview_miniref>$(REPLACE,$fimgview_miniref,"<i>","")<?/MIVAR>
 <?MIVAR NAME=$fimgview_miniref>$(REPLACE,$fimgview_miniref,"</i>","")<?/MIVAR>
  <?MIVAR><TITLE> ZFIN : $fimgview_miniref $fimgview_label  Image View </TITLE><?/MIVAR>
<?MIELSE>
  <?MIVAR><TITLE> ZFIN : View Image </TITLE><?/MIVAR>
<?/MIBLOCK>
  <?MICOMMENT> tried MIBLOCK with COND here.  Didn't work.  <?/MICOMMENT>

  <?MIVAR NAME=$fimgview_imageToShow>$(IF,$(EQ,$fimgview_fimg_image_with_annotation,"NULL"),$fimgview_fimg_image,$fimgview_fimg_image_with_annotation)<?/MIVAR>

  <?MIBLOCK COND="$(NXST,$OID)">
    <p>
    ERROR -- something bad happened -- no OID passed in!

  <?MIELSE>

    <?MICOMMENT> if not updating <?/MICOMMENT>
    <?MIBLOCK COND="$(NXST,$UPDATE)">
      <?MISQL SQL="
	select WebExplode(object, 'page_title=View Image') 
	  from webPages 
	  where ID='aa-secure_navigation.apg';">
	$1
      <?/MISQL>
    <?MIELSE>  <?MICOMMENT> If updating, only let owner update anything <?/MICOMMENT>
      <?MISQL SQL="
	select WebExplode(object, 
			  'page_title=Update Image&permission=owns&rtype=image')
	  from webPages 
	  where ID='aa-secure_navigation.apg';">
	$1
      <?/MISQL>
    <?/MIBLOCK>

    <?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

      <?MICOMMENT>
        -- if you're updating, set up some hidden submission forms to handle 
	-- updating. They are submitted from javascript functions.  Need 
	-- this because we need to use POST to send arbitrarily large 
	-- annotations.
      <?/MICOMMENT>
      <?MIVAR COND="$(XST,$UPDATE)">
	<form name=doUpdate 
	      method=post 
	      action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->">
	  <input type=hidden name=MIval value="">
	  <input type=hidden name=OID value="$OID">
	  <input type=hidden name=attr value="">
	  <input type=hidden name=attr_type value="">
	  <input type=hidden name=old_value value="">
	  <input type=hidden name=table value="">
	  <input type=hidden name=zdb_id value="">
	  <input type=hidden name=new_value value="">
	  <input type=hidden name=print_name value="">
	  <input type=hidden name=annotations value="NULL">
	  <input type=hidden name=redirect_url value=/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval="aa-imageview.apg">


	</form>
      <?/MIVAR>

      <?MIVAR NAME=$fimgview_rec_title>IMAGE<?/MIVAR>

      <?MICOMMENT>
        If not updating, THROW UP THE ZDB DATA MANAGER FOR THE RECORD 
      <?/MICOMMENT>
      <?MISQL COND="$(NXST,$UPDATE)" SQL="
	select WebExplode(object, 'rtype=image') 
	  from webPages 
	  where ID='aa-data_mgr.apg';">
	$1
      <?/MISQL>


      <?MICOMMENT> OKAY, NOW  THROW UP THE  IMAGE INFO <?/MICOMMENT>
      <P>

      <form name=updater>
	<?MIVAR COND="$(XST,$UPDATE)">
	  <center>
       <a 
       style="font-size: large;"
       href="javascript:" 
       onClick="all_done();"
       >[View Image]</a>
	  </center>
	<?/MIVAR>



	<A NAME="image_info">


        <?MICOMMENT>
              *****************
              *  Figure Data  *
              *****************
        <?/MICOMMENT>	
        
        <?MICOMMENT> Calculate the figure info here so the All figures link can be 
        displayed below the image.
        <?/MICOMMENT>
         
        <?MIVAR NAME=imgv_all_figure_link><?/MIVAR> 
        <?MIVAR NAME=imgv_figure_display><?/MIVAR>
         
        <?MIBLOCK COND=$(NXST,$UPDATE)>
          

          <?MICOMMENT> ******* Get the figure info *******<?/MICOMMENT>	        
          <?MISQL SQL="
            select distinct img_fig_zdb_id, fig_source_zdb_id, pub_mini_ref, jtype
              from image, figure, publication
             where img_zdb_id = '$OID'
               and img_fig_zdb_id = fig_zdb_id
               and fig_source_zdb_id = zdb_id;">
             
             <?MIVAR NAME=fimgview_fig_zdb_id>$1<?/MIVAR>
             <?MIVAR NAME=fimgview_fig_source_zdb_id>$2<?/MIVAR>
             <?MIVAR NAME=fimgview_pub_mini_ref>$3<?/MIVAR>
             <?MIVAR NAME=fimgview_pub_jtype>$4<?/MIVAR>
             
          <?/MISQL>
       
          <?MIBLOCK COND=$(XST,$fimgview_fig_zdb_id)>

            <?MICOMMENT>
              Check for Expression data and Phenotype data. Display links appropriately.
            <?/MICOMMENT>
            
            <?MISQL SQL="
                select *
                  from expression_pattern_figure
                 where xpatfig_fig_zdb_id = '$fimgview_fig_zdb_id';">
                 
                 <?MIVAR NAME=fimgview_expression_exists>true<?/MIVAR>
            <?/MISQL>

            <?MISQL SQL="
                select *
                  from phenotype_experiment
                 where phenox_fig_zdb_id = '$fimgview_fig_zdb_id';">
                 
                 <?MIVAR NAME=fimgview_phenotype_exists>true<?/MIVAR>
            <?/MISQL>            
            <?MISQL SQL="
                select *
                  from construct_figure
                 where consfig_fig_zdb_id = '$fimgview_fig_zdb_id';">
                 
                 <?MIVAR NAME=fimgview_construct_exists>true<?/MIVAR>
            <?/MISQL>            

           <?MISQL SQL="select *
              from expression_pattern_figure, expression_result, expression_experiment
              where xpatfig_fig_zdb_id='$fimgview_fig_zdb_id'
              and xpatres_zdb_id=xpatfig_xpatres_zdb_id
              and xpatres_xpatex_zdb_id=xpatex_zdb_id
              and xpatex_gene_zdb_id is null
              and xpatex_atb_zdb_id is not null">
                 <?MIVAR NAME=fimgview_labeling_exists>true<?/MIVAR>
            <?/MISQL>


        <?MICOMMENT> ***** If the Pub is unpublished, the figures page needs the probe ***** <?/MICOMMENT>	          
          <?MIBLOCK COND=$(NC,$fimgview_pub_jtype,Curation)>
            <?MISQL SQL="
               select xpatex_probe_feature_zdb_id, mrkr_abbrev
               from 
               figure, marker, publication,
               expression_pattern_figure, expression_result, 
               expression_experiment
               where
               fig_zdb_id = '$fimgview_fig_zdb_id'
               and fig_source_zdb_id = zdb_id
               and jtype = 'Unpublished'
               and xpatfig_fig_zdb_id = fig_zdb_id
               and xpatfig_xpatres_zdb_id = xpatres_zdb_id
               and xpatres_xpatex_zdb_id = xpatex_zdb_id
               and xpatex_probe_feature_zdb_id = mrkr_zdb_id;">
               
                <?MIVAR NAME=fimgview_probe_zdb_id>$1<?/MIVAR>
                <?MIVAR NAME=fimgview_probe_name>$2<?/MIVAR>
            <?/MISQL>      

            <?MICOMMENT> ***** Pass probe id to Additional Figures link if exists ***** <?/MICOMMENT>

            <?MIBLOCK COND="$(XST,$fimgview_probe_zdb_id)">
              <?MIVAR NAME=imgv_all_figure_link> 
                <a href="/action/figure/all-figure-view/$fimgview_fig_source_zdb_id?probeZdbID=$fimgview_probe_zdb_id">Figures for <?MIVAR>$fimgview_pub_mini_ref<?/MIVAR> <?MIVAR>[$fimgview_probe_name]<?/MIVAR></a>
              <?/MIVAR>
            <?MIELSE>      
              <?MIVAR NAME=imgv_all_figure_link> 
                <a href="/action/figure/all-figure-view/$fimgview_fig_source_zdb_id">All Figures for <?MIVAR>$fimgview_pub_mini_ref<?/MIVAR></a>
              <?/MIVAR>
            <?/MIBLOCK> 
          <?/MIBLOCK>

            <?MIVAR NAME=imgv_figure_display> 
            <p>
  	    <TABLE width=100% cellspacing=0>
	      <TR bgcolor="<!--|SIDEBAR_COLOR|-->">
	        <TD>
	          <b>Figure data:</b>
	        </td>
	      </tr>
	      <tr bgcolor="<!--|HIGHLIGHT_COLOR|-->">
	        <td>

            <?/MIVAR> 


            <?MIBLOCK COND="$(XST,$fimgview_expression_exists)">
              <?MIVAR NAME=imgv_figure_display>$imgv_figure_display
              <a href="/$fimgview_fig_zdb_id#xpat">Gene expression data</a>
              <br>          
              <?/MIVAR>
            <?/MIBLOCK>
            
            <?MIBLOCK COND="$(XST,$fimgview_phenotype_exists)">
              <?MIVAR NAME=imgv_figure_display>$imgv_figure_display
              <a href="/$fimgview_fig_zdb_id#phenotype">Phenotype data</a>
              <br>          
              <?/MIVAR>
            <?/MIBLOCK>

            <?MIVAR NAME=imgv_figure_display>$imgv_figure_display

                </td>
              </tr>
            </table>
            <?/MIVAR>
           
          <?/MIBLOCK> <?MICOMMENT> xst figure <?/MICOMMENT>
          
        <?/MIBLOCK> <?MICOMMENT> nxst UPDATE <?/MICOMMENT>


<?MIVAR>$imgv_all_figure_link<?/MIVAR>

<p>
<?MISQL SQL="select WebExplode(object,'OID=$fimgview_fig_image_zdb_id') from webPages where ID='aa-fxfiggenelist.apg';">$1<?/MISQL>
        <?MIVAR COND="$(XST,$UPDATE)">
	  <p>
                <?MIBLOCK COND=$(XST,$UPDATE)>
         	  <INPUT TYPE=button value=Update onClick="doit('stock','selection','Depicted+Stock','image','img_zdb_id')">
	        <?/MIBLOCK>
 
	<?/MIVAR>
	 

	<?MIBLOCK COND="$(NC,$fimgview_fimg_form,movie)">

	  <center>
	  <TABLE border=0 cellpadding=20>
	    <TR>
	      <TD align=center bgcolor=#000000>


		<?MIVAR> 
		  <script>
		    var frameWidth;
		    if (navigator.appName == "Microsoft Internet Explorer") {
		      frameWidth = parent.document.body.clientWidth - 60;
		    }
		    else {
		      frameWidth = parent.innerWidth - 80;
		    }

		    if (($fimgview_fimg_width > frameWidth)||$fimgview_fimg_width==0) {   
		      document.write(
			  '<IMG width="' + frameWidth + '"' +
			  '  SRC="<!--|IMAGE_LOAD|-->/$fimgview_imageToShow">' +
			  '<br>'); 
		      document.write(
			  '<INPUT TYPE=button ' +
			  '  value="View image at high resolution"' +
			  '  onClick="popup_image(' + "'<!--|IMAGE_LOAD|-->/$fimgview_imageToShow'" + ')">');
		    } 
		    else {
		      document.write('<IMG SRC="<!--|IMAGE_LOAD|-->/$fimgview_imageToShow">');
		    }
		  </script>
		<?/MIVAR>
		<?MIVAR COND="$(XST,$UPDATE)">
		  <br>
		  <INPUT TYPE=button 
			 value="Change Image file" 
			 onClick="doit('img_image','pic','Image+file','image','img_zdb_id')">
		<?/MIVAR>
	      </TD>
	    </TR>
	  </TABLE>
	  </center>
	<?/MIBLOCK>


<?MIVAR NAME=$OID>$fimgview_image_zdb_id<?/MIVAR>
        <?MICOMMENT>
              ******************
              * Figure Caption *
              ******************
        <?/MICOMMENT>


          <?MICOMMENT> 
              *** This image may be one of many images for a figure. 	
              *** Add the text "<b>One of multiple images for</b>" when 
              *** multiple images exist.
          <?/MICOMMENT>	        
          <?MISQL SQL="
            select fig_caption, fig_zdb_id, fig_label, img_label
              from figure, image
             where img_zdb_id = '$OID'
               and img_fig_zdb_id = fig_zdb_id;">

            <?MIVAR NAME=$fimgview_fig_caption>$1<?/MIVAR>
            <?MIVAR NAME=$fimgview_fig_zdb_id>$2<?/MIVAR>
            <?MIVAR NAME=$fimgview_fig_label>$3<?/MIVAR>
            <?MIVAR NAME=$fimgview_img_label>$4<?/MIVAR>
            <?MISQL SQL="
                select count(*)::integer
                  from image 
                 where img_fig_zdb_id = '$fimgview_fig_zdb_id';">
	     
               <?MIVAR NAME=fig_count>$1<?/MIVAR>
            <?/MISQL>
	            
            <?MIVAR NAME=$fimgview_caption_display COND=$(AND,$(NC,$fimgview_fig_caption,),$(NC,$fimgview_fig_caption,NULL))>
              <div class="fig">
                $(IF,$(NC,$fig_count,1),<b>One of multiple images for</b>)
           
                <b>$fimgview_fig_label</b> $fimgview_fig_caption
              </div>
            <?/MIVAR>

          <?/MISQL> <?MICOMMENT> end of expression pattern query <?/MICOMMENT>
          

        		
	<?MIBLOCK COND=$(OR,$(XST,$UPDATE),$(AND,$(NXST,$fimgview_caption_display),$(NC,$fimgview_fimg_comments,NULL)))>
	  <?MIVAR NAME=$fimgview_caption_display>$fimgview_fimg_comments<?/MIVAR>
	<?/MIBLOCK>
		
	<?MIVAR COND=$(XST,$UPDATE)>
          <?MIVAR NAME=$fimgview_caption_display>
            <textarea name=caption cols=85 rows=5>$fimgview_caption_display</textarea>
            <br>
            <input type=button value="submit" onClick="dopopup(document.updater.caption.value,'$fimgview_caption_display','img_comments','image','img_zdb_id');">
            <?MICOMMENT> ** Show the fig caption in an uneditable way, since a curator might 
                            want that information while they're editing other info ** <?/MICOMMENT>
            <?MIBLOCK COND="$(XST,$fimgview_fig_caption)">
              <?MIVAR> <div><b>$fimgview_fig_label</b> $fimgview_fig_caption</div> <?/MIVAR>
            <?/MIBLOCK>
          <?/MIVAR>
        <?/MIVAR>
          
        <?MIBLOCK COND=$(XST,$fimgview_caption_display)>
	  <p> 


	  <TABLE width=100% cellspacing=0 cellpadding=5>
	    <TR bgcolor="<!--|SIDEBAR_COLOR|-->">
	      <TD>
	        <B>Caption/Comments:</b>		    
	      </TD>
	    </TR>			
	  </TABLE>
	  <TABLE width=100% cellspacing=0 cellpadding=10>
	    <tr bgcolor="<!--|HIGHLIGHT_COLOR|-->">
	      <td>
	        <?MIVAR>$fimgview_caption_display<?/MIVAR>
	      </td>
	    </tr>		
	  </TABLE>

	  
	<?/MIBLOCK>
	

	  

        <?MICOMMENT>
              *****************
              *  Figure Data  *
              *****************
        <?/MICOMMENT>	

        <?MIVAR>$imgv_figure_display<?/MIVAR>


	
	  

        <?MICOMMENT>
              ***************
              * Dev. Stages *
              ***************
        <?/MICOMMENT>



	<?MISQL SQL="
	  select lo.stg_zdb_id,       	     hi.stg_zdb_id, 
		 lo.stg_name,        	     hi.stg_name, 
		 lo.stg_hours_start, 	     hi.stg_hours_end,
		 get_stg_name_html(lo.stg_zdb_id, 'long'),
		 get_stg_name_html(hi.stg_zdb_id, 'long')
	    from image_stage, stage lo, stage hi
	    where imgstg_img_zdb_id = '$OID'
	      and lo.stg_zdb_id = imgstg_start_stg_zdb_id
	      and hi.stg_zdb_id = imgstg_end_stg_zdb_id
	    order by lo.stg_hours_start, hi.stg_hours_end desc;">

	  <?MIVAR NAME=$fimgview_start_stg_zdb_id>$1<?/MIVAR>
	  <?MIVAR NAME=$fimgview_end_stg_zdb_id>$2<?/MIVAR>
	  <?MIVAR NAME=$fimgview_start_stg_name>$3<?/MIVAR>
	  <?MIVAR NAME=$fimgview_end_stg_name>$4<?/MIVAR>
	  <?MIVAR NAME=$fimgview_start_stg_name_long_html>$7<?/MIVAR>
	  <?MIVAR NAME=$fimgview_end_stg_name_long_html>$8<?/MIVAR>
        <?/MISQL> 

        <?MICOMMENT> ** Display stage info, or if in update mode, show the edit widget ** <?/MICOMMENT>
        <?MIBLOCK COND="$(OR,$(XST,$fimgview_start_stg_zdb_id),$(XST,$UPDATE))">
	  <p>
	  <table width=100% cellspacing=0>
	    <tr bgcolor="<!--|SIDEBAR_COLOR|-->">
	      <td>
                <b>Developmental Stage(s):</B>
              </td>
            </tr>
            <tr bgcolor="<!--|HIGHLIGHT_COLOR|-->">
              <td>

	  <?MIBLOCK COND="$(NXST,$UPDATE)">
	    <?MIVAR>
	      $fimgview_start_stg_name_long_html
	    <?/MIVAR>
	    <?MIVAR COND=$(NE,$fimgview_start_stg_name,$fimgview_end_stg_name)>
	      to $fimgview_end_stg_name_long_html
	    <?/MIVAR>
	  <?MIELSE>
              <div id="imageStageBox"></div>

	  <?/MIBLOCK>

              </td>
            </tr>
          </table>
        <?/MIBLOCK>
        <?MICOMMENT> end developmental stages SQL <?/MICOMMENT>

        <?MICOMMENT>
              ***********
              * Anatomy *
              ***********
        <?/MICOMMENT>         

        <?MIBLOCK COND="$(XST,$UPDATE)">
        <br>
        
        <table class="summary">
          <tr>
             <th>Anatomy</th>
          </tr>
          <tr>
            <td>
              <?MICOMMENT> for some reason, putting this input here means that the
                           LookupComposite won't automatically submit.
              <?/MICOMMENT>
              <div style="display: none;"><input type="text" name="magicvoodoo"></div>
              <script type="text/javascript">
                var MarkerProperties= { zdbID : "<?MIVAR>$OID<?/MIVAR>",
                                        imageEditDiv: "imageTermBox",
                                        imageStageEditDiv: "imageStageBox",
                                        imageConstructEditDiv: "imageConstructBox"} ;
              </script>
              <link rel="stylesheet" type="text/css" href="/css/Marker.css"/>
              <script language="javascript"
                     src="/gwt/org.zfin.gwt.marker.Marker/org.zfin.gwt.marker.Marker.nocache.js"></script>
              <div id="imageTermBox"></div>
            </td>
          </tr>
        </table>

        <?MIELSE>
          <?MIVAR NAME="$fimgview_term_links"><?/MIVAR>
          <?MISQL SQL="select get_entity_name_html(term_zdb_id), lower(term_name) as term_name_order
                     from int_image_term, term
                     where iit_img_zdb_id = '$OID'
                       and iit_term_zdb_id = term_zdb_id
                     order by term_name_order;">
            <?MIBLOCK COND="$(NE,$fimgview_term_links,)">
              <?MIVAR NAME="$fimgview_term_links">$fimgview_term_links, $1<?/MIVAR>
            <?MIELSE>
              <?MIVAR NAME="$fimgview_term_links">$1<?/MIVAR>
            <?/MIBLOCK>
          <?/MISQL>

          <?MIBLOCK COND="$(NE,$fimgview_term_links,)">
              <br> 
                <table class="summary">
                <tr> <th> Anatomy </th> </tr>
                <tr> <td>
                   <?MIVAR>$fimgview_term_links<?/MIVAR>
                </td> </tr> </table>
          <?/MIBLOCK>


        <?/MIBLOCK>

        <?MICOMMENT>
              **************
              * Constructs *
              **************
        <?/MICOMMENT>

        <?MIVAR NAME="construct_table_pre">
            <br>
            <table class="summary">
              <tr>
                 <th>Constructs</th>
              </tr>
              <tr>
                <td>
        <?/MIVAR>
        <?MIVAR NAME="construct_table_post">
                </td>
              </tr>
            </table>
        <?/MIVAR>

        <?MIBLOCK COND="$(XST,$UPDATE)">
            <?MIVAR>$construct_table_pre<?/MIVAR>
            <div id="imageConstructBox"></div>
            <?MIVAR>$construct_table_post<?/MIVAR>
        <?MIELSE>
            <?MIBLOCK COND="$(XST,$fimgview_construct_exists)">
                <?MIVAR>$construct_table_pre<?/MIVAR>
                <?MISQL SQL="select consfig_construct_zdb_id, mrkr_abbrev from construct_figure, marker where consfig_fig_zdb_id='$fimgview_fig_zdb_id' and consfig_construct_zdb_id=mrkr_zdb_id">
                    <?MIVAR><a href="/$1"><i>$2</i></a><?/MIVAR>
                    <br>
                <?/MISQL>
                <?MIVAR>$construct_table_post<?/MIVAR>
            <?/MIBLOCK>
        <?/MIBLOCK>


        <?MICOMMENT>
              ***************
              * Preparation *
              ***************
        <?/MICOMMENT>

        <?MIVAR NAME=fimgview_notspecified>not specified<?/MIVAR>
        <?MIBLOCK COND=$(OR,$(XST,$UPDATE),$(NC,$fimgview_fimg_preparation,$fimgview_notspecified))>
        <p>

	<TABLE border=0 WIDTH=100% cellpadding=4 cellspacing=0>
	  <tr bgcolor="<!--|SIDEBAR_COLOR|-->">
  	    <td><b>Preparation</b></td>
	    <td><b>Image Form</b></td>
	    <td><b>View</b></td>
	    <td><b>Direction</b></td>
	  </tr>
	  <TR bgcolor="<!--|HIGHLIGHT_COLOR|-->">
	    <TD>
	      <?MIBLOCK COND=$(XST,$UPDATE)>
		<?MIVAR>
		  <SELECT name=preparation onChange="dopopup(this.options[this.selectedIndex].value,'$fimgview_fimg_preparation','img_preparation','image','img_zdb_id')">
		    <?MISQL SQL="
		      select imgprep_name
			from image_preparation
			order by imgprep_name;">
		      <option $(IF,$(EC,$fimgview_fimg_preparation,$1),SELECTED) value="$1">$1
		    <?/MISQL>
		  </SELECT>
		<?/MIVAR>
              <?MIELSE>
                <?MIVAR>$fimgview_fimg_preparation<?/MIVAR>
              <?/MIBLOCK>
	    </TD>
	    <TD> 
	      <?MIBLOCK COND=$(XST,$UPDATE)>
		<?MIVAR>
		  <SELECT name=form onChange="dopopup(this.options[this.selectedIndex].value,'$fimgview_fimg_form','img_form','image','img_zdb_id')">
		    <?MISQL SQL="
		      select imgform_name
			from image_form
			order by imgform_name;">
		      <option $(IF,$(EC,$fimgview_fimg_form,$1),SELECTED) value="$1">$1
		    <?/MISQL>
		  </SELECT>
		<?/MIVAR>
              <?MIELSE>
                <?MIVAR>$fimgview_fimg_form<?/MIVAR>
              <?/MIBLOCK>
	    </TD>
	    <TD> 
	      <?MIBLOCK COND=$(XST,$UPDATE)>
		<?MIVAR>
		  <SELECT name=view onChange="dopopup(this.options[this.selectedIndex].value,'$fimgview_fimg_view','img_view','image','img_zdb_id')">
		    <?MISQL SQL="
		      select imgview_name
			from image_view
			order by imgview_name;">
		      <option $(IF,$(EC,$fimgview_fimg_view,$1),SELECTED) value="$1">$1
		    <?/MISQL>
		  </SELECT>
		<?/MIVAR>
              <?MIELSE>
                <?MIVAR>$fimgview_fimg_view<?/MIVAR>
              <?/MIBLOCK>
	    </TD>
	    <TD> 
	      <?MIBLOCK COND=$(XST,$UPDATE)>
		<?MIVAR>
		  <SELECT name=direction onChange="dopopup(this.options[this.selectedIndex].value,'$fimgview_fimg_direction','img_direction','image','img_zdb_id')">
		    <?MISQL SQL="
		      select imgdir_name
			from image_direction
			order by imgdir_name;">
		      <option $(IF,$(EC,$fimgview_fimg_direction,$1),SELECTED) value="$1">$1
		    <?/MISQL>
		  </SELECT>
		<?/MIVAR>
              <?MIELSE>
                <?MIVAR>$fimgview_fimg_direction<?/MIVAR>
              <?/MIBLOCK>
	    </TD>
	  </TR>
	</TABLE>
	<?/MIBLOCK> <?MICOMMENT> preparation section <?/MICOMMENT>
	
        <?MIBLOCK COND=$(NXST,$UPDATE)>	
  	  <p>
	
	  <?MIVAR NAME=fimgview_pub_zdb_id><?/MIVAR>
	  <?MISQL SQL="
	    select fig_source_zdb_id
	    from figure, image
	    where img_zdb_id = '$OID'
	      and img_fig_zdb_id = fig_zdb_id;">
	      
	    <?MIVAR NAME=fimgview_pub_zdb_id>$1<?/MIVAR>
	  <?/MISQL>
       
        <?MISQL SQL="select  pub_doi, jrnl_abbrev from publication, figure, journal where fig_zdb_id='$fig_zdb_id' and fig_source_zdb_id=zdb_id and pub_jrnl_zdb_id=jrnl_zdb_id">
        <?/MISQL>
        <?MIBLOCK COND="$(>,$MI_ROWCOUNT,0)">
          <?MIVAR NAME=pubview2_doi_no>$1<?/MIVAR>
          <?MIVAR NAME=pubview2_jrnl_abbrev>$2<?/MIVAR>
        <?/MIBLOCK>


          <?MISQL SQL="select WebExplode(object,'pubackn_pub_zdb_id=$fimgview_pub_zdb_id') from webPages where ID='aa-pubacknowledgement.apg';">$1<?/MISQL>

        <?MISQL SQL="select pub_acknowledgment from publication,figure where fig_zdb_id='$fig_zdb_id' and fig_source_zdb_id=zdb_id">
        <?MIVAR NAME=$puback>$1<?/MIVAR>
        <?/MISQL>
        <?MIBLOCK COND="$(NE,$puback,)">
<a name="acknowledgment">
   
        <table border=0 width=100% cellspacing=0>
          <tr bgcolor="<!--|SIDEBAR_COLOR|-->">
            <td>
              <b>Acknowledgments:</b>
            </td>
          </tr>
          <tr bgcolor="<!--|HIGHLIGHT_COLOR|-->">
            <td><?MIVAR>$1<?/MIVAR>
</table>
      <?/MIBLOCK>


        <?/MIBLOCK>
	

    <?MICOMMENT> *** Citation Link *** <?/MICOMMENT>
    <?MISQL SQL="select WebExplode(object,'citlink_data_page=citgeneric.apg') from webPages where ID='aa-citlink.apg';">$1<?/MISQL>


	<?MICOMMENT> 
          Throw up the publication info, using the standard display format 
        <?/MICOMMENT>


      </form>
    <?/MIBLOCK>  <?MICOMMENT> ends cond AUTHORIZED <?/MICOMMENT>
<?/MIBLOCK>
<?/MIBLOCK>  <?MICOMMENT> ends cond OID exist <?/MICOMMENT>

<?MIBLOCK COND="$(NXST,$fimgview_accession)">
  <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>
<?/MIBLOCK>
