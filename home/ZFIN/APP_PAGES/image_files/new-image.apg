<HTML>

<HEAD>
<META HTTP-EQUIV="EXPIRES" CONTENT="Wed Sep 11 09:35:25 PDT 1996">
<TITLE>ZFIN Add a new IMAGE</TITLE>

<!-- 
Creates a record in fish_image that has vaild values in the image
and thumbnail fields, and default values in the other fields.  
It then launches imageview.apg so the user can update the other
columns

You MUST pass in $upload_image, which should be a local filename resulting 
from a FILE UPLOAD file picker. You may optionally pass is 'stock', to 
present the stock of the image.
-->

</HEAD>


<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-secure_navigation.apg';">
  $1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MISQL SQL="
    execute function get_id('IMAGE');">
  <?/MISQL>
  <?MIVAR NAME=$OID>$1<?/MIVAR>

  <!-- create a thumbnail for the new image with a sysexec call.
    -- That way we will have a thumbnail image to upload 
    -- along with the original in the following step. -->
  <?MIVAR NAME=$mythumb>/tmp/$OID.gif<?/MIVAR>
  <?MISQL SQL="
    execute function syscall('make_thumbnail', '$upload_image $mythumb');">
  <?/MISQL>

  <!-- Get width and height of image -->
  <?MISQL SQL="
    execute function get_image_stats('$upload_image');">
    <?MIVAR NAME=$fimg_width>$1<?/MIVAR>
    <?MIVAR NAME=$fimg_height>$2<?/MIVAR>
  <?/MISQL>

  <?MIVAR NAME=$comments>OPTICS:
MAGNIFICATION:
DATE OF IMAGE:
SUBMITTER COMMENTS:
  <?/MIVAR>

  <?MISQL SQL="
    insert into zdb_active_data 
        (zactvd_zdb_id)
      values
        ('$OID');">
  <?/MISQL>
  <?MISQL SQL="
    insert into fish_image
        (fimg_zdb_id, fimg_image, fimg_annotation, fimg_image_with_annotation,
	 fimg_thumbnail, fimg_width, fimg_height,
	 fimg_fish_zdb_id, fimg_comments, 
	 fimg_view, fimg_direction, fimg_form, fimg_preparation, 
	 fimg_owner_zdb_id, fimg_external_name)
      values 
	('$OID', FILETOBLOB('$upload_image', 'client'), NULL, NULL,
	 FILETOBLOB('$mythumb', 'server'), $fimg_width, $fimg_height,
	 NULL, '$comments',
	 'not specified', 'not specified', 'still', 'not specified', 
	 '$ZDB_ident', NULL);">
  <?/MISQL>

  <?MISQL SQL="
    select stg_zdb_id
      from stage
        where stg_name = 'Any stage';">
  <?/MISQL>

  <?MIVAR NAME=$stage_zdb_id>$1<?/MIVAR>

  <?MISQL SQL="
    insert into fish_image_stage
        (fimgstg_fimg_zdb_id, fimgstg_start_stg_zdb_id, fimgstg_end_stg_zdb_id )
      values 
	('$OID','$stage_zdb_id','$stage_zdb_id');">
  <?/MISQL>


  <?MISQL SQL="
    execute function syscall('rm','$mythumb');">
  <?/MISQL>
  
  <SCRIPT>
    <?MIVAR>
      window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-imageview.apg&UPDATE=1&OID=$OID');
    <?/MIVAR>
  </SCRIPT>

<?/MIBLOCK>  <!-- ends cond authorize -->

</HTML>
