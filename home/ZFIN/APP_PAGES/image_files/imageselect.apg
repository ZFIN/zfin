

<HTML>

<HEAD>
<?MIVAR>
  <title>$(IF,$(XST,$query_results),ZFIN Image Search Results,ZFIN Search Images)
  </title>
<?/MIVAR>

<SCRIPT>

  function form_submit() {
    document.getcrits.submit();
  }

  function call_reset() {
    document.getcrits.stock.value = "";
    document.getcrits.comments.value ="";
    document.getcrits.preparation.selectedIndex=0;  
  }

  function popup_url(url) {
    open(url,"Description","toolbar=yes,scrollbars=yes,resizable=yes");
  }

</SCRIPT>

</HEAD>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>





<?MIBLOCK COND="$(XST,$query_results)">

<?MIVAR NAME=$constraint><?/MIVAR>

<!-- First look at standard constraints -->

<?MIBLOCK COND="$(XST,$comments)">
  <?MIVAR NAME=$constraint>
    $(IF,$(NE,$constraint,""),and) 
    (lower(fimg_comments) like '%$(LOWER,$comments)%')
  <?/MIVAR>
<?/MIBLOCK>

<?MIBLOCK COND=$(XST,$preparation)>
  <?MIBLOCK COND=$(NE,$preparation,ANY)>
    <?MIVAR NAME=$constraint>$constraint
      $(IF,$(NE,$constraint,""),and) 
      (fimg_preparation = '$preparation')
    <?/MIVAR>
  <?/MIBLOCK>
<?/MIBLOCK>

<?MIBLOCK COND="$(XST,$stock)">
  <!-- First filter name for apostrophes! -->
  <?MIVAR COND="$(XST,$stock)" NAME=$stock DELIMIT="'" REPLACE="''">$stock<?/MIVAR>
  <?MIVAR NAME=$constraint>$constraint 
    $(IF,$(NE,$constraint,""),and) 
    (lower(get_fish_full_name(fimg_fish_zdb_id)) like '%$(LOWER,$stock)%')
  <?/MIVAR>
  <?MIVAR NAME=$constraintAlias>$constraint
    and (lower(dalias_alias) like '%$(LOWER,$stock)%')
  <?/MIVAR>
<?/MIBLOCK>



<!-- Make a prepass over the images, gathering information necessary to 
  -- display them in stock name, stage window order.  The prepass is
  -- necessary because of bugs in the DBMS. -->

<?MISQL SQL="
  create temp table temp_fish_image (
    tempfimg_fimg_zdb_id varchar(50),
    tempfimg_fish_full_name varchar(180),
    tempfimg_stg_hours_start decimal(7,2),
    tempfimg_stg_hours_end decimal(7,2)
  ) with no log;">
<?/MISQL>

<?MISQL SQL="
  insert into temp_fish_image
  select fimg_zdb_id, get_fish_full_name(fimg_fish_zdb_id),
	 MIN(lo.stg_hours_start), MAX(hi.stg_hours_end)
    from fish_image, OUTER (fish_image_stage, stage lo, stage hi)
    where 
      $(IF,$(NE,$constraint,""),$constraint and)
          fimg_zdb_id = fimgstg_fimg_zdb_id
      and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
      and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
    group by fimg_zdb_id, 2;">
<?/MISQL>

<?MIBLOCK COND=$(XST,$constraintAlias)>
  <?MISQL SQL="
    -- Also pick up the records that match on aliases.
    insert into temp_fish_image
    select fimg_zdb_id, get_fish_full_name(fimg_fish_zdb_id),
           MIN(lo.stg_hours_start), MAX(hi.stg_hours_end)
      from fish_image, data_alias, OUTER (fish_image_stage, stage lo, stage hi)
      where $constraintAlias
	and fimg_fish_zdb_id = dalias_data_zdb_id
	and fimg_zdb_id = fimgstg_fimg_zdb_id
      	and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
      	and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
	and not exists 
	    ( select * 
		from temp_fish_image
		where tempfimg_fimg_zdb_id = fimg_zdb_id)
      group by fimg_zdb_id, 2;">

  <?/MISQL>
<?/MIBLOCK>

<!-- RETRIEVE AND DISPLAY ALL MATCHING ENTRIES. -->

<table width=100%>
  <tr>
    <td width=15%>&nbsp;</td>
    <td width=70% align=center>
      <font size=4>Search Images: Result Summary </font>
      <br><font size=3>Ordered by age, stock name.
      <br>(Click on thumbnails for image details)</font>
    </td>
    <td width=15% align=center>
      <a href=#modify>Modify Search</a>
    </td>
  </tr>
</table>


<TABLE WIDTH=100%>
  <?MIVAR NAME=$firstIteration>1<?/MIVAR>

  <?MISQL SQL="
    select fimg_zdb_id, fimg_thumbnail, fimg_fish_zdb_id, 
	   tempfimg_fish_full_name, 
	   tempfimg_stg_hours_start, tempfimg_stg_hours_end
      from fish_image, temp_fish_image
      where fimg_zdb_id = tempfimg_fimg_zdb_id
      order by tempfimg_stg_hours_start, tempfimg_stg_hours_end,
	       tempfimg_fish_full_name">

    <?MIVAR NAME=$fimg_zdb_id>$1<?/MIVAR>
    <?MIVAR NAME=$fimg_thumbnail>$2<?/MIVAR>
    <?MIVAR NAME=$fimg_fish_zdb_id>$3<?/MIVAR>
    <?MIVAR NAME=$fish_full_name>$4<?/MIVAR>
    <?MIVAR NAME=$tempfimg_stg_hours_start>$5<?/MIVAR>
    <?MIVAR NAME=$tempfimg_stg_hours_end>$6<?/MIVAR>

    <?MIBLOCK COND=$(=,$firstIteration,1)>
      <?MIBLOCK COND=$(XST,$return_rec)>
        <TH> </TH>
      <?/MIBLOCK>
      <TH> </TH>
      <TH align=left>Stage(s)</TH>
      <TH align=left>Stock</TH>
      <?MIVAR NAME=$firstIteration>0<?/MIVAR>
    <?/MIBLOCK>
    <TR>
      <?MIBLOCK COND=$(XST,$return_rec)>
        <TD valign=top>
	  <FONT SIZE=-1> 
	  <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-do-select.apg&return_rec="$return_rec"&new_oid="$fimg_zdb_id >SELECT</A> 
	  </FONT>
        </TD>
      <?/MIBLOCK>
      <TD align=center>
	<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-imageview.apg&OID=$fimg_zdb_id"> 
	  <IMG SRC="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?LO=$fimg_thumbnail&MItypeObj=image/gif"></A> 
      </TD>
      <TD valign="TOP"> 
	<FONT SIZE=-1> 
	<?MISQL SQL="
	  select lo.stg_name, lo.stg_hours_start,
		 get_stg_name_long_html(lo.stg_zdb_id, 'popup_url'), 
	 	 hi.stg_name, hi.stg_hours_end,
		 get_stg_name_long_html(hi.stg_zdb_id, 'popup_url')
	    from stage lo, stage hi, fish_image_stage
	    where fimgstg_fimg_zdb_id = '$fimg_zdb_id'
	      and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
	      and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
	    order by lo.stg_hours_start, hi.stg_hours_end desc;">

	  <?MIVAR NAME=$lo_stg_name>$1<?/MIVAR>
	  <?MIVAR NAME=$lo_stg_name_long_html>$3<?/MIVAR>
	  <?MIVAR NAME=$hi_stg_name>$4<?/MIVAR>
	  <?MIVAR NAME=$hi_stg_name_long_html>$6<?/MIVAR>

	  $lo_stg_name_long_html
	  <?MIVAR COND=$(NE,$lo_stg_name,$hi_stg_name)>
	    to $hi_stg_name_long_html
	  <?/MIVAR>
	<?/MISQL>
	</FONT> 
      </TD>
      <TD valign=top> 
	<FONT SIZE=-1> 
	<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID=$fimg_fish_zdb_id">$fish_full_name</A>
	</FONT> 
      </TD>  
    </TR>
  <?/MISQL>

</TABLE>


<?MIBLOCK COND=$(=,$MI_ROWCOUNT,0)>
  <center><p><b>0</b> matching images found.</center>
<?/MIBLOCK>

<?MISQL SQL="
  -- without the insert statement, informix rejects the drop statement.
  insert into temp_fish_image values ('','',0,0);
  drop table temp_fish_image;">
<?/MISQL>


<?/MIBLOCK> <!-- query results -->




<?MIVAR COND="$(NXST,$stock)" NAME=$stock><?/MIVAR>
<?MIVAR COND="$(NXST,$comments)" NAME=$comments><?/MIVAR>
<?MIVAR COND="$(NXST,$preparation)" NAME=$preparation>ANY<?/MIVAR>


<form name=getcrits 
      method=post 
      action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->">
      
<?MIBLOCK COND="$(NXST,$query_results)">
  <center>
  <U><B><FONT SIZE=5>Search for </font>
  <FONT SIZE=5 color="#ff0000" > IMAGES</font></b></u>
  </center>
<?MIELSE>
  <Table width=100% bgcolor="CCCCCC">
    <TR>
      <TH><a name=modify>Modify your search.</a></TH>
    </TR>
    <TR>
      <TD>
<?/MIBLOCK>

  <TABLE width=100%>
    <?MIVAR>
      <TR>
	<TD align="right">
	  <font size=-1>
	  <b>Stock name contains:</b> 
	</TD>
	<TD>
	  <input type=text name=stock size=40 value="$stock">
	  </font>
	</TD>
      <TR>   
	<TD align="right">
	  <font size=-1>
	  <b>Image comments contain:</b> 
	</TD>
	<TD>
	  <input type=text name=comments size=40 value="$comments">
	  </font>
        </TD>
      </TR>
      <TR>   
	<TD align="right">
	  <font size=-1>
	  <b>Preparation:</b> 
	</TD>
	<TD>
	  <SELECT NAME=preparation>
            <option $(IF,$(EC,$preparation,ANY),SELECTED) value="ANY">ANY
	    <?MISQL SQL="
	      select fimgprep_name
		from fish_image_preparation
		order by fimgprep_name;">
              <option $(IF,$(EC,$preparation,$1),SELECTED) value="$1">$1
            <?/MISQL>
	  </SELECT>
	</TD>
      <TR>
        <TD colspan=2 align=right valign=top>
          <input type=submit name=action value="SEARCH" >
          <input type=button name=nothing value="RESET" onClick="call_reset()" >
        </TD>
      </TR>
    <?/MIVAR>
  </TABLE>



  <!-- This next little block executes only if we are using the browser as a
  selector. That is we want user to ultimately CHOOSE a browsed value. All
  we have to do at this point is pass the return_rec variable along to the 
  fishlister.
  -->
  <?MIVAR COND="$(XST,$return_rec)">
    <input type=hidden NAME="return_rec" value=$return_rec>
  <?/MIVAR>

  <input type=hidden name=MIval value=aa-imageselect.apg>
  <input type=hidden name="query_results" value="exist">

<?MIBLOCK COND="$(XST,$query_results)">
    </TD>
  </TR>
</TABLE>
<?/MIBLOCK>

</form>


<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>

