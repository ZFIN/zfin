<!-- 
FILE: do-imageupdate.html

INPUT VARS: 
OID -- the zdb_id of the rec to update
attr -- the column to be updated
attr_type -- textarea,text,or pic
new_value -- the new value to stick in the column
old_value -- the previous value
comments -- reasons for doing update 
annotations -- huge string of urlencoded changed annotations for the image. 
  Will be NULL if no changes to annotations were made;

OUTPUT VARS:
redirect to imageview.apg
updates records in fish_image or fx_fish_image_private

DESCRIPTION: commits the updates requested in the forms tossed up by
imageupdate.html. Also files update record.

-->

<?MIVAR COND=$(NXST,$annotations) NAME=$annotations>NULL<?/MIVAR>

<!-- First check security. Main purpose is just to get submitter id and name -->
<?MISQL SQL="
  select WebExplode(object, 'permission=owns&rtype=fish_image') 
    from webPages 
    where ID = 'aa-secure_navigation.apg';">
  $1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MIVAR COND="$(NXST,$new_value)" NAME=$new_value>NULL<?/MIVAR>
  <?MIVAR COND="$(NXST,$old_value)" NAME=$old_value>NULL<?/MIVAR>
  <?MIVAR COND="$(NXST,$comments)" NAME=$comments>NULL<?/MIVAR>
  <?MIVAR COND="$(NXST,$annotations)" NAME=$annotations>NULL<?/MIVAR>
  <?MIVAR COND="$(EC,$attr_type,special-listitem)" NAME=$comments>Deleted the record $old_value from the list of $attr associated with this line.<?/MIVAR>


  <?MIVAR NAME=$new_value DELIMIT="'" REPLACE="''">$new_value<?/MIVAR>
  <?MIVAR NAME=$old_value DELIMIT="'" REPLACE="''">$old_value<?/MIVAR>
  <?MIVAR NAME=$comments DELIMIT="'" REPLACE="''">$comments<?/MIVAR>

  <!-- insert update record for the update! -->
  <?MISQL COND="$(NC,$attr_type,special-done)" SQL="
    insert into updates 
        (submitter_id, submitter_name, rec_id, field_name, old_value, 
	 comments, when) 
      values ('$ZDB_ident', '$ZDB_name', '$OID', '$attr',  '$old_value', 
	      '$comments', current);">
  <?/MISQL>

  <!-- OK, NOW UPDATE THE  ACTUAL DATA RECORD. HAVE TO DO THINGS SLIGHTLY
       DIFFERENT FOR IMAGES, SO FIRST FIND OUT WHETHER YOU'RE UPDATING AN
       IMAGE FIELD, THEN ACT ACCORDINGLY -->

  <?MIBLOCK COND="$(EC,$attr_type,pic)">
    <?MISQL SQL="
      update fish_image 
        set $attr = '$OID'||'$fimgnew_suffix'
        where fimg_zdb_id = '$OID';">
    <?/MISQL>

    <?MISQL SQL="
      update fish_image 
        set fimg_thumbnail = '$OID'||'_thumb'||'$fimgnew_suffix'
	where fimg_zdb_id = '$OID';">
    <?/MISQL>

    <?MISQL SQL="
       update fish_image 
         set fimg_width = '$fimgnew_width'
	 where fimg_zdb_id = '$OID';">
     <?/MISQL>	

    <?MISQL SQL="
       update fish_image 
         set fimg_height = '$fimgnew_height'
	 where fimg_zdb_id = '$OID';">
     <?/MISQL>
	


  <?/MIBLOCK> <!-- ends if its an image -->

  <?MISQL COND="$(OR,$(EC,$attr_type,text),$(EC,$attr_type,textarea))" SQL="
    update $table
      set $attr = '$new_value'
      where $zdb_id='$OID';">
  <?/MISQL>

  <?MIBLOCK COND="$(NC,$annotations,NULL)">
    <?MIVAR NAME=$annotations DELIMIT="'" REPLACE="''">$annotations<?/MIVAR>
    <?MISQL SQL="
      update fish_image 
        set fimg_annotations = '$annotations' 
        where fimg_zdb_id = '$OID';">
    <?/MISQL>
  <?/MIBLOCK>


  <!-- Special case for deleting one of the associated images/sources/pubs -->
  <?MIBLOCK COND="$(EC,$attr_type,special-listitem)">
    <?MISQL COND="$(EC,$attr,publication)" SQL="
      delete from record_attribution
	where recattrib_data_zdb_id = '$OID'
	  and recattrib_source_zdb_id = '$old_value';">
    <?/MISQL>
  <?/MIBLOCK>  <!-- ends special listitem case -->

<?/MIBLOCK> <!-- ends cond authorized -->

<!-- okay, now just bail back to the imageupdate to view results -->
<?MIVAR>
  <SCRIPT>
    location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-imageview.apg&OID=$OID$(IF,$(NC,$attr_type,special-done),&UPDATE=1)')
  </SCRIPT>
<?/MIVAR>

