
<HTML>

<HEAD>
<SCRIPT>
  function popup_url(url) {
    open(url,"Description","toolbar=yes,scrollbars=yes,resizable=yes");
  }
</SCRIPT>
</HEAD>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>

<basefont size=2>

<!-- THIS NEXT PART IS EXECUTED AFTER THE PERSON ENTERS SOME CRITERIA -->
<!-- This next part builds up a query piece by piece, based on which criteria 
  were passed in 
-->

<?MIVAR NAME=$constraint><?/MIVAR>

<!-- First look at standard constraints -->

<?MIBLOCK COND="$(XST,$comments)">
  <?MIVAR NAME=$constraint>
    $(IF,$(NE,$constraint,""),and) 
    (lower(fimg_comments) like '%$(LOWER,$comments)%')
  <?/MIVAR>
<?/MIBLOCK>

<?MIBLOCK COND=$(XST,$preparation)>
  <?MIBLOCK COND=$(NE,$preparation,ANY)>
    <?MIVAR NAME=$constraint>$constraint
      $(IF,$(NE,$constraint,""),and) 
      (fimg_preparation = '$preparation')
    <?/MIVAR>
  <?/MIBLOCK>
<?/MIBLOCK>

<?MIBLOCK COND="$(XST,$stock)">
  <!-- First filter name for apostrophes! -->
  <?MIVAR COND="$(XST,$stock)" NAME=$stock DELIMIT="'" REPLACE="''">$stock<?/MIVAR>
  <?MIVAR NAME=$constraint>$constraint 
    $(IF,$(NE,$constraint,""),and) 
    (lower(get_fish_full_name(fimg_fish_zdb_id)) like '%$(LOWER,$stock)%')
  <?/MIVAR>
  <?MIVAR NAME=$constraintAlias>$constraint
    and (lower(dalias_alias) like '%$(LOWER,$stock)%')
  <?/MIVAR>
<?/MIBLOCK>



<!-- Make a prepass over the images, gathering information necessary to 
  -- display them in stock name, stage window order.  The prepass is
  -- necessary because of bugs in the DBMS. -->

<?MISQL SQL="
  create temp table temp_fish_image (
    tempfimg_fimg_zdb_id varchar(50),
    tempfimg_fish_full_name varchar(180),
    tempfimg_stg_hours_start decimal(7,2),
    tempfimg_stg_hours_end decimal(7,2)
  ) with no log;">
<?/MISQL>

<?MISQL SQL="
  insert into temp_fish_image
  select fimg_zdb_id, get_fish_full_name(fimg_fish_zdb_id),
	 MIN(lo.stg_hours_start), MAX(hi.stg_hours_end)
    from fish_image, OUTER (fish_image_stage, stage lo, stage hi)
    where 
      $(IF,$(NE,$constraint,""),$constraint and)
          fimg_zdb_id = fimgstg_fimg_zdb_id
      and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
      and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
    group by fimg_zdb_id, 2;">
<?/MISQL>

<?MIBLOCK COND=$(XST,$constraintAlias)>
  <?MISQL SQL="
    -- Also pick up the records that match on aliases.
    insert into temp_fish_image
    select fimg_zdb_id, get_fish_full_name(fimg_fish_zdb_id),
           MIN(lo.stg_hours_start), MAX(hi.stg_hours_end)
      from fish_image, data_alias, OUTER (fish_image_stage, stage lo, stage hi)
      where $constraintAlias
	and fimg_fish_zdb_id = dalias_data_zdb_id
	and fimg_zdb_id = fimgstg_fimg_zdb_id
      	and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
      	and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
	and not exists 
	    ( select * 
		from temp_fish_image
		where tempfimg_fimg_zdb_id = fimg_zdb_id)
      group by fimg_zdb_id, 2;">

  <?/MISQL>
<?/MIBLOCK>

<!-- RETRIEVE AND DISPLAY ALL MATCHING ENTRIES. -->

<center>
<FONT SIZE=4>Search Images: Result Summary </font>
<br>Ordered by age, stock name.
<br>(Click on thumbnails for image details)
</center> 


<TABLE WIDTH=100%>
  <?MIVAR NAME=$firstIteration>1<?/MIVAR>

  <?MISQL SQL="
    select fimg_zdb_id, fimg_thumbnail, fimg_fish_zdb_id, 
	   tempfimg_fish_full_name, 
	   tempfimg_stg_hours_start, tempfimg_stg_hours_end
      from fish_image, temp_fish_image
      where fimg_zdb_id = tempfimg_fimg_zdb_id
      order by tempfimg_stg_hours_start, tempfimg_stg_hours_end,
	       tempfimg_fish_full_name">

    <?MIVAR NAME=$fimg_zdb_id>$1<?/MIVAR>
    <?MIVAR NAME=$fimg_thumbnail>$2<?/MIVAR>
    <?MIVAR NAME=$fimg_fish_zdb_id>$3<?/MIVAR>
    <?MIVAR NAME=$fish_full_name>$4<?/MIVAR>
    <?MIVAR NAME=$tempfimg_stg_hours_start>$5<?/MIVAR>
    <?MIVAR NAME=$tempfimg_stg_hours_end>$6<?/MIVAR>

    <?MIBLOCK COND=$(=,$firstIteration,1)>
      <?MIBLOCK COND=$(XST,$return_rec)>
        <TH> </TH>
      <?/MIBLOCK>
      <TH> </TH>
      <TH align=left>Stage(s)</TH>
      <TH align=left>Stock</TH>
      <?MIVAR NAME=$firstIteration>0<?/MIVAR>
    <?/MIBLOCK>
    <TR>
      <?MIBLOCK COND=$(XST,$return_rec)>
        <TD valign=top>
	  <FONT SIZE=-1> 
	  <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-do-select.apg&return_rec="$return_rec"&new_oid="$fimg_zdb_id >SELECT</A> 
	  </FONT>
        </TD>
      <?/MIBLOCK>
      <TD align=center>
	<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-imageview.apg&OID=$fimg_zdb_id"> 
	  <IMG SRC="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?LO=$fimg_thumbnail&MItypeObj=image/gif"></A> 
      </TD>
      <TD valign="TOP"> 
	<FONT SIZE=-1> 
	<?MISQL SQL="
	  select lo.stg_name, lo.stg_hours_start,
		 get_stg_name_long_html(lo.stg_zdb_id, 'popup_url'), 
	 	 hi.stg_name, hi.stg_hours_end,
		 get_stg_name_long_html(hi.stg_zdb_id, 'popup_url')
	    from stage lo, stage hi, fish_image_stage
	    where fimgstg_fimg_zdb_id = '$fimg_zdb_id'
	      and fimgstg_start_stg_zdb_id = lo.stg_zdb_id
	      and fimgstg_end_stg_zdb_id = hi.stg_zdb_id
	    order by lo.stg_hours_start, hi.stg_hours_end desc;">

	  <?MIVAR NAME=$lo_stg_name>$1<?/MIVAR>
	  <?MIVAR NAME=$lo_stg_name_long_html>$3<?/MIVAR>
	  <?MIVAR NAME=$hi_stg_name>$4<?/MIVAR>
	  <?MIVAR NAME=$hi_stg_name_long_html>$6<?/MIVAR>

	  $lo_stg_name_long_html
	  <?MIVAR COND=$(NE,$lo_stg_name,$hi_stg_name)>
	    to $hi_stg_name_long_html
	  <?/MIVAR>
	<?/MISQL>
	</FONT> 
      </TD>
      <TD valign=top> 
	<FONT SIZE=-1> 
	<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID=$fimg_fish_zdb_id">$fish_full_name</A>
	</FONT> 
      </TD>  
    </TR>
  <?/MISQL>

</TABLE>


<?MIBLOCK COND=$(=,$MI_ROWCOUNT,0)>
  <center><p><b>0</b> matching images found.</center>
<?/MIBLOCK>

<?MISQL SQL="
  -- without the insert statement, informix rejects the drop statement.
  insert into temp_fish_image values ('','',0,0);
  drop table temp_fish_image;">
<?/MISQL>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>

</HTML>
