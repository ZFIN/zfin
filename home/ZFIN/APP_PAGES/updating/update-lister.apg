
<HTML>

<?MICOMMENT> No $UPDATE passed in, but it is always at update mode 
             when this page is called.
<?/MICOMMENT>
<?MISQL SQL="select WebExplode(object,'permission=owns&rtype=$rtype') from webPages where ID='aa-secure_navigation.apg';">$1<?/MISQL>


<?MIBLOCK COND=$(NC,$AUTHORIZED,false)>

<?MICOMMENT>
  *** THIS NEXT PART IS EXECUTED AFTER THE PERSON ENTERS SOME CRITERIA
  *** This next part builds up a query piece by piece, based on which criteria 
  *** were passed in 
<?/MICOMMENT>

<?MIVAR NAME=$constraint>rec_id='$OID'<?/MIVAR>

<?MICOMMENT> *** If any constraining criteria were given *** <?/MICOMMENT>
<?MIBLOCK COND="$(AND,$(XST,$field),$(XST,$period),$(OR,$(NC,$field,ANY),$(EC,$period,dated)))">

  <?MIVAR NAME=$constraint COND="$(NC,$field,ANY)">
    $constraint and (field_name='$field')
  <?/MIVAR>

  <?MIBLOCK COND="$(EC,$period,dated)">
    <?MIVAR COND="$(NXST,$smonth)" NAME=$smonth>01<?/MIVAR>
    <?MIVAR COND="$(NXST,$emonth)" NAME=$emonth>12<?/MIVAR>
    <?MIVAR COND="$(NXST,$syear)" NAME=$syear>1900<?/MIVAR>
    <?MIVAR COND="$(NXST,$eyear)" NAME=$eyear>2000<?/MIVAR>

    <?MIVAR NAME=$sdate>$smonth/01/$syear<?/MIVAR>
    <?MIVAR NAME=$edate>$emonth/01/$eyear<?/MIVAR>

    <?MIVAR NAME=$constraint>
      $constraint 
      and (    when::date > '$sdate'::date
           AND when::date < '$edate'::date)
    <?/MIVAR>

  <?/MIBLOCK>
<?/MIBLOCK>

<?MICOMMENT>
   *** NOW JUST RETRIEVE AND DISPLAY ALL MATCHING ENTRIES ***
<?/MICOMMENT>
<?MIVAR COND="$(NXST,$field)" NAME=$field>ANY<?/MIVAR>
<?MIVAR COND="$(NXST,$period)" NAME=$period>open<?/MIVAR>

<table width=100%>
  <?MISQL SQL="
    select submitter_id, when::date, field_name, old_value, 
	   comments, submitter_name, new_value
      from updates
      where $constraint
      order by when desc;">
    <?MIVAR NAME=$updlister_submitter_id>$1<?/MIVAR>
    <?MIVAR NAME=$updlister_date>$2<?/MIVAR>
    <?MIVAR NAME=$updlister_field_name>$3<?/MIVAR>
    <?MIVAR NAME=$updlister_old_value>$(IF,$(EQ,$4,NULL),,$4)<?/MIVAR>
    <?MIVAR NAME=$updlister_comments>$(IF,$(EQ,$5,NULL),,$5)<?/MIVAR>
    <?MIVAR NAME=$updlister_submitter_name>$6<?/MIVAR>
    <?MIVAR NAME=$updlister_new_value>$(IF,$(EQ,$7,NULL),,$7)<?/MIVAR>	
	
    <tr>
      <td colspan=2> <hr> </td>
    </tr>
    <tr> 
      <td colspan=2>
	<TABLE cellpadding=3 width=100% border=2>
	  <tr>
	    <td width=30%>
              <b>Submitter:</b> 
              <A HREF="/cgi-bin/webdriver?MIval=aa-persview.apg&OID=$updlister_submitter_id">$updlister_submitter_name</A>
            </td>
	    <td> <b>Changed field:</b> $updlister_field_name </td> 
	    <td> <b>Date:</b> $updlister_date </td> 
	  </tr>
        </TABLE>
      </td>
    </tr>
    <tr>
      <td align="right" valign="top"  width=40%><b>Old value:</b> </td>
      <td valign="top">$updlister_old_value </td>
    </tr>
    <tr>
      <td align="right" valign="top" width=40%><b>New value:</b> </td>
      <td valign="top">$updlister_new_value </td>
    </tr>
    <tr>
      <td align="right" valign="top" width=40%>
		<b>Submitter&nbsp;comments:</b> 
      </td>
      <td valign="top">$updlister_comments</td>
    </tr>
  <?/MISQL>

  <?MIVAR COND="$(=,$MI_ROWCOUNT,0)">
    <p><center><b>No updates have occurred</b></center>
  <?/MIVAR>

</table>

<?/MIBLOCK> <?MICOMMENT> -- end $AUTHORIZED check --<?/MICOMMENT>

</HTML>
