<!-- File: New-fish.html
This  app page handles submission of new mutant and wild type lines. It allows digressions to select things like discoverer, parents, etc.  During submission, data for all fields is stored in the temp_fish table. When submitted, this data is used to populate new fish and (for mutants) new chromosome and alteration records.

Variables expected:
OID or temp_oid -- if not there, it assumes first entry and creates new temp_fish record; else is pulls data out of corresponding temp_fish record (i.e. on return from a digression).

line_type (optional) -- should be either 'mutant' or 'wild type'. If not exists, it assumes wild_type

-->

<?MIVAR COND="$(NXST,$line_type)" NAME=$line_type>wild type<?/MIVAR>

<HTML>

<head>
  <META HTTP-EQUIV="EXPIRES" CONTENT="Wed Sep 11 09:35:25 PDT 1996">

  <?MIVAR>
    <SCRIPT>
      function add_source(selector) {
	var selectedValue=selector[selector.selectedIndex].value;
	selector.selectedIndex=0;
	if (selectedValue != 'none') {
	  document.fishdata.source_type.value=selectedValue;
	  document.fishdata.s_source.value=1;
	  document.fishdata.submit();
	}
      }
    </SCRIPT>
  <?/MIVAR>
</head>

<?MISQL SQL="select WebExplode(object,'permission=root&page_title=New $line_type') from webPages where ID='aa-secure_navigation.apg';">$1<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">


<!-- THIS IS A VERY TRICKY PAGE. The main challenge lies in the fact that users
will be "building up" a submission, adding pubs to it, selecting affected gene,
etc etc. In other words, they may engage in lots of "side processes" before they
have built up their final submission and press the "submit" button. The challenge is to maintain the state of their evolving submission as they do this. The solution is clever: The FIRST thing this page does if this is the first entry into the page, is to create a "temporary" data record in the TEMP_FISH table.
Then it pops up the FISH entry form. 
The ZDB_ID for this record is passed around to all subsequent forms. Every time a submitter follows a link to, say, specify pubs or something, the current form values are saved off to the temp. record. When they finish selecting a pub or whatever, they are returned to this page, passing in the ZDB_ID of the temp. form, which causes the TEMP_FISH entry form to be displayed with all current values. When they finally click SUBMIT, form values are updated one last time, and the entire data record copied to the actual FISH table.
-->

<!-- Pass in any variables you want the form to be initialized with on the command-line. You will need to modify setup-new-fish to avoid blasting these values however.
OTHER NOTABLE VARIABLES that could be passed in:
-- FLAG. Contains a text string with dash-separated flags to allow one to pass in some info about where the call to NEW-FISH came from; this info is used to customize the form you get from NEW-FISH. Significant flags are "by_breeding", inidcates you are specifying a new double-mutant generated by cross-breeding and "from_image" which indicates you jumped to this form while in the midst of submitting an image.
-->

<!-- FIRST DO SOME IMPORTANT SETUP. MOSTLY THIS IS IN SEPERATE FILE TO KEEP FILE 
SIZE MANAGEABLE-->

  <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-setup-new-fish.apg';">
$1<?/MISQL>


<!-- NOW JUST THROW UP THE FORM FOR ENTERING A NEW MUTANT LINE -->
    <?MIVAR>
      <FORM NAME=fishdata METHOD=POST ACTION="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->">

      <INPUT type=hidden NAME=temp_oid VALUE=$temp_oid>
      <INPUT type=hidden NAME=MIval VALUE="aa-process-fish.apg">
      <INPUT type=hidden NAME=flag VALUE="$flag">
      <INPUT type=hidden NAME=line_type VALUE="$line_type">
      <INPUT type=hidden NAME=submitter_id VALUE=$ZDB_ident>
    <?/MIVAR>

    <?MIVAR><h1>DATA SUBMISSION: New $line_type line </h1><?/MIVAR>

    Fill in as many entries as you can and then click on the SUBMIT button.
    <p>

    <TABLE cellpadding=6 width=100%>
      <TR> 
        <TD>
          <A HREF="/ZFIN/help_files/help-fish.html#name">NAME: </A> <br> 
          <INPUT TYPE=text <?MIVAR COND="$(NC,$name,NULL)">value="$name" <?/MIVAR> NAME="name"> 
        </TD>
        <TD>
          <A HREF="/ZFIN/help_files/help-fish.html#type">ABBREVIATION:</A> <br>
          <INPUT TYPE=text SIZE=10 <?MIVAR COND="$(NC,$abbrev,NULL)">value="$abbrev" <?/MIVAR> NAME="abbrev"> 
        </TD>

        <!-- Now if its a mutagenized line, ask for new allele name, mutagen, etc -->
        <?MIBLOCK COND="$(AND,$(EC,$line_type,mutant),$(=,$(POSITION,$flag,by_breeding),0))">
          <TD>
            <A HREF="/ZFIN/help_files/help-fish.html#type">ALLELE:</A> <br>
            <INPUT TYPE=text SIZE=10 <?MIVAR COND="$(NC,$allele,NULL)">value=$allele <?/MIVAR> NAME="allele"> 
          </TD>
        </TR>

        <TR>

        <!-- ask about mutagen only if it's not spontaneous! -->
        <TD colspan=2> 
          <A HREF="/ZFIN/help_files/help-fish.html#availability">MUTAGENIZING PROTOCOL:</A> 
          <?MIBLOCK COND="$(NC,$mutagen,spontaneous)">
            <br>
            <SELECT NAME=protocol>
              <OPTION <?MIVAR COND="$(EC,$protocol,sperm)">SELECTED<?/MIVAR> >sperm
              <OPTION <?MIVAR COND="$(EC,$protocol,embryos)">SELECTED<?/MIVAR> >embryos
              <OPTION <?MIVAR COND="$(OR,$(EC,$protocol,NULL),$(EC,$protocol,adult_males))">SELECTED<?/MIVAR> >adult_males
              <OPTION <?MIVAR COND="$(EC,$protocol,adult_females)">SELECTED<?/MIVAR> >adult_females
            </SELECT>
            treated with 
            <SELECT NAME=mutagen>
              <OPTION <?MIVAR COND="$(OR,$(EC,$mutagen,ENU),$(EC,$mutagen,NULL))">SELECTED<?/MIVAR> >ENU
              <OPTION <?MIVAR COND="$(EC,$mutagen,EMS)">SELECTED<?/MIVAR> >EMS
              <OPTION <?MIVAR COND="$(EC,$mutagen,g-rays)">SELECTED<?/MIVAR> >g-rays
              <OPTION <?MIVAR COND="$(EC,$mutagen,DNA)">SELECTED<?/MIVAR> >DNA
              <OPTION <?MIVAR COND="$(EC,$mutagen,spontaneous)">SELECTED<?/MIVAR> >spontaneous
            </SELECT>
          <?/MIBLOCK> <!-- ends if not spontaneous -->

          <?MIBLOCK COND="$(EC,$mutagen,spontaneous)">
            <b>NONE -- spontaneous mutation</b>
            <input type=hidden name=mutagen value="spontaneous">
            <input type=hidden name=protocol value="unknown">
          <?/MIBLOCK>
        </TD>

        <?/MIBLOCK> <!-- ends "if its mutagenized line" -->

      </TR>
    </TABLE>


    <A NAME="source-info">
    <hr size=4 width=80%>
    <p>

    <TABLE cellpadding=6 width=100%>
      <TR> 
        <TD>
          <A HREF="/ZFIN/help_files/help-fish.html#availability">DISCOVERER:</A> 
          <?MIVAR COND="$(EC,$discoverer,NULL)">unknown.<?/MIVAR>
          <?MIBLOCK COND="$(NC,$discoverer,NULL)">
            <?MISQL SQL="select full_name from person where zdb_id='$discoverer';"><b>$1</b><?/MISQL>
          <?/MIBLOCK>
        </TD>
        <TD>
          <input type=submit name="s_discover" value="Specify Discoverer">
        </TD>
        <TD size=50% align=right><A HREF="/ZFIN/help_files/help-chromo.html#lab">LAB:</A>

	  <?MIBLOCK COND="$(EC,$line_type,mutant)">
	    <SELECT NAME="lab">
	      <?MISQL SQL="select zdb_id,name from lab where allele_prefix is not null order by name;">
		<option $(IF,$(EC,$lab,$1),SELECTED) VALUE="$1">$2
	      <?/MISQL>
	    </SELECT>
	  <?/MIBLOCK>

	  <?MIBLOCK COND="$(NC,$line_type,mutant)">
	    <?MIVAR COND="$(EC,$lab,NULL)">unknown.<?/MIVAR>
	    <?MISQL COND="$(NC,$lab,NULL)" SQL="select name from lab where zdb_id='$lab';"><b>$1</b>
	    <?/MISQL>
	    <input type=submit name="s_lab" value="Specify Lab">
	 <?/MIBLOCK>

        </TD> 
      </TR>
    </TABLE>

    <TABLE cellpadding=6 width=100%>
      <TR> 
	<TD><A HREF="/ZFIN/help_files/help-chromo.html#lab">STATUS of this line:</A>
	  <SELECT NAME=status>
	    <option value="Dead" <?MIVAR COND="$(EC,$status,Dead)"> SELECTED <?/MIVAR> >Extinct


	    <?MIBLOCK COND="$(EC,$line_type,mutant)">
	      <option value="Frozen" <?MIVAR COND="$(EC,$status,Frozen)"> SELECTED <?/MIVAR> >Frozen
	    <?/MIBLOCK>
	    <option value="Alive" <?MIVAR COND="$(OR,$(EC,$status,NULL),$(EC,$status,Alive))"> SELECTED <?/MIVAR> >Live
	  </SELECT>
	</TD>
	<TD>
	  <b> Original Stock/Cross Number: </b>
	  <INPUT type=text size=30
	  <?MIVAR COND="$(NC,$orig_crossnum,NULL)"> VALUE="$orig_crossnum" <?/MIVAR> 
	  NAME="orig_crossnum">
	</TD>
      </TR>
    </TABLE>

    <TABLE cellpadding=6 width=100%>
      <TR>
	<TD><A HREF="/ZFIN/help_files/help-fish.html#availability"> CURRENT SOURCE(s):</A>
	  <?MIVAR COND="$(EC,$status,Dead)"> Not Applicable; Dead strain.<?/MIVAR>
	  <?MIBLOCK COND="$(NC,$status,Dead)">
	</TD>
	<TD>
	    <input type=hidden name=source_type value="lab">
	    <input type=hidden name=s_source value="">
	    <SELECT name=sub_source onChange="add_source(this);">
	      <option value="none" SELECTED>Select source to add
	      <option value="lab">Add a lab to source list
	      <option value="person">Add a person to source list
	      <option value="company">Add a company to source list
	    </SELECT>
	</TD>
      </TR>

	  <?MIVAR NAME=$MI_NOVALUE><?/MIVAR>
	  <?MISQL SQL="select b.name, b.address from int_fish_source a,sources b where source_id='$temp_oid' and target_id=b.zdb_id;" DATASET=2>
	    <TR>
	      <TD width=50%><b>$1</b><br><font size=-1>$2</font>
	      <TD width=50%><b>$1[2]</b><br><font size=-1>$2[2]</font>
	    </TR>
	  <?/MISQL>
	  <?MIVAR COND="$(AND,$(NC,$status,Dead),$(<,$MI_ROWCOUNT,1))"> 
	    <TR>
	      <TD colspan=2>No sources specified yet.
	      </TD>
	    </TR>
	  <?/MIVAR>
        <?/MIBLOCK>

      </TR>
    </TABLE>

    <A NAME="pheno-info">
    <HR width=100% size=3>

    <h3 align=center>PHENOTYPE INFORMATION</h3>

    <A HREF="/ZFIN/help_files/help-fish.html#phenotype">DESCRIPTION of phenotype:</A> <br>
    <TEXTAREA NAME=phenotype WRAP=virtual rows=5 cols=75>
      <?MIVAR COND=$(NC,$phenotype,NULL)>$phenotype<?/MIVAR>
    </TEXTAREA>
    <p>


    <!-- Rest applies only to mutant lines -->
    <?MIBLOCK COND="$(EC,$line_type,mutant)">


      <TABLE cellpadding=6 width=100%>
        <TR>
          <TD width=50%><A HREF="/ZFIN/help_files/help-fish.html#phenotype">ANATOMICAL PARTS AFFECTED:</A>
          </TD>
          <TD>


          <!-- Instead of anat. parts picker, tell user to fill out a filemaker form. Note that we give the ultimate ZFIN ID for the new fish, namely the TEMPOID with the word TEMP replaced with the word FISH. This will be what we will do to generate the final ZFIN ID for the new FISH  -->

          </TD>
         </TR>
         <TR>
           <TD>
             <big>Please switch to Filemaker now</big> and fill out a phenotypic description record for this mutant line. 

             <font color="#ff0000" size=+1>Important:</font> Please place the following ZFIN identification number in the Filemaker record so that we can later integrate the Filemaker file with this mutant submission:<p>
             <center><table width=70%>
        <TR>
          <TD>
           <b>ZFIN record id: <font size=+2 color="#ff0000"> 
           <?MIVAR>$(REPLACE,$temp_oid,TEMP,FISH)<?/MIVAR> </font> 
          </TD>
        </TR>
      </TABLE>
      </center>
      <p>
      When you have finished filling out the Filemaker record, please return to Netscape and continue on with the rest of this submission form.

      </TD>
      </TR>
      </TABLE>
      <p>


      <A NAME="cross-info">
      <HR WIDTH=100% SIZE=4>
      <h3 align=center>CROSS INFORMATION</h3>

      <TABLE cellpadding=6 border width=100%>
        <TR align=center>
          <TD><b>Maternal line: </b>
            <?MIVAR COND=$(EC,$mother,NULL)>unknown.<?/MIVAR>
            <?MIBLOCK COND="$(NC,$mother,NULL)">
              <?MISQL SQL="select name from fish where zdb_id='$mother';"><b>$1</b><?/MISQL>
            <?/MIBLOCK>
            <br>
            <input type=submit name="s_mother" value="Specify">
          </TD>
          <TD>
          <b>Paternal line: </B>
          <?MIVAR COND="$(EC,$father,NULL)">unknown.<?/MIVAR>
          <?MIBLOCK COND="$(NC,$father,NULL)">
            <?MISQL SQL="select name from fish where zdb_id='$father';"><b>$1</b><?/MISQL>
          <?/MIBLOCK>
          <br>
          <input type=submit name="s_father" value="Specify">
          </TD>
        </TR>
      </TABLE>

      <TABLE cellpadding=6 WIDTH=100%>
        <TR align=center>
          <TD> <b>Segregation:</b> 
            <INPUT type=text size=30 <?MIVAR COND="$(NC,$segregation,NULL)"> VALUE="$segregation" <?/MIVAR> NAME="segregation">
          </TD>
        </TR>
      </TABLE>

      <!-- Do this last block only if its a mutagenized (not cross-bred) mutant. In the latter case, all this info is inherited from the parents! -->
      <?MIBLOCK COND="$(=,$(POSITION,$flag,by_breeding),0)">

	<p>
	<HR WIDTH=100% SIZE=4 COLOR="#00ff00">
	<h3 align=center>MAPPING INFORMATION</h3>

	<TABLE WIDTH=100%>
    	  <TR>

	  <?MIVAR>
	    <TD> <A HREF="/ZFIN/help_files/help-chromo.html#chrom_num">CHROM# (1-25):</A>
	      <SELECT name="chrom_num">
		<option $(IF,$(EC,$chrom_num,0),SELECTED) value=0>unknown
		<option $(IF,$(EC,$chrom_num,1),SELECTED) value=1>1
		<option $(IF,$(EC,$chrom_num,2),SELECTED) value=2>2
		<option $(IF,$(EC,$chrom_num,3),SELECTED) value=3>3
		<option $(IF,$(EC,$chrom_num,4),SELECTED) value=4>4
		<option $(IF,$(EC,$chrom_num,5),SELECTED) value=5>5
		<option $(IF,$(EC,$chrom_num,6),SELECTED) value=6>6
		<option $(IF,$(EC,$chrom_num,7),SELECTED) value=7>7
		<option $(IF,$(EC,$chrom_num,8),SELECTED) value=8>8
		<option $(IF,$(EC,$chrom_num,9),SELECTED) value=9>9
		<option $(IF,$(EC,$chrom_num,10),SELECTED) value=10>10
		<option $(IF,$(EC,$chrom_num,11),SELECTED) value=11>11
		<option $(IF,$(EC,$chrom_num,12),SELECTED) value=12>12
		<option $(IF,$(EC,$chrom_num,13),SELECTED) value=13>13
		<option $(IF,$(EC,$chrom_num,14),SELECTED) value=14>14
		<option $(IF,$(EC,$chrom_num,15),SELECTED) value=15>15
		<option $(IF,$(EC,$chrom_num,16),SELECTED) value=16>16
		<option $(IF,$(EC,$chrom_num,17),SELECTED) value=17>17
		<option $(IF,$(EC,$chrom_num,18),SELECTED) value=18>18
		<option $(IF,$(EC,$chrom_num,19),SELECTED) value=19>19
		<option $(IF,$(EC,$chrom_num,20),SELECTED) value=20>20
		<option $(IF,$(EC,$chrom_num,21),SELECTED) value=21>21
		<option $(IF,$(EC,$chrom_num,22),SELECTED) value=22>22
		<option $(IF,$(EC,$chrom_num,23),SELECTED) value=23>23
		<option $(IF,$(EC,$chrom_num,24),SELECTED) value=24>24
		<option $(IF,$(EC,$chrom_num,25),SELECTED) value=25>25
	    </SELECT>
	  </TD> 
	<?/MIVAR>

	<TD>
	  <A HREF="/ZFIN/help_files/help-chromo.html#chrom_change">CHROMOSOME CHANGE:</A>
	  <SELECT NAME="chrom_change">
	    <option <?MIVAR COND="$(EC,$chrom_change,point)"> SELECTED <?/MIVAR> >point
	    <option <?MIVAR COND="$(EC,$chrom_change,duplication)"> SELECTED<?/MIVAR> >duplication
	    <option <?MIVAR COND="$(EC,$chrom_change,deficiency)"> SELECTED <?/MIVAR> >deficiency
	    <option <?MIVAR COND="$(EC,$chrom_change,translocation)"> SELECTED <?/MIVAR> >translocation
	    <option <?MIVAR COND="$(EC,$chrom_change,transposition)"> SELECTED <?/MIVAR> >transposition
	    <option <?MIVAR COND="$(EC,$chrom_change,insertion)"> SELECTED <?/MIVAR> >insertion
	    <option <?MIVAR COND="$(EC,$chrom_change,inversion)"> SELECTED <?/MIVAR> >inversion
	    <option <?MIVAR COND="$(OR,$(EC,$chrom_change,unknown),$(EC,$chrom_change,NULL))"> 
	    SELECTED <?/MIVAR> >unknown
          </SELECT>
	</TD>
       </TR>
       <TR>
	<TD><A HREF="/ZFIN/help_files/help-chromo.html#gen_loc">MAP LOCATION:</A> <br>
	  <INPUT TYPE=text 
	  <?MIVAR COND=$(NC,$genetic_loc,NULL)> VALUE="$genetic_loc" <?/MIVAR> NAME="genetic_loc">
	</TD>
      </TR>
      <TR>
	<TD><A HREF="/ZFIN/help_files/help-chromo.html#cyto_loc">CYTOLOGICAL LOCATION: </A> <br>
	  <INPUT TYPE=text 
	  <?MIVAR COND=$(NC,$cyto_loc,NULL)> VALUE="$cyto_loc" <?/MIVAR> NAME="cyto_loc">
	</TD>
	<TD><A HREF="/ZFIN/help_files/help-chromo.html#breakpoints">BREAKPOINTS: </A> <br>
	  <INPUT TYPE=text 
	  <?MIVAR COND=$(NC,$breakpoints,NULL)> VALUE="$breakpoints" <?/MIVAR> NAME="breakpoints">
	</TD>
	</TR>
	</TABLE>

      <?/MIBLOCK> <!-- Ends mutagenized case -->

      <!-- Now list mutant alleles it gets from parents. Probably none in mutagenized case, where
      parents are usually (but not always) wild-type. Should certainly *not* be none in cross-breeding case!  -->
      <hr width=50%>
      <p>
      <BIG>Mutant Alleles contributed by parents:</BIG> (based on parents specified above) <p>

      <TABLE WIDTH=100% border>
        <TH>Allele</TH><TH>Mutation type</TH><TH>LG</TH><TH>Location</TH>
        <?MISQL SQL="select c.allele, c.genetic_loc, c.chrom_change, b.chrom_num, c.zdb_id from int_fish_chromo a, chromosome b, alteration c where (a.source_id='$father' or a.source_id='$mother') and b.zdb_id=a.target_id and c.chrom_id=a.target_id;">
          <TR align=center>
            <TD> <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-altview.html&OID=$5">$1</A>            </TD>
            <TD>$3</TD>
            <TD> $(IF,$(EC,$4,NULL),unknown,$4) </TD>
            <TD> $(IF,$(EC,$2,NULL),unknown,$2) </TD>
          </TR>
        <?/MISQL>

        <?MIBLOCK COND="$(=,$MI_ROWCOUNT,0)">
          <TR>
            <TD  align=center colspan=4> <b>NONE</b> 

              <!-- Issue warning in cross-bred case --> 
              <?MIVAR COND="$(>,$(POSITION,$flag,by_breeding),0)">
                (<FONT color="#ff0000">WARNING:</FONT> doesn't make much sense! Don't forget to specify paternal and maternal lines above!)
              <?/MIVAR>

            </TD>
          </TR>
        <?/MIBLOCK> <!-- ends rowcount=0 case -->

      </TABLE>

    <?/MIBLOCK>  <!-- ends if mutant line -->


  <HR WIDTH=80% size=4>

  <A HREF="/ZFIN/help_files/help-fish.html#phenotype">Submitter COMMENTS:</A> <br>
  <TEXTAREA NAME=comments WRAP=virtual rows=5 cols=75>
    <?MIVAR COND="$(NC,$comments,NULL)">$comments<?/MIVAR>
  </TEXTAREA>


  <!-- Now webexplode in the pub specifier. -->
  <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-enterpubs.apg';">$1<?/MISQL>


  <p>

  <HR WIDTH=80% size=4>

  <?MIVAR>
    <input type=submit name="s_done" value="SUBMIT the new $line_type fish record.">
  <?/MIVAR>

  </FORM>

  </HTML>

<?/MIBLOCK> <!-- ends COND AUTHORIZED -->




