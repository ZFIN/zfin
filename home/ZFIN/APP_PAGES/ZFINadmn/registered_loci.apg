<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<?MICOMMENT> 
Used by root to police pending locus registrations. Root can change 
the status of a registration.  
So the possible status states are:   unreviewed, conditional, public
PARAMS:
update == optional, if exists then it's the zdb_id of the locus_registration 
          to update.
action == is either 'approve', 'make_public', or 'delete' depending on which 
          action to do.

UPDATE ECK 4/21/99.  Will modify to allow public to see pending 
registrations -- but not update of course.
<?/MICOMMENT> 

<?MIERROR>
  <?MIVAR COND=$(XST,$MI_SQL)>
    SQL: $MI_SQL<br><br>
  <?/MIVAR>

  Code:    $MI_ERRORCODE <br>
  State:   $MI_ERRORSTATE <br>
  Message: $MI_ERRORMSG <br>

<?/MIERROR>

<HEAD>

<title>ZFIN Registered Loci</title>
<META HTTP-EQUIV="EXPIRES" CONTENT="-2d">

<SCRIPT>
  function change_status(selector,locus_id,the_allele) {
    var theAction=selector.name;
    document.location='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-registered_loci.apg&update='+locus_id+'&allele='+the_allele+'&action='+theAction;
  }

  function change_descr(selector,locus_id,the_allele) {
    var theDescr=escape(selector.value);
    document.location='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-registered_loci.apg&update='+locus_id+'&allele='+the_allele+'&action=descr&description='+theDescr;
  }
</SCRIPT>
</HEAD>

<?MIVAR NAME=$MI_NULL><?/MIVAR>

<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-htmlpageheader.apg';">
  $1
<?/MISQL>

<?MISQL SQL="
  select WebExplode(object,'page_title=Registered Loci&permission=root') 
    from webPages 
    where ID='aa-secure_navigation.apg';">
  $1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MIBLOCK COND="$(XST,$update)"> 
    <!-- Approve it and insert rudimentary fish record -->
    
    <?MIBLOCK COND="$(EC,$action,make_public)">
      <!-- inserts aren't done in right order.  Rather than take the time to
      -- reorder them, just defer the constraints.
      -- The "set explain off" is required to avoid a bug with the
      -- "set constraints" statement below.  The "set explain" statement was
      -- picked because it was the most innoccuous statement I could think of.
      -->
      <?MISQL SQL="
      set explain off;
      set constraints all deferred;">
      <?/MISQL>

      <?MISQL SQL="
	select zdb_id, locus_name, abbrev, allele, owner, pheno_descr,
	       fish_record 
	  from locus_registration 
	  where zdb_id='$update' and allele='$allele';">
      <?/MISQL>

      <!-- only do it if not yet done! -->
      <?MIBLOCK COND=$(ISNULL,$7)>
	<?MIVAR NAME=$locus_id>$1<?/MIVAR>
	<?MIVAR NAME=$locus_name>$2<?/MIVAR>
	<?MIVAR NAME=$abbrev>$3<?/MIVAR>
	<?MIVAR NAME=$allele>$4<?/MIVAR>
	<?MIVAR NAME=$owner>$5<?/MIVAR>
	<?MIVAR NAME=$descr>$6<?/MIVAR>
	<?MISQL SQL="
	  select target_id, position, labpos_order 
	    from int_person_lab, lab_position 
	    where source_id = '$owner' and position = labpos_position 
	    order by labpos_order;">
	<?/MISQL>
	<?MIVAR NAME=$lab>$1<?/MIVAR>
	<!-- if owner is a member of ZFIN database team do not set ZFIN as lab, set lab to null -->
	<?MIVAR COND="$(OR,$(EC,$lab,ZDB-LAB-000914-1),$(EC,$lab,ZDB-LAB-991005-53))" NAME=$lab><?/MIVAR>
	<?MIVAR NAME=$full_abbrev>$abbrev<sup>$allele</sup><?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('TEMP');">
	<?/MISQL>
	<?MIVAR NAME=$temp_oid>$1<?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('CHROMO');">
	<?/MISQL>
	<?MIVAR NAME=$chromo_id>$1<?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('ALT');">
	<?/MISQL>
	<?MIVAR NAME=$alt_id>$1<?/MIVAR>

	<?MISQL SQL="
	  insert into zdb_active_data
	      ( zactvd_zdb_id )
	    values
	      ( '$temp_oid' );">
	<?/MISQL>
	<?MISQL SQL="
	  insert into temp_fish 
	      (comments, submitter_id, entry_time, zdb_id, locus, allele,
	       chrom_num, phenotype, lab, discoverer, line_type,
	       abbrev, name, chrom_change, mutagen, protocol)
	    values 
	      ('Provisional record for newly registered locus/allele',
	       '$owner', current, '$temp_oid', '$locus_id', '$allele',
	       '0', $(IF,$(EQ,$descr,),NULL,'$descr'), '$lab', '$owner', 'mutant',
	       '$abbrev','$locus_name','unknown','not specified','not specified');">
	<?/MISQL>
	<?MIVAR NAME=$s_done>true<?/MIVAR>
	<?MIVAR NAME=$submitter_id>$owner<?/MIVAR>
	<?MISQL SQL="
	  select WebExplode(object,'') 
	    from webPages 
	    where ID='aa-process-fish.apg';">
	<?/MISQL>
	<?MIVAR NAME=$fish_id>$(REPLACE,$temp_oid,TEMP,FISH)<?/MIVAR>

	<!-- make a locus record if it's new! -->
	<?MISQL SQL="
	  select count(*)::integer 
	    from locus
	    where zdb_id = '$locus_id';">
	<?/MISQL>
	<?MIVAR NAME=$locus_cnt>$1<?/MIVAR>
	<?MIBLOCK COND="$(<,$locus_cnt,1)">
	  <?MISQL SQL="
	    insert into zdb_active_data
		(zactvd_zdb_id)
	      values
		('$locus_id');">
	  <?/MISQL>
	  <?MISQL SQL="
	    insert into locus 
		(zdb_id, locus_name, abbrev, comments, owner) 
	      values 
		('$locus_id', '$locus_name', '$abbrev',
		 'Provisional record for newly registered locus/allele','$owner');">
	  <?/MISQL>
          <?MICOMMENT>Add new locus to names fast search tables.<?/MICOMMENT>
          <?MISQL SQL="
            execute procedure regen_names_locus('$OID');">
          <?/MISQL>    
	<?/MIBLOCK>

      <?/MIBLOCK>

	<?MISQL SQL="
	  update locus_registration
	    set status = 'public', locusreg_public_release_date = current
	    where zdb_id = '$update' and allele='$allele';">
        <?MIVAR>
 	<script>
	window.alert('The status for $allele has been set to public and a new mutant record was created. Please attribute the mutant record using fishview.apg.');
	</script>
	<?/MIVAR>
	<?/MISQL>

    <?/MIBLOCK> <!-- ends make_public actions -->

    <?MICOMMENT>
      The following code used to add 6 months to the expiration date.
      This would abort if you were on the 31st of the month, and the month
      6 months from now had less than 31 days.  Avoid the issue by adding
      183 days instead.
    <?/MICOMMENT>
    <?MISQL COND="$(EC,$action,approve)" SQL="
      update locus_registration 
	set status = 'conditional', 
            locusreg_nomen_approved_date = current,
            locusreg_expiration_deadline = current + interval (183) day(3) to day
	where zdb_id = '$update' and allele='$allele';">
    <?/MISQL>

    <?MISQL COND="$(EC,$action,extend)" SQL="
      update locus_registration 
	set locusreg_expiration_deadline = current + interval (183) day(3) to day
	where zdb_id = '$update' and allele='$allele';">
        <?MIVAR>
 	<script>
	window.alert('UPDATE: Deadline extended for $allele.');
	</script>
	<?/MIVAR>
    <?/MISQL>

    <?MISQL COND="$(EC,$action,expire)" SQL="
      delete from locus_registration 
	where zdb_id = '$update' and allele='$allele';">
        <?MIVAR>
 	<script>
	window.alert('UPDATE: Registration for $allele has been deleted.');
	</script>
	<?/MIVAR>
    <?/MISQL>
    
    <?MIBLOCK COND="$(EC,$action,descr)">
      <?MIVAR NAME=$description DELIMIT="'" REPLACE="''">$description<?/MIVAR>
      <?MISQL SQL="
	update locus_registration
	  set pheno_descr = '$description'
	  where zdb_id = '$update' and allele = '$allele';">
      <?/MISQL>
      <?MISQL SQL="
	select fish_record 
	  from locus_registration 
	  where zdb_id = '$update' and allele='$allele';">
      <?/MISQL>
      <?MIVAR NAME=$fish_rec>$1<?/MIVAR>
      <?MISQL SQL="
	update fish
	  set phenotype = '$description'
	  where zdb_id = '$fish_rec';">
      <?/MISQL>
      <?MISQL SQL="
	update fish_search 
	  set phenotype = '$description'
	  where fish_id = '$fish_rec';">
      <?/MISQL>
    <?/MIBLOCK>

  <?/MIBLOCK>


  <center><font size=4><b>Pending Locus Registrations</b></font></center>
  <p>
  <form name=lociform>
    <?MIVAR NAME=$MI_NULL><?/MIVAR>

    <TABLE width="100%">
      <TH>LOCUS</TH> <TH>OWNER</TH>  <TH align=left>STATUS</TH>
      <?MISQL SQL="
	select locus_name, abbrev, allele, b.full_name, a.entry_time::date,
	       status, (current::date - a.entry_time::date) units day,
	       a.zdb_id,
	       a.locusreg_nomen_approved_date::date, 
               a.locusreg_expiration_deadline::date, 
               pheno_descr,
	       fish_record,
               a.locusreg_public_release_date
	  from locus_registration a, person b
	  where a.owner = b.zdb_id
	    and a.locusreg_public_release_date is null
	  order by locus_name;">
	<?MIVAR NAME=$locus_name>$1<?/MIVAR>
	<?MIVAR NAME=$abbrev>$2<?/MIVAR>
	<?MIVAR NAME=$allele>$3<?/MIVAR>
	<?MIVAR NAME=$person_full_name>$4<?/MIVAR>
	<?MIVAR NAME=$entry_date>$5<?/MIVAR>
	<?MIVAR NAME=$status>$6<?/MIVAR>
	<?MIVAR NAME=$registration_age_days>$7<?/MIVAR>
	<?MIVAR NAME=$locus_zdb_id>$8<?/MIVAR>
	<?MIVAR NAME=$approval_date>$9<?/MIVAR>
	<?MIVAR NAME=$public_date>$13<?/MIVAR>
	<?MIVAR NAME=$expired_date>$10<?/MIVAR>
	<?MIVAR NAME=$pheno_descr>$11<?/MIVAR>
	<?MIVAR NAME=$fish_zdb_id>$12<?/MIVAR>
	<TR>
	  <TD colspan=3>
	    <hr size=3>
	  </TD>
	</TR>

	<TR>
	  <TD>
	    $(IF,$(>,$registration_age_days,183),"<font color='#ff0000'>") 
	    <b>$locus_name</b> ($abbrev<sup>$allele</SUP>)
	    $(IF,$(>,$registration_age_days,183),"</font>")
	  </TD>
	  <TD>
	    $person_full_name
	  </TD>
	  <TD rowspan=3 align=left valign=top>
	    <font size=2>
	    <B>Registered:</b> $entry_date 

	    <br>
	<?MIBLOCK COND="$(NC,$approval_date,$MI_NULL)">
	  <?MIVAR>
	    <B>Nomenclature Approved:</b> $approval_date

	    <BR>
	  <?MIBLOCK COND="$(NC,$public_date,$MI_NULL)">
	    <?MIVAR>
	    <B>Public:</b> $public_date
	    <?/MIVAR>
	  <?MIELSE>
	    <?MIVAR>
	    <B>Deadline:</b> $expired_date
            <br>
	    <B>Make Public:</b> 
	      <input type=checkbox name="make_public" onClick=change_status(this,'$locus_zdb_id','$allele')>
            <br>
	    <B>Extend:</b> 
	      <input type=checkbox name="extend" onClick=change_status(this,'$locus_zdb_id','$allele')>
            <?/MIVAR>
	  <?/MIBLOCK>

          <?/MIVAR>

	<?MIELSE>
	  <?MIVAR>
	    <B>Approve Nomenclature:</B>
            <input type=checkbox name="approve" onClick=change_status(this,'$locus_zdb_id','$allele')>
	  <?/MIVAR>
	<?/MIBLOCK>

	    <BR>
	<?MIVAR COND="$(EC,$public_date,$MI_NULL)">
	    <B>Delete:</b> 
	      <input type=checkbox name=expire onClick=change_status(this,'$locus_zdb_id','$allele')>
	<?/MIVAR>

	    </font>
	  </TD>
	</TR>
	<TR>
	  <TD colspan=2 valign=top>
	    <font size=2>
	    Description:
	    <br><input type=button name=descr value="Update" 
	           onClick="change_descr(document.lociform.SEL$MI_CURRENTROW,'$locus_zdb_id','$allele');">
	    
<TEXTAREA NAME="SEL$MI_CURRENTROW" rows=3 cols=50 wrap=virtual>
$pheno_descr
</TEXTAREA>
	
	    </font>
	  </TD>
	</TR>

      <?/MISQL>
    </TABLE>
  </form>
  <?MIVAR COND="$(=,$MI_ROWCOUNT,0)"> No pending registrations<?/MIVAR>

<?/MIBLOCK>

<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-htmlpagefooter.apg';">
  $1
<?/MISQL>

