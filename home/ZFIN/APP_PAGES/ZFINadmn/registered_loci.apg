<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<!-- Used by root to police pending locus registrations. Root can change 
the status of a registration.  Note that a registration can never be 
deleted, however, because the allele designation is permanently assigned. 
So the possible status states are:
   unreviewed, conditional, expired
PARAMS:
update == optional, if exists then it's the zdb_id of the locus_registration 
          to update.
action == is either 'approve' or 'expire' depending on which action to do.

UPDATE ECK 4/21/99.  Will modify to allow public to see pending 
registrations -- but not update of course.
 -->

<HEAD>

<title>ZFIN Registered Loci</title>

<SCRIPT>
  function change_status(selector,locus_id,the_allele) {
    var theAction=selector.name;
    document.location='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-registered_loci.apg&update='+locus_id+'&allele='+the_allele+'&action='+theAction;
  }

  function change_descr(selector,locus_id,the_allele) {
    var theDescr=escape(selector.value);
    document.location='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-registered_loci.apg&update='+locus_id+'&allele='+the_allele+'&action=descr&description='+theDescr;
  }

 
</SCRIPT>
</HEAD>

<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-htmlpageheader.apg';">
  $1
<?/MISQL>

<?MISQL SQL="
  select WebExplode(object,'page_title=Registered Loci&permission=root') 
    from webPages 
    where ID='aa-secure_navigation.apg';">
  $1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MIBLOCK COND="$(XST,$update)"> 
    <!-- Approve it and insert rudimentary fish record -->
    <?MIBLOCK COND="$(EC,$action,approve)">
      <!-- inserts aren't done in right order.  Rather than take the time to
	-- reorder them, just defer the constraints.
	-- The "set explain off" is required to avoid a bug with the
	-- "set constraints" statement below.  The "set explain" statement was
	-- picked because it was the most innoccuous statement I could think of.
	-->
      <?MISQL SQL="
	set explain off;
	set constraints all deferred;">
      <?/MISQL>
      <?MISQL SQL="
	select zdb_id, locus_name, abbrev, allele, owner, pheno_descr,
	       fish_record 
	  from locus_registration 
	  where zdb_id='$update' and allele='$allele';">
      <?/MISQL>

      <!-- only do it if not yet done! -->
      <?MIBLOCK COND=$(ISNULL,$7)>
	<?MIVAR NAME=$locus_id>$1<?/MIVAR>
	<?MIVAR NAME=$locus_name>$2<?/MIVAR>
	<?MIVAR NAME=$abbrev>$3<?/MIVAR>
	<?MIVAR NAME=$allele>$4<?/MIVAR>
	<?MIVAR NAME=$owner>$5<?/MIVAR>
	<?MIVAR NAME=$descr>$6<?/MIVAR>
	<?MISQL SQL="
	  select target_id, position, labpos_order 
	    from int_person_lab, lab_position 
	    where source_id = '$owner' and position = labpos_position 
	    order by labpos_order;">
	<?/MISQL>
	<?MIVAR NAME=$lab>$1<?/MIVAR>
	<!-- if owner is a member of ZFIN database team do not set ZFIN as lab, set lab to null -->
	<?MIVAR COND="$(OR,$(EC,$lab,ZDB-LAB-000914-1),$(EC,$lab,ZDB-LAB-991005-53))" NAME=$lab><?/MIVAR>
	<?MIVAR NAME=$full_abbrev>$abbrev<sup>$allele</sup><?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('TEMP');">
	<?/MISQL>
	<?MIVAR NAME=$temp_oid>$1<?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('CHROMO');">
	<?/MISQL>
	<?MIVAR NAME=$chromo_id>$1<?/MIVAR>
	<?MISQL SQL="
	  execute function get_id('ALT');">
	<?/MISQL>
	<?MIVAR NAME=$alt_id>$1<?/MIVAR>
	<?MISQL SQL="
	  insert into zdb_active_data
	      ( zactvd_zdb_id )
	    values
	      ( '$temp_oid' );">
	<?/MISQL>
	<?MISQL SQL="
	  insert into temp_fish 
	      (comments, submitter_id, entry_time, zdb_id, locus, allele,
	       chrom_num, phenotype, lab, discoverer, line_type,
	       abbrev, name, chrom_change, mutagen, protocol)
	    values 
	      ('Provisional record for newly registered locus/allele',
	       '$owner', current, '$temp_oid', '$locus_id', '$allele',
	       '0', '$descr', '$lab', '$owner', 'mutant',
	       '$abbrev','$locus_name','UNKNOWN','UNKNOWN','UNKNOWN');">
	<?/MISQL>
	<?MIVAR NAME=$s_done>true<?/MIVAR>
	<?MIVAR NAME=$submitter_id>$owner<?/MIVAR>
	<?MISQL SQL="
	  select WebExplode(object,'') 
	    from webPages 
	    where ID='aa-process-fish.apg';">
	<?/MISQL>
	<?MIVAR NAME=$fish_id>$(REPLACE,$temp_oid,TEMP,FISH)<?/MIVAR>

	<!-- make a locus record if it's new! -->
	<?MISQL SQL="
	  select count(*)::integer 
	    from locus
	    where zdb_id = '$locus_id';">
	<?/MISQL>
	<?MIVAR NAME=$locus_cnt>$1<?/MIVAR>
	<?MIBLOCK COND="$(<,$locus_cnt,1)">
	  <?MISQL SQL="
	    insert into zdb_active_data
		(zactvd_zdb_id)
	      values
		('$locus_id');">
	  <?/MISQL>
	  <?MISQL SQL="
	    insert into locus 
		(zdb_id, locus_name, abbrev, comments, owner) 
	      values 
		('$locus_id', '$locus_name', '$abbrev',
		 'Provisional record for newly registered locus/allele','$owner');">
	  <?/MISQL>
	<?/MIBLOCK>
	<?MISQL SQL="
	  update locus_registration
	    set status = 'conditional', locusreg_approved_date = current,
	        fish_record = '$fish_id' 
	    where zdb_id = '$update' and allele='$allele';">
	<?/MISQL>

      <?/MIBLOCK>
    <?/MIBLOCK> <!-- ends approve actions -->

    <?MISQL COND="$(EC,$action,expire)" SQL="
      update locus_registration 
	set status = 'expired', locusreg_expired_date = current  
	where zdb_id = '$update' and allele='$allele';">
    <?/MISQL>

    <?MIBLOCK COND="$(EC,$action,descr)">
      <?MIVAR NAME=$description DELIMIT="'" REPLACE="''">$description<?/MIVAR>
      <?MISQL SQL="
	update locus_registration
	  set pheno_descr = '$description'
	  where zdb_id = '$update' and allele = '$allele';">
      <?/MISQL>
      <?MISQL SQL="
	select fish_record 
	  from locus_registration 
	  where zdb_id = '$update' and allele='$allele';">
      <?/MISQL>
      <?MIVAR NAME=$fish_rec>$1<?/MIVAR>
      <?MISQL SQL="
	update fish
	  set phenotype = '$description'
	  where zdb_id = '$fish_rec';">
      <?/MISQL>
      <?MISQL SQL="
	update fish_search 
	  set phenotype = '$description'
	  where fish_id = '$fish_rec';">
      <?/MISQL>
    <?/MIBLOCK>

    <?MISQL COND="$(EC,$action,extend)" SQL="
	update locus_registration
	   set expiration_deadline = 
                 expiration_deadline + interval(6) month to month
	 where zdb_id = '$update' and allele='$allele';">
    <?/MISQL>
    

  <?/MIBLOCK>


  <center><font size=4><b>Pending Locus Registrations</b></font></center>
  <p>
  <form name=lociform>
    <?MIVAR NAME=$MI_NULL><?/MIVAR>

    <TABLE width="100%">
      <TH>LOCUS</TH> <TH>OWNER</TH>  <TH align=left>STATUS</TH>
      <?MISQL SQL="
	select locus_name, abbrev, allele, b.full_name, a.entry_time::date,
	       status, a.zdb_id, a.locusreg_approved_date::date,
	       a.expiration_deadline::date, a.locusreg_expired_date::date, pheno_descr,
	       fish_record, a.expiration_deadline::date-a.entry_time::date,
	       current::date-a.entry_time::date  	 
	  from locus_registration a, person b
	  where a.owner = b.zdb_id
	    and (   a.locusreg_approved_date is null
		 or not exists
		      ( select *
			  from record_attribution
			  where recattrib_data_zdb_id = fish_record ) )
	    and a.expiration_deadline > a.entry_time::date
	    order by locus_name;">
	<?MIVAR NAME=$locus_name>$1<?/MIVAR>
	<?MIVAR NAME=$abbrev>$2<?/MIVAR>
	<?MIVAR NAME=$allele>$3<?/MIVAR>
	<?MIVAR NAME=$person_full_name>$4<?/MIVAR>
	<?MIVAR NAME=$entry_date>$5<?/MIVAR>
	<?MIVAR NAME=$status>$6<?/MIVAR>	
	<?MIVAR NAME=$locus_zdb_id>$7<?/MIVAR>
	<?MIVAR NAME=$approval_date>$8<?/MIVAR>
	<?MIVAR NAME=$deadline_date>$9<?/MIVAR>
	<?MIVAR NAME=$expired_date>$10<?/MIVAR>
	<?MIVAR NAME=$pheno_descr>$11<?/MIVAR>
	<?MIVAR NAME=$fish_zdb_id>$12<?/MIVAR>
	<?MIVAR NAME=$valid_days>$13<?/MIVAR>
	<?MIVAR NAME=$registered_days>$14<?/MIVAR>
	<TR>
	  <TD colspan=6>
	    <hr size=3>
	  </TD>
	</TR>

	<TR valign=bottom>
	  <TD>
	    $(IF,$(>,$registered_days,$valid_days),"<font color='#ff0000'>") 
	    <b>$locus_name</b> ($abbrev<sup>$allele</SUP>)
	    $(IF,$(>,$registered_days,$valid_days),"</font>")
	  </TD>
	  <TD>
	    $person_full_name
	  </TD>
	  <TD rowspan=4 align=left valign=top>
	    <font size=2>
	    <B>Registered:</b> $entry_date 
	    <br>
	    <B>Approved:</b> 
	    $(IF,$(NC,$approval_date,$MI_NULL),$approval_date,"<input type=checkbox name=approve onClick=change_status(this,'"$locus_zdb_id"','"$allele"')>")
	    <br>
	    $(IF,$(EC,$expired_date,),"<input type=button name=extend value=Extend onClick=change_status(this,'"$locus_zdb_id"','"$allele"')">)<B>Deadline:</b> $deadline_date
	    <BR>
	    <B>Expired:</b> 
	    $(IF,$(NC,$expired_date,$MI_NULL),$expired_date,"<input type=checkbox name=expire onClick=change_status(this,'"$locus_zdb_id"','"$allele"')>")
	    
	    </font>
	  </TD>
	</TR>
	<TR>
	  <TD colspan=2>
	    <font size=2>
	    FISH record: 
	    $(IF,$(NC,$fish_zdb_id,NULL),<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID="$fish_zdb_id>$fish_zdb_id</A>,"Not yet created")
	    </font>
	  </TD>
	</TR>
	<TR>
	  <TD colspan=2>
	    <font size=2>
	    Description:
<TEXTAREA NAME="SEL$MI_CURRENTROW" rows=5 cols=50 wrap=virtual>
$pheno_descr
</TEXTAREA>
	    <input type=button name=descr value="Update" 
	           onClick="change_descr(document.lociform.SEL$MI_CURRENTROW,'$locus_zdb_id','$allele');">
	    </font>
	  </TD>
	</TR>

      <?/MISQL>
    </TABLE>
  </form>
  <?MIVAR COND="$(=,$MI_ROWCOUNT,0)"> No pending registrations<?/MIVAR>

<?/MIBLOCK>

<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-htmlpagefooter.apg';">
  $1
<?/MISQL>

