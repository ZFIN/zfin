<?MICOMMENT>

FILE:     markerrelationship.apg
PREFIX:   mrkrrel_ 

Display the related segments.   

INPUT VARS:
  mrkrrel_mrkr_zdb_id:  The original marker zdb id
  mrkrrel_rel_direction: The relationship direction, either 1_to_2 or 2_to_1
                         The original marker comes first. 


OUTPUT VARS:
  None.

OUTPUT:
  Each relationship type of the defined direction possesses one row with 
  grey background. Each row contains a column of relationship type 
  and a column of the list of related segments. 

<?/MICOMMENT>


<?MIERROR>
<html>
<script src="/javascript/header.js"></script>
<p>Looks like we are having trouble processing your request. You can...</p>
<ul>
    <li>try reloading the page to see if the problem persists</li>
    <li>head back to the <a href="/">home page</a></li>
    <li>send us an <a href="mailto:zfinadmn@zfin.org">email</a> and tell us about it</li>
</ul>

<?MIBLOCK COND="$(EC,$AUTHORIZED,root)">
    <p class="error">ROOT ONLY DEBUGGING</p>
    <pre><?MIVAR>
SQL:     $MI_SQL
Code:    $MI_ERRORCODE
State:   $MI_ERRORSTATE
Message: $MI_ERRORMSG
<?/MIVAR></pre>
<?/MIBLOCK>
<script src="/javascript/footer.js"></script>
</html>
<?/MIERROR>

<?MIVAR COND="$(NXST,$mrkrrel_mrkr_zdb_id)">
    ERROR: markerrelationship.apg has no mrkrrel_mrkr_zdb_id passed in.
<?/MIVAR>
<?MIVAR COND="$(NXST,$mrkrrel_rel_direction)">
    ERROR: markerrelationship.apg has no mrkrrel_rel_direction passed in.
<?/MIVAR>

<?MISQL SQL="select get_mrkr_abbrev_html(mrkr_zdb_id) 
                    from marker where mrkr_zdb_id = '$mrkrrel_mrkr_zdb_id';">
  <?MIVAR NAME="$mrkrrel_mrkr_abbrev_html">$1<?/MIVAR>
<?/MISQL>

<?MIBLOCK COND="$(EC,$mrkrrel_rel_direction,2_to_1)">
    <?MIVAR NAME=mrkrrel_sql>
	select mrkr_abbrev, mrkr_zdb_id, mrkr_abbrev_order, mrkrtype_type_display, 
	       mrel_zdb_id, mrel_type, mreltype_2_to_1_comments, get_mrkr_abbrev_html_link(mrkr_zdb_id)
 	  from marker_relationship
	       inner join marker_relationship_type
             	  on mrel_type = mreltype_name
               inner join marker
                  on mrel_mrkr_1_zdb_id = mrkr_zdb_id 
	       inner join marker_types
            	  on mrkr_type = marker_type
	 where mrel_mrkr_2_zdb_id = '$mrkrrel_mrkr_zdb_id' 
	   and mrel_type not in ('knockdown reagent targets gene',
					'promoter of',
					'coding sequence of',
					'contains engineered region',
					'gene product recognized by antibody',
                                        'transcript targets gene'
					)
      order by mrel_type, mrkrtype_type_display, mrkr_abbrev_order;
    <?/MIVAR>
<?MIELSE>
    <?MIVAR NAME=mrkrrel_sql>
	select mrkr_abbrev, mrkr_zdb_id, mrkr_abbrev_order, mrkrtype_type_display, 
	       mrel_zdb_id, mrel_type, mreltype_1_to_2_comments, get_mrkr_abbrev_html_link(mrkr_zdb_id)
 	  from marker_relationship 
	       inner join marker_relationship_type
                 on mrel_type = mreltype_name
               inner join marker
                 on mrel_mrkr_2_zdb_id = mrkr_zdb_id 
	       inner join marker_types
                 on mrkr_type = marker_type
	 where mrel_mrkr_1_zdb_id = '$mrkrrel_mrkr_zdb_id' 
	   and mrel_type not in ('knockdown reagent targets gene',
					'promoter of',
					'coding sequence of',
					'contains engineered region',
					'gene product recognized by antibody',
                                        'gene produces transcript',
                                        'transcript targets gene'
					)
      order by mrel_type, mrkrtype_type_display, mrkr_abbrev_order;
    <?/MIVAR>
<?/MIBLOCK>	  	  

<?MIVAR NAME=mrkrrel_last_mrel_type><?/MIVAR>
<?MIVAR NAME=mrkrrel_last_seg_mrkr_type><?/MIVAR>

<?MISQL SQL=" $mrkrrel_sql ">

    <?MIVAR NAME=mrkrrel_seg_mrkr_abbrev>$1<?/MIVAR> 
 	<?MIVAR NAME=mrkrrel_seg_mrkr_zdb_id>$2<?/MIVAR> 
	<?MIVAR NAME=mrkrrel_seg_mrkr_type>$4<?/MIVAR> 
	<?MIVAR NAME=mrkrrel_mrel_zdb_id>$5<?/MIVAR> 
  	<?MIVAR NAME=mrkrrel_mrel_type>$6<?/MIVAR> 
	<?MIVAR NAME=mrkrrel_mrel_comments>$7<?/MIVAR>
    <?MIVAR NAME=mrkrrel_seg_mrkr_link>$8<?/MIVAR>

    <?MIBLOCK COND="$(NC,$mrkrrel_mrel_type,$mrkrrel_last_mrel_type)">
	  <?MIVAR COND="$(NC,$mrkrrel_last_mrel_type,)">
		  </td>
        </tr>
      <?/MIVAR>
	  <tr>
        <th>       			
	      <?MIVAR>$
			$(IF,$(>,$(POSITION,$OID,GENE),0),$mrkrrel_mrkr_abbrev_html,$name)&nbsp;$(REPLACE,$mrkrrel_mrel_comments, ,&nbsp;)
	      <?/MIVAR>
        </th>
  	    <td>
      <?MICOMMENT>for a new mrel_type, reinitiate the seg_mrkr_type<?/MICOMMENT>
	  <?MIVAR>$(SETVAR,$mrkrrel_last_seg_mrkr_type,)<?/MIVAR>
    <?/MIBLOCK>   

    <?MIBLOCK COND="$(NC,$mrkrrel_seg_mrkr_type,$mrkrrel_last_seg_mrkr_type)">
        <?MIVAR COND="$(NC,$mrkrrel_last_seg_mrkr_type,)">
		   <br>
        <?/MIVAR>
        <?MIVAR>
		    <font size=-1>[$mrkrrel_seg_mrkr_type]</font>
		 <?/MIVAR>
    <?MIELSE>,
    <?/MIBLOCK>
  
    <?MIVAR COND="$(XST,$UPDATE)">
       <INPUT TYPE=button value=Delete 
         	  onClick="Delete_mrel('$mrkrrel_seg_mrkr_zdb_id','$mrkrrel_mrel_type')">
    <?/MIVAR>
    <?MIVAR>$mrkrrel_seg_mrkr_link<?/MIVAR>
    <?MISQL SQL="select WebExplode(object,'dataId=$mrkrrel_mrel_zdb_id&type=recattrib&info=standard') from webPages where ID='aa-miniref_display.apg';">$1<?/MISQL>

	<?MISQL SQL="select WebExplode(object,'clorlk_mrkr_zdb_id=$mrkrrel_seg_mrkr_zdb_id') from webPages where ID='aa-cloneorderlink.apg';">$1<?/MISQL>
       

	<?MIVAR>$(SETVAR,$mrkrrel_last_seg_mrkr_type,$mrkrrel_seg_mrkr_type)<?/MIVAR>	
	<?MIVAR>$(SETVAR,$mrkrrel_last_mrel_type,$mrkrrel_mrel_type)<?/MIVAR>	

<?/MISQL>	

  </td>
</tr> <?MICOMMENT> the finishing close tag <?/MICOMMENT>

