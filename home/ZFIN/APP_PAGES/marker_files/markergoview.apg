<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>
</head>
<!--app page to enter gene ontology info-->
<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>

<?MIERROR>
  <?MIVAR COND=$(XST,$MI_SQL)>
    SQL: $MI_SQL<br><br>
  <?/MIVAR>

  Code:    $MI_ERRORCODE <br>
  State:   $MI_ERRORSTATE <br>
  Message: $MI_ERRORMSG <br>

<?/MIERROR>
<?MIVAR name=$highlight><!--|HIGHLIGHT_COLOR|--><?/MIVAR>  
<?MIVAR name=$highlighter><!--|HIGHLIGHTER_COLOR|--><?/MIVAR>
<?MIVAR name=$white>#ffffff<?/MIVAR>
<?MIVAR NAME=$MI_NOVALUE><?/MIVAR>
<?MIVAR NAME=$MI_NULL><?/MIVAR>
<?MIVAR NAME=qualifier>false<?/MIVAR>
<?MIBLOCK COND="$(NXST,$OID)">
  <p>
  ERROR -- something bad happened -- no OID passed in!
<?/MIBLOCK>

 
<?MISQL COND="$(NXST,$UPDATE)" SQL="select WebExplode(object,'') from webPages where ID='aa-secure_navigation.apg';">$1
<?/MISQL>

<?MISQL COND="$(XST,$UPDATE)" SQL="select WebExplode(object,'permission=owns&rtype=marker') from webPages where ID='aa-secure_navigation.apg';">$1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

<?MISQL SQL="select mrkr_zdb_id from marker where mrkr_zdb_id='$OID'"><?/MISQL>
<?MIVAR NAME=$geneid>$1<?/MIVAR>
<?mivar name=$caller>$(SUBSTR,$OID,5,3)<?/mivar>
<?MISQL SQL="select mrkr_abbrev,mrkr_name from marker where mrkr_zdb_id='$OID'"><?/MISQL>
<?MIVAR NAME=$gene>$1<?/MIVAR>
<?MIVAR NAME=$name>$2<?/MIVAR>

<head>
<title>ZFIN: GO Details: <?MIVAR> $gene <?/MIVAR>
</title>
</head>

<?MIBLOCK COND="$(XST,$OID)">
 <?MIBLOCK COND="$(NC,PUB,$caller)">
     <?MISQL COND="$(NXST,$UPDATE)" SQL="select WebExplode(object,'rtype=go') from webpages where ID='aa-data_mgr.apg';">$1<?/MISQL>

<?MIVAR name=left_tab>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?/MIVAR>
    <TABLE width=100%>
      <TR bgcolor=#cccccc>
        <TD>
          <FONT SIZE=+1><b>GO Details</b></FONT>
        </TD>
      </TR>
    </TABLE>
<?MIVAR NAME=link_backto_OID><a href="/action/marker/view/$OID"><i>$gene</i></a><?/MIVAR>
<!------------- Title display------------>
    <table border=0 width=100%>
      <tr>
        <td>
          <font><b>
          <?MIVAR>
              Gene Name: <i>$name</i><br>
              Gene Symbol: $link_backto_OID

          <?/MIVAR>
          </b></font>
        </td>
        <td>
          <?MIBLOCK COND="$(NXST,$UPDATE)">
            <table width="15%" align=right>
             <tr>
               <?MIVAR>
                 <?MISQL SQL="select WebExplode(object,'subject=$gene') from webPages where ID='aa-input_button_generic.apg';">$1<?/MISQL>
               <?/MIVAR>
              </tr>
             </table>
          <?/MIBLOCK>
        </td>
      </tr>
    </table>

<p>
<p>
<p>
 <?MISQL SQL="select fdb_db_query from foreign_db where fdb_db_name='QuickGO'"><?/MISQL>
   <?MIVAR NAME=$dbquery>$1<?/MIVAR>
 
<?MISQL SQL="select mrkrgoev_zdb_id from marker_go_term_evidence where mrkrgoev_mrkr_zdb_id='$OID'">

<?MIVAR NAME=qualifier>false<?/MIVAR>
<?MISQL SQL="
select ev.mrkrgoev_gflag_name from marker_go_term_evidence ev 
where ev.mrkrgoev_mrkr_zdb_id='$OID' and ev.mrkrgoev_gflag_name is not null
;">
        <?MIVAR NAME=qualifier>true<?/MIVAR>
  <?/MISQL>
 
<?/MISQL>

<!--creating table to display added GO annotations-->
<p><p>

  <table class="summary rowstripes">
  <tr bgcolor=#cccccc height=25><th><b>Ontology</b></th>
  <?MIVAR COND="$(EC,$qualifier,true)">
	<th><b>Qualifier</b></th>
  <?/MIVAR>
  <th nowrap><b>GO Term</b></th>
  <th><b>Evidence</b></th>
  <th nowrap><b>Inferred From</b></th>
  <th><b>Reference(s)</b></th>

  <?MIVAR name=$row_color>$white<?/MIVAR>

  <?MIVAR NAME=lastonto><?/MIVAR>
  <?MIVAR NAME=lastgoterm><?/MIVAR>
  <?MIVAR NAME=lastevidence><?/MIVAR>
  <?MIVAR NAME=lastflag><?/MIVAR>
  <?MIVAR NAME=lasthasinf><?/MIVAR>
  <?MIVAR NAME=lastinfername><?/MIVAR>
  <?MIVAR NAME=infername><?/MIVAR>

<?MISQL SQL="
      select distinct
g.gont_ontology_name,
t.term_name,
ev.mrkrgoev_evidence_code,
g.gont_order,
t.term_ont_id,
ev.mrkrgoev_term_zdb_id,
ev.mrkrgoev_zdb_id,
ev.mrkrgoev_source_zdb_id,
ev.mrkrgoev_notes,
ev.mrkrgoev_gflag_name,
ev.mrkrgoev_annotation_organization_created_by,
org.mrkrgoevcb_name,
org.mrkrgoevcb_url,
get_entity_name_html(t.term_zdb_id),
infgrmem_inferred_from
from term t
join marker_go_term_evidence ev on t.term_zdb_id=ev.mrkrgoev_term_zdb_id
join go_ontology g on t.term_ontology=g.gont_ontology_internal_name
left join marker_go_term_evidence_annotation_created_by_source org on ev.mrkrgoev_annotation_organization_created_by=org.mrkrgoevcb_name 
left join inference_group_member on infgrmem_mrkrgoev_zdb_id = mrkrgoev_zdb_id
where ev.mrkrgoev_mrkr_zdb_id='$OID'
order by g.gont_order,ev.mrkrgoev_evidence_code,t.term_name, ev.mrkrgoev_gflag_name, infgrmem_inferred_from desc
      ; ">

   <?MIVAR NAME=$ontology>$1<?/MIVAR>
   <?MIVAR NAME=$goterm>$2<?/MIVAR>
   <?MIVAR NAME=$evidence>$(TRIM,$3)<?/MIVAR>
   <?MIVAR NAME=$goid>$5<?/MIVAR>
   <?MIVAR NAME=$gozdbid>$6<?/MIVAR>
   <?MIVAR NAME=$markergoevid>$7<?/MIVAR>
   <?MIVAR NAME=$sourcezdbid>$8<?/MIVAR>
   <?MIVAR NAME=$markergonotes>$9<?/MIVAR>
   <?MIVAR NAME=$flag>$10<?/MIVAR>
   <?MIVAR NAME="organization">$11<?/MIVAR>
   <?MIVAR NAME="organization_name">$12<?/MIVAR>
   <?MIVAR NAME="organization_url">$13<?/MIVAR>
   <?MIVAR NAME="$goterm_link">$14<?/MIVAR>
   <?MIVAR NAME="db_inf_name">$15<?/MIVAR>
   <?MIVAR NAME=isnot>f<?/MIVAR>
   <?MIVAR NAME=contribs>f<?/MIVAR>
   <?MIVAR NAME=colocalizeswith>f<?/MIVAR>
   <?MIVAR COND="$(EC,$flag,not)" NAME=$isnot>t<?/MIVAR>
   <?MIVAR COND="$(EC,$flag,contributes to)" NAME=$contribs>t<?/MIVAR>
   <?MIVAR COND="$(EC,$flag,colocalizes with)" NAME=$colocalizeswith>t<?/MIVAR>
   <?MIBLOCK COND="$(EC,$isnot,t)">
 	 <?MIVAR NAME=not>NOT<?/MIVAR>
   <?MIELSE>
  	<?MIVAR NAME=not><?/MIVAR>
   <?/MIBLOCK>
   <?MIVAR NAME=has_inf>f<?/MIVAR>
   <?MIVAR NAME="infername"><?/MIVAR>
   <?MISQL SQL="select * from inference_group_member where infgrmem_mrkrgoev_zdb_id = '$markergoevid'">
   <?MIVAR NAME=infername>$(CONCAT,$infername,$1)<?/MIVAR>
   <?/MISQL>
   <?MIVAR COND="$(>,$MI_ROWCOUNT,0)" NAME=has_inf>t<?/MIVAR>
   <?MIBLOCK COND=$(XST,debug)">
       <?MIVAR>
           <tr style="background-color: #ffeeff">
               <td>ontology: $lastonto != $ontology</td>
               <td>goterm: $lastgoterm != $goterm</td>
               <td>evidence: $lastevidence != $evidence</td>
               <td>flag: $lastflag != $flag</td>
               <td>infername: $lastinfername != $infername</td>
           </tr>
       <?/MIVAR>
   <?/MIBLOCK>
   <!--now displaying annotations-->
   <?MIBLOCK COND="$(OR,$(NC,$ontology,$lastonto),$(NC,$lastgoterm,$goterm),$(NC,$lastevidence,$evidence),$(NE,$flag,$lastflag),$(NE,$infername,$lastinfername))">
     <tr <?MIVAR>$(IF,$(AND,$(NC,$lastonto,),$(NC,$ontology,$lastonto)),class="newgroup")<?/MIVAR>  bgcolor=<?MIVAR>$row_color<?/MIVAR> height=25>

     <?MIVAR>
     <td>$(IF,$(NC,$ontology,$lastonto),$ontology)
    </td> 
    <?MIBLOCK COND="$(EC,$qualifier,true)">
     <td nowrap>
     <i>
       <?MIVAR COND="$(EC,$contribs,t)">
        Contributes to
        <?/MIVAR>
       <?MIVAR COND="$(EC,$colocalizeswith,t)">
        Colocalizes with
        <?/MIVAR>
       <?MIVAR COND="$(EC,$isnot,t)">
        NOT
        <?/MIVAR>
     </i>
     </td>
     <?/MIBLOCK>
     <td>$goterm_link</TD>
     <td nowrap><A HREF="http://www.geneontology.org/GO.evidence.shtml#$(LOWER,$evidence)">$evidence</A></TD>

     <?MIVAR NAME=currinfs><?/MIVAR>
     <?MIVAR NAME=$infs><?/MIVAR>
     <?MISQL SQL="select infgrmem_inferred_from from inference_group_member where infgrmem_mrkrgoev_zdb_id='$markergoevid'"><?/MISQL>
     <?MIVAR NAME=$infcount>$MI_ROWCOUNT<?/MIVAR>
     <?MISQL SQL="select infgrmem_inferred_from 
		    from inference_group_member 
		   where infgrmem_mrkrgoev_zdb_id='$markergoevid'">
        <?MIVAR NAME=$infername_inner>$1<?/MIVAR>
     	<?MIVAR NAME=$colon>:<?/MIVAR>
     	<?MIVAR NAME=$comma>,<?/MIVAR>
     	<?MIVAR NAME=$pos>$(POSITION,$infername_inner,$colon)<?/MIVAR>
     	<?MIVAR NAME=$posn>$(-,$pos,1)<?/MIVAR>
     	<?MIVAR NAME=$dbase>$(SUBSTR,$infername_inner,1,$posn)<?/MIVAR>
     	<?MIVAR NAME=$currinflength>$(STRLEN,$infername_inner)<?/MIVAR>
     	<?MIVAR NAME=$position>$(+,$pos,1)<?/MIVAR>
     	<?MIVAR NAME=$accID>$(SUBSTR,$infername_inner,$position,$currinflength)<?/MIVAR>

     	<?MIBLOCK COND="$(EC,$dbase,ZFIN)">
	   <?MIVAR NAME=inf_mem_sym><?/MIVAR>
	   <?MISQL COND="$(>,$(POSITION,$accID,GENO),0)" SQL="
		select geno_display_name
		  from genotype
	 where geno_zdb_id = '$accID'">
      <?MIVAR NAME=inf_mem_sym><i>$1</i><?/MIVAR>	
   <?/MISQL>
   <?MISQL COND="$(=,$(POSITION,$accID,GENO),0)" 
	   SQL="
	select mrkr_abbrev,mrkr_type
	  from marker
	 where mrkr_zdb_id = '$accID'">
      <?MIBLOCK COND="$(EQ,$2,GENE)">
      <?MIVAR NAME=inf_mem_sym><i>$1</i><?/MIVAR>	
      <?MIELSE>
      <?MIVAR NAME=inf_mem_sym>$1<?/MIVAR>	
       <?/MIBLOCK>
   <?/MISQL>
      <?MIVAR NAME=inf_mem_sym>$inf_mem_sym<?/MIVAR>	
<?MIBLOCK COND="$(>,$(POSITION,$accID,GENO),0)">
   <?MIVAR NAME=$currinflink><a href="/<!--|CGI_BIN_DIR_NAME|-->/ZFIN_jump?record=$accID">$inf_mem_sym</a>
<a class="popup-link data-popup-link" href="/action/genotype/genotype-detail-popup?zdbID=$<?MIVAR>$accID<?/MIVAR>"</a><?/MIVAR>

<?MIELSE>
   <?MIVAR NAME=$currinflink><a href="/<!--|CGI_BIN_DIR_NAME|-->/ZFIN_jump?record=$accID">$inf_mem_sym</a><?/MIVAR>
<?/MIBLOCK>
    	<?MIELSE COND="$(EC,$dbase,GO)">
              <?MISQL SQL="select get_entity_name_html(t.term_zdb_id) from term t where t.term_ont_id = 'GO:$accID';"><?/MISQL>
              <?MIVAR NAME=$currinflink>$1<?/MIVAR>
        <?MIELSE>
          <?MISQL SQL="select a.fdb_db_query from foreign_db a where a.fdb_db_name='$dbase'"><?/MISQL>
          <?MIVAR NAME=query>$1<?/MIVAR>

          <?MIVAR NAME=$link>$query$accID<?/MIVAR>
          <?MIVAR NAME=$currinflink><a href=$link>$dbase:$accID</a><?/MIVAR>
       <?/MIBLOCK>
 
       <?MIVAR NAME=infs>$(IF,$(>,$infcount,1),$currinflink<br>$infs,$(TRIM,$infs)$currinflink)<?/MIVAR>
    <?/MISQL>
    <td nowrap><?MIVAR>$infs<?/MIVAR> </td>

    <?MIVAR NAME=pubcount>1<?/MIVAR>
    <?MICOMMENT>in case this annotation has no qualifier and inference group,
		we check to see if other annotation with the same marker, goterm, evidence
		has qualifier or inference group. if both no, group the publication
    <?/MICOMMENT> 
    <?MIBLOCK COND="$(AND,$(EC,$flag,),$(EC,$has_inf,f))"> 
       <?MISQL SQL="select * 
		   from marker_go_term_evidence
     		  where mrkrgoev_evidence_code='$evidence' 
		    and mrkrgoev_mrkr_zdb_id='$OID'
		    and mrkrgoev_term_zdb_id ='$gozdbid'
		    and mrkrgoev_zdb_id <> '$markergoevid'
            and exists (
                select 'x' from inference_group_member
                 where mrkrgoev_zdb_id = infgrmem_mrkrgoev_zdb_id 
                and infgrmem_mrkrgoev_zdb_id='$markergoevid'
                )
            ;"> ;
       <?/MISQL>
       <?MISQL COND="$(=,$MI_ROWCOUNT,0)" SQL="
		 select count(distinct mrkrgoev_source_zdb_id) 
		   from marker_go_term_evidence
		  where mrkrgoev_evidence_code='$evidence' 
		    and mrkrgoev_mrkr_zdb_id='$OID'
		    and mrkrgoev_term_zdb_id ='$gozdbid'
            and mrkrgoev_zdb_id not in (
                   select infgrmem_mrkrgoev_zdb_id 
                   from inference_group_member 
               where mrkrgoev_zdb_id=infgrmem_mrkrgoev_zdb_id
            )
    ;
    ">
             <?MIVAR NAME=pubcount>$(FIX,$1)<?/MIVAR>
    	<?/MISQL>
     <?/MIBLOCK>  


<?MICOMMENT> we need to count publications based on whethere inference and modifiers are present..the following blocks calculate pubs for the following conditions: (inference and flags are stored in 2 different tables)
  flag present, no inference
  flag present, has inference
  no flag, has inference
  has flag, has inference

<?/MICOMMENT>
 
<?MICOMMENT>no inference and inference condition block<?/MICOMMENT>  
 <?MIBLOCK COND="$(EQ,$has_inf,f)">
   <?MISQL SQL="
		 select count(distinct mrkrgoev_source_zdb_id) 
		   from marker_go_term_evidence
		  where mrkrgoev_evidence_code='$evidence' 
		    and mrkrgoev_mrkr_zdb_id='$OID'
		    and mrkrgoev_term_zdb_id ='$gozdbid'
             and mrkrgoev_Zdb_id not in 
             (
              select infgrmem_mrkrgoev_zdb_id 
              from inference_group_member 
             where mrkrgoev_zdb_id=infgrmem_mrkrgoev_zdb_id
             );">

             <?MIVAR NAME=pubcount>$(FIX,$1)<?/MIVAR>
  <?/MISQL>
 <?MIELSE>
  <?MISQL SQL="
		 select count(distinct mrkrgoev_source_zdb_id) 
		   from marker_go_term_evidence
		  where mrkrgoev_evidence_code='$evidence' 
		    and mrkrgoev_mrkr_zdb_id='$OID'
		    and mrkrgoev_term_zdb_id ='$gozdbid'
            and mrkrgoev_zdb_id in 
            (
             select distinct infgrmem_mrkrgoev_zdb_id 
             from inference_group_member 
             where mrkrgoev_zdb_id=infgrmem_mrkrgoev_zdb_id 
             and infgrmem_inferred_from='$infername'
             ) 
             ;
    ">
             <?MIVAR NAME=pubcount>$(FIX,$1)<?/MIVAR>
 <?/MISQL>
<?/MIBLOCK>  

<td align=center>
<?MIBLOCK COND="$(EC,$pubcount,1)">
      <a href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-pubview2.apg&OID=<?MIVAR>$sourcezdbid<?/MIVAR>"><?MIVAR>$pubcount<?/MIVAR></a>
<?MIELSE>
       <?MIVAR NAME=$titleexp>Gene Ontology Pubs<?/MIVAR>
       <?MIVAR NAME=$name><?/MIVAR>
       <?MIVAR>
         <a href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-showpubs.apg&OID=$OID&rtype=goview&title=$(URLENCODE,$titleexp)&name=$(URLENCODE,$name)&goterm=$gozdbid&evidence=$evidence&goflag=$flag&infer=$has_inf&total_count=$pubcount&inf=$infername"><?MIVAR>$pubcount<?/MIVAR></a><?/MIVAR>
<?/MIBLOCK>
<?MIBLOCK COND="$(AND,$(EC,$AUTHORIZED,root),$(NE,$organization,ZFIN))">
    <?MIBLOCK COND="$(AND,$(NE,$organization_url,),$(NE,$organization,ZFIN))">
    <?MIVAR>
    <a style="font-size: small;" href="$organization_url">$organization_name</a>
    <?/MIVAR>
    <?MIELSE COND="$(AND,$(EQ,$organization_url,),$(NE,$organization,ZFIN))">
    <?MIVAR>
    <span  style="font-size: small;">$organization</span>
    <?/MIVAR>
    <?/MIBLOCK>
<?/MIBLOCK>
</td>

</tr>

    <?MIVAR NAME=$row_color>$(IF,$(EC,$row_color,$highlighter),$white,$highlighter)<?/MIVAR>
  
  $(SETVAR,$lastonto,$ontology)
  $(SETVAR,$lastgoterm,$goterm)
  $(SETVAR,$lastevidence,$evidence)
  $(SETVAR,$lastflag,$flag)
  $(SETVAR,$lasthasinf,$has_inf)
  $(SETVAR,$lastinfername,$infername)
 <?/MIVAR> 
 <?/MIBLOCK>
<?/MISQL>
</table>
<hr>
<p>
<?/MIBLOCK>
<?/MIBLOCK> <?MICOMMENT>-- end of OID check--<?/MICOMMENT>
<?/MIBLOCK> <?MICOMMENT>-- end of AUTHORIZED check--<?/MICOMMENT>

<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>
