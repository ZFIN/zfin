<!-- FILE: MAPPINGDETAIL.HTML. This file implements mapping details for MARKER records.
-->

<?MIVAR COND="$(NXST,$mapdetails_mode)" NAME=$mapdetails_mode>standalone<?/MIVAR>
<?MIERROR>
  <?MIVAR COND=$(XST,$MI_SQL)>
    SQL: $MI_SQL<br><br>
  <?/MIVAR>

  Code:    $MI_ERRORCODE <br>
  State:   $MI_ERRORSTATE <br>
  Message: $MI_ERRORMSG <br>

<?/MIERROR>

<!--------- start mini mode ------------------------>
<!---- mini mode use $oID instead of $OID to avoid changing the value of
  $OID unexpectedly when doing webexplode of mini mode within the same page.
---->  

<?MIBLOCK COND="$(EC,$mapdetails_mode,mini)">

<?MIVAR COND="$(NXST,$split)" NAME=$split>&nbsp;<?/MIVAR>
<?MIVAR COND="$(NXST,$hide_empty)" NAME=$hide_empty>f<?/MIVAR>

<?MIVAR COND="$(EC,$split,space)" NAME=$split>&nbsp;<?/MIVAR>
<?MIVAR COND="$(EC,$split,break)" NAME=$split><br><?/MIVAR>

<?MIVAR COND="$(NXST,$oID)">No ZDB-ID Passed In!<?/MIVAR>
<?MIVAR NAME=viewmap><?/MIVAR>
<?MISQL SQL="
	SELECT or_lg
	FROM mapped_marker
	WHERE marker_id = '$oID';">
   $(SETVAR,$viewmap,t)
<?/MISQL>

<?MICOMMENT>when lg information is not yet known<?/MICOMMENT>
<?MIBLOCK COND="$(NXST,$lg_list)">
 <?MIVAR NAME=$GNID>$oID<?/MIVAR> 
 <?MIVAR NAME=$LID>$oID<?/MIVAR> 
   <?MISQL COND="$(>,$(POSITION,$oID,GENE),0)" SQL="
	select zdb_id
	  from locus
	 where cloned_gene = '$oID'
	; ">
      <?MIVAR>$(SETVAR,$LID,$1)<?/MIVAR>
   <?/MISQL>

   <?MISQL COND="$(>,$(POSITION,$oID,LOCUS),0)" SQL="
	select cloned_gene
	  from locus
	 where zdb_id = '$oID'; ">
	<?MIVAR>$(SETVAR,$GNID,$1)<?/MIVAR>
   <?/MISQL>
   <?MISQL COND="$(>,$(POSITION,$oID,FISH),0)" SQL="
	select l.zdb_id, cloned_gene
	  from locus l, fish f
	 where f.zdb_id = '$oID'
	   and l.zdb_id = f.locus	
	; ">
	<?MIVAR>$(SETVAR,$LID,$1)<?/MIVAR>
	<?MIVAR>$(SETVAR,$GNID,$2)<?/MIVAR>
   <?/MISQL>

  <?MIVAR NAME=$last><?/MIVAR>
  <?MISQL SQL="
	SELECT or_lg
	FROM mapped_marker
	WHERE marker_id = '$oID'
	   OR marker_id = '$LID'
           OR marker_id = '$GNID'
         
      UNION 
	SELECT or_lg
	FROM mapped_marker, fish f
	WHERE marker_id = f.zdb_id
	  AND f.locus = '$LID'
         
      UNION 
	SELECT or_lg
	FROM mapped_marker, marker_relationship
	WHERE marker_id = mrel_mrkr_2_zdb_id
	  and mrel_mrkr_1_zdb_id = '$GNID'
          and mrel_type in ('clone contains gene',
			    'clone contains small segment',
			    'gene encodes small segment')
          
      UNION 
	SELECT or_lg
	FROM mapped_marker, marker_relationship
	WHERE marker_id = mrel_mrkr_1_zdb_id
	  and mrel_mrkr_2_zdb_id = '$GNID'
          and mrel_type in ('clone contains gene',
			    'clone contains small segment')
	  
      UNION
	SELECT lnkg_or_lg
	FROM linkage, linkage_member
	WHERE (lnkgmem_member_zdb_id = '$oID'
	   or lnkgmem_member_zdb_id = '$LID'
           or lnkgmem_member_zdb_id = '$GNID')
	  and lnkg_zdb_id = lnkgmem_linkage_zdb_id
	  
      UNION 
	SELECT lnkg_or_lg
	FROM linkage, linkage_member, fish f
	WHERE lnkgmem_member_zdb_id = f.zdb_id
          and f.locus = '$LID'
	  and lnkg_zdb_id = lnkgmem_linkage_zdb_id
	 
      UNION 
	SELECT lnkg_or_lg
	FROM linkage, linkage_member, marker_relationship
	WHERE lnkgmem_member_zdb_id = mrel_mrkr_2_zdb_id
	  and mrel_mrkr_1_zdb_id = '$GNID'
	  and mrel_type in ('gene encodes small segment',
			    'clone contains gene',
			    'clone contains small segment')
	  and lnkgmem_linkage_zdb_id = lnkg_zdb_id

      UNION 
	SELECT lnkg_or_lg
	FROM linkage, linkage_member, marker_relationship
	WHERE lnkgmem_member_zdb_id = mrel_mrkr_1_zdb_id
	  and mrel_mrkr_2_zdb_id = '$GNID'
	  and mrel_type in ('clone contains gene',
			    'clone contains small segment')
	  and lnkgmem_linkage_zdb_id = lnkg_zdb_id 
	order by 1
      ;">
     <?MICOMMENT>*** 07/28/03 we decided to show LG Unknown when LG is 0. If we have other evidence of LG not 0, only the non 0 will be shown in mini mode, but more in mapping detail page.<?/MICOMMENT>
    
     <?MIVAR COND="$(EC,$MI_CURRENTROW,1)">
	LG:
     <?/MIVAR>
     <?MIVAR COND="$(AND,$(>,$MI_CURRENTROW,1),$(NC,$last,0),$(NC,$1,$last))">,<?/MIVAR>
     <?MIVAR COND="$(AND,$(NC,$1,0),$(NC,$1,$last))">
	&nbsp;$1
     <?/MIVAR>
     <?MIVAR NAME=$last>$1<?/MIVAR>
  <?/MISQL>
  <?MIVAR NAME=$the_lg>$1<?/MIVAR>
  <?MIVAR NAME=$map_count>$MI_ROWCOUNT<?/MIVAR>

  <?MICOMMENT>check for mapped_deletion on deficiency allele<?/MICOMMENT>
  <?MIVAR NAME=deficiency_info>f<?/MIVAR> 
  <?MISQL COND="$(>,$(POSITION,$oID,FISH),0)" SQL="
	select * from mapped_deletion m, fish f
		where f.allele = m.allele
                  and f.zdb_id = '$oID' ">
  <?/MISQL>
  <?MIVAR COND="$(>,$MI_ROWCOUNT,0)" NAME=deficiency_info>t<?/MIVAR> 
  <?MISQL COND="$(>,$(POSITION,$oID,LOCUS),0)" SQL="
	select * from mapped_deletion m, fish f
		where f.allele = m.allele
		  and f.locus  = '$oID' ">
  <?/MISQL>
  <?MIVAR COND="$(>,$MI_ROWCOUNT,0)" NAME=deficiency_info>t<?/MIVAR> 

  <?MIVAR COND="$(EC,$last,0)">&nbsp;<font size=-1>Unknown</font><?/MIVAR>
  <?MIBLOCK COND="$(AND,$(=,$map_count,1),$(NC,$the_lg,MT),$(NC,$the_lg,0))">
    <?MIVAR COND="$(<,$the_lg,10)">&nbsp;<?/MIVAR>
  <?/MIBLOCK>	
  <?MIBLOCK COND="$(AND,$(EC,$hide_empty,f),$(=,$map_count,0),$(EC,$deficiency_info,f))">
    None submitted.
    <?MIVAR COND="$(AND,$(XST,$UPDATE),$(>,$(POSITION,$oID,FISH),0))">
      <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-mappingdetail.apg&OID=$oID&UPDATE=1">Update on Detail page</A>
    <?/MIVAR>
  <?/MIBLOCK>
   
<?MIELSE><?MICOMMENT>need modification here<?/MICOMMENT>
  <?MIVAR>LG:&nbsp;$lg_list<?/MIVAR>
   
<?/MIBLOCK>

<?MIBLOCK COND="$(OR,$(XST,$lg_list),$(>,$map_count,0),$(EC,$deficiency_info,t))">
 
 <?MIVAR>&nbsp;<A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-mappingdetail.apg&OID=$oID">Details</A><?/MIVAR>

<!-- mini mode section is exploded from both mapping details page and geneselect page, the column open and close need to be handled differently, use the $split functionality to determine which was the calling routine and add appropriate td's -->
    <?MIVAR COND="$(EC,$viewmap,t)">
	$(IF,$(EC,$split,&nbsp;),</td><td>)
	   $split View Map:
  	   
	   	<?MIVAR NAME=$vmpanels><?/MIVAR>
		<?MISQL SQL="select abbrev, disp_order from panels order by disp_order;">
		 <?MIVAR NAME=$vmpanels>$vmpanels&$1=1<?/MIVAR>
		<?/MISQL>
	      <A HREF="/<!--|CGI_BIN_DIR_NAME|-->/view_zmapplet.cgi?&userid=$userid&OID=$oID&view_map=view_map$vmpanels">Merged</A>&nbsp;
	      <A HREF="/<!--|CGI_BIN_DIR_NAME|-->/view_mapplet.cgi?&userid=$userid&OID=$oID&view_map=view_map$vmpanels">Individual Panels</A>
	  
   	$(IF,$(EC,$split,&nbsp;),</td>)
  <?/MIVAR>
 
<?/MIBLOCK>

<!-------------- end mini mode --------------->




<!-------------- start standalone mode ----------->

<?MIELSE COND="$(EC,$mapdetails_mode,standalone)">
<HTML>
<head>

<SCRIPT>
<?MIVAR>
function call_mapplet() {

	document.mapper.submit();
}

function call_zmapplet() {
	document.mapper.action='/<!--|CGI_BIN_DIR_NAME|-->/view_zmapplet.cgi';
	document.mapper.submit();
}

function edit_linkage(link_id,oid) {
	window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-edit_linkage.apg&link_id='+link_id+'&OID='+oid)
}

<?/MIVAR>

</SCRIPT>

<SCRIPT>

function info() {
 	 window.alert('ANONYMOUS LINKAGE:\n This linkage has not been published yet. ZFIN supports anonymous linkages to promote scientific \ncollaboration; you should contact the submitter of this mapping data (just click the link) \nto negotiate access to this information.');
}

//  initialize view_mapplet parameters   
	

marker = '';

</SCRIPT>
</HEAD>


<basefont size=2>

<?MIVAR COND="$(AND,$(NXST,$OID),$(XST,$temp_oid))" NAME=$OID>$temp_oid<?/MIVAR>
<?MIBLOCK COND="$(NXST,$OID)">
  <p>
  ERROR -- something bad happened -- no OID passed in!
<?/MIBLOCK>

<?MIVAR NAME=$MI_NOVALUE><?/MIVAR>
<?MIVAR NAME=$MI_NULL><?/MIVAR>
<?MIVAR COND="$(NXST,$distance)" NAME=$distance><?/MIVAR>
<?MIVAR COND="$(NXST,$lod)" NAME=$lod><?/MIVAR>
<?MIVAR COND="$(NXST,$metric)" NAME=$metric><?/MIVAR>

<?MIVAR NAME=$userid>GUEST<?/MIVAR>
<?MISQL SQL="select object from webPages where ID='aa-chromoscripts.apg';">$1
<?/MISQL>

<?MIVAR NAME=$target_table>marker<?/MIVAR>
<?MIVAR NAME=$target_table COND="$(>,$(POSITION,$OID,FISH),0)">fish<?/MIVAR>
<?MIVAR NAME=$target_table COND="$(>,$(POSITION,$OID,LOCUS),0)">locus<?/MIVAR> 


<?MISQL COND="$(NXST,$UPDATE)" SQL="select WebExplode(object,'page_title=View mapping detail') from webPages where ID='aa-secure_navigation.apg';">$1
<?/MISQL>

     <!---- If updating, only let owner update anything -->
 <?MISQL COND="$(XST,$UPDATE)" SQL="select WebExplode(object,'page_title=Update mappingdetail&permission=owns&rtype=$target_table') from webPages where ID='aa-secure_navigation.apg';">$1
 <?/MISQL>
     
<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

   <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1
   <?/MISQL>

   <!-- FIRST THROW UP THE ZDB DATA MANAGER FOR THE RECORD -->

   <?MISQL COND="$(NXST,$UPDATE)" SQL="select WebExplode(object,'rtype=$target_table') from webPages where ID='aa-data_mgr.apg';">$1
   <?/MISQL>

 <?MIVAR COND="$(XST,$UPDATE)">
   <form>
   <center><font size=+2><input type=button 
	value=" DONE UPDATING. Back to Viewing! " onClick="document.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-mappingdetail.apg&OID=$OID')">         </font></center>
   </form> 
 <?/MIVAR>
  
   
  <!--------------Convert to gene Id, if exist ------------------------------>
 
  <?MIVAR NAME=$MID>$OID<?/MIVAR>

  <?MISQL COND="$(>,$(POSITION,$OID,FISH),0)" SQL="
	select l.zdb_id
	  from locus l, fish f
	 where f.zdb_id = '$OID'
	   and l.zdb_id = f.locus          
	; ">
     <?MIVAR COND="$(NC,$1,)">$(SETVAR,$OID,$1)<?/MIVAR>
  <?/MISQL>

  <?MISQL COND="$(>,$(POSITION,$OID,LOCUS),0)" SQL="
	select cloned_gene
	  from locus
	 where zdb_id = '$OID'
              ; ">
	<?MIVAR COND="$(NC,$1,)">$(SETVAR,$OID,$1)<?/MIVAR>
   <?/MISQL>

   <?MISQL SQL="
	select mrkr_name, mrkr_abbrev, mrkr_type, mrkrtype_type_display
          from marker, marker_types
         where mrkr_zdb_id = '$OID'
	   and mrkr_type = marker_type
	  ; ">
     <?MIVAR NAME=mrkr_name>$1<?/MIVAR>
     <?MIVAR NAME=mrkr_abbrev>$2<?/MIVAR>
     <?MIVAR NAME=marker_type>$3<?/MIVAR>
     <?MIVAR NAME=marker_type_display>$4<?/MIVAR>
   <?/MISQL>

  <!---------------Mapping detail title--------------------------------------->

  <?MIVAR name=$highlight><!--|HIGHLIGHT_COLOR|--><?/MIVAR>
  <TABLE width="100%" cellspacing=0 border=0>

  <?MICOMMENT>get the original abbreviation or name for the title display<?/MICOMMENT>
  <?MIVAR COND="$(XST,$mrkr_abbrev)" NAME=$reserved_mrkr_abbrev>$mrkr_abbrev<?/MIVAR>
  <?MISQL COND="$(>,$(POSITION,$MID,FISH),0)" SQL="
		select abbrev, line_type, allele
		  from fish
		where zdb_id = '$MID';">
	<?MIVAR NAME=mrkr_abbrev>$(IF,$(NC,$2,wild type),$3,$1)<?/MIVAR>
  <?/MISQL>
  <?MISQL COND="$(>,$(POSITION,$MID,LOCUS),0)" SQL="
		select locus_name
		  from locus
		where zdb_id = '$MID';">
	<?MIVAR NAME=mrkr_abbrev>$1<?/MIVAR>
  <?/MISQL>

  <?MIBLOCK COND="$(XST,$UPDATE)">
        <?MIVAR>
     		<TITLE>Update Mapping Detail: $mrkr_abbrev  </TITLE>
       	<?/MIVAR>
   <?MIELSE>    
    	<?MIVAR>		
 		<TITLE>Mapping Detail: $mrkr_abbrev </TITLE>
    	<?/MIVAR>
   <?/MIBLOCK>
 	
  <?MIVAR>
       <form method=post 
              action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->" 
              target=comments>
           <input type=hidden name=subject value="$mrkr_abbrev">
           <input type=hidden name=marker_id value="$MID">
           <input type=hidden name=MIval value="aa-your_input_welcome.apg">
           <input type=hidden name=page_id value="$MID">
  <?/MIVAR>
  <TR bgcolor=#ccccccc>
  <TD colspan=2>
    <FONT SIZE=+2>    <b>Mapping Details</b>      </FONT>
  </TD>

  <TD align=right>     <input type=submit value="Your Input Welcome"></TD>         
  </TR>
      </form>
  <!-- wrap Mapping table in mapper form -->
  <!-- form tag brings in extra space line. For display sake, 
     it is put a bit in advance. -->

  <?MIVAR COND="$(XST,$reserved_mrkr_abbrev)">$(SETVAR,$mrkr_abbrev,$reserved_mrkr_abbrev)<?/MIVAR>


  <!-------------- Name titles --------------------------------------->
 <TR><TD colspan=2>
 <?MIBLOCK COND="$(>,$(POSITION,$OID,GENE),0)">
      <?MIVAR>
        <b>$marker_type_display Name: &nbsp;<i>$mrkr_name</i> </b><br>
        <b>$marker_type_display Symbol: &nbsp; <i><A HREF='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$OID'>$mrkr_abbrev</A></i></b><br>
      <?/MIVAR>
    	
      <?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$OID&abbrev=$mrkr_abbrev') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
     
      <?MIVAR NAME=$locus_id><?/MIVAR>
      <?MISQL SQL="
		select zdb_id, abbrev, locus_name
                  from locus
                 where cloned_gene = '$OID'
                ;">
  
         <TR><TD><b>Locus <i><A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-locusview.apg&OID=$1">$(IF,$(NC,$2,),$2,$3)</A></i> corresponding to gene <i><A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$OID">$mrkr_abbrev</A></i></b>
         </TD></TR>
         <?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$1&abbrev=$(IF,$(NC,$2,),$2,null)') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
         <?MIVAR NAME=$locus_id>$1<?/MIVAR>
      <?/MISQL>
      
      <?MISQL SQL="
	       select zdb_id, allele
                 from fish
		where zdb_id = '$MID'
            union 
               select f.zdb_id, allele
                 from fish f, locus l
                where l.cloned_gene = '$OID'
	          and l.zdb_id = f.locus
                  and (f.zdb_id in 
			  (select marker_id from mapped_marker)
                    or f.zdb_id in 
			  (select lnkgmem_member_zdb_id 
			     from linkage_member, linkage
			    where lnkg_zdb_id = lnkgmem_linkage_zdb_id)
		    or f.allele in 
			  (select allele
			     from mapped_deletion  )			    	
                       ) ;">
        <?MIVAR NAME=$allele_id>$1<?/MIVAR>
        <?MIVAR NAME=$allele>$2<?/MIVAR>
	<TR><TD><b>Allele <i><A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID=$1">$2</A></i> corresponding to gene <i><A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$OID">$mrkr_abbrev</A></i> </b> 
        </TD></TR>

	<?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$allele_id&abbrev=$allele') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
    
      <?/MISQL> 

  <?/MIBLOCK>

  <?MIBLOCK COND="$(>,$(POSITION,$OID,LOCUS),0)">
     <?MISQL SQL="
		select locus_name, abbrev
		  from locus
		 where zdb_id = '$OID'
		;">
	<?MIVAR NAME=$locus_name>$1<?/MIVAR>
 	<?MIVAR NAME=$locus_abbrev>$2<?/MIVAR>
     <?/MISQL>

     <?MIVAR>
      <b>Locus Name: &nbsp;<i>$locus_name</i></b><br>
      <b>Locus Abbreviation: &nbsp;<i><A HREF='/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-locusview.apg&OID=$OID'>$locus_abbrev</A></i></b> 
     <?/MIVAR>
     <?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$OID&abbrev=$(IF,$(NC,$locus_abbrev,),$2,null)') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
	
     <?MISQL SQL=" 
               select zdb_id, allele
                 from fish
		where zdb_id = '$MID'
            union
               select zdb_id, allele
                 from fish 
                where locus = '$OID'
                  and (zdb_id in 
			  (select marker_id from mapped_marker)
                    or zdb_id in 
			  (select lnkgmem_member_zdb_id from linkage_member)
		    or allele in 
			  (select allele from mapped_deletion)
                       ) ;">
        <?MIVAR NAME=$allele_id>$1<?/MIVAR>
        <?MIVAR NAME=$allele>$2<?/MIVAR>
	<TR><TD><b>Allele <i><A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID=$1">$2</A></i></b> 
        </TD></TR>

	<?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$allele_id&abbrev=$allele') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
    
      <?/MISQL>
       
  <?/MIBLOCK>

  
  <?MIBLOCK COND="$(>,$(POSITION,$OID,FISH),0)">
	<?MISQL SQL="
		select name, abbrev, allele, locus
		  from fish 
		 where zdb_id = '$OID'
		;">
	  <?MIVAR NAME=$name>$1<?/MIVAR>
          <?MIVAR NAME=$abbrev>$2<?/MIVAR>
          <?MIVAR NAME=$allele>$3<?/MIVAR>
          <?MIVAR NAME=$locus>$4<?/MIVAR>
        <?/MISQL>
	<?MIVAR>
	  <b> Allele Name: &nbsp; <b> <a href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-locusview.apg&OID=$locus"> $name </A></b><br>
          <b> Abbreviation: &nbsp; <i>$abbrev</i></b><br>
	<?/MIVAR>
  
	<?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$OID&abbrev=$allele') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
   <?/MIBLOCK>	


  <?MIBLOCK COND="$(AND,$(=,$(POSITION,$OID,FISH),0), $(=,$(POSITION,$OID,LOCUS),0),$(=,$(POSITION,$OID,GENE),0))">

      <?MIVAR>
      <TR><TD><b>$marker_type_display: &nbsp; <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$OID">$mrkr_name</A> </b></TD></TR><br>
      <?MISQL SQL="select WebExplode(object,'&mapdetails_mode=details&orgOID=$MID&detOID=$OID&abbrev=$mrkr_abbrev') from webPages where ID='aa-mappingdetail.apg';">$1<?/MISQL>
      <?/MIVAR>
  <?/MIBLOCK>
  </TD></TR>
  <!------------------------end of mapping info ----------------------->   
  

  <!---------------------- Primer set ----------------------------------->
  <!-- REALLY need an OUTER JOIN here so that I can join to table FISH to get the strain name for the id.  I do this now, but it knocks out any primer for which the strain_id=NULL (Unknown).  Just have to avoid those NULLS!
-->

 <?MISQL SQL="select a.zdb_id, band_size,restr_enzyme, fwd_primer, rev_primer, anneal_temp::numeric(6,2), a.comments,strain_id,b.name from primer_set a,fish b where marker_id='$OID' and b.zdb_id=a.strain_id;">

    <?MIBLOCK COND="$(=,$MI_CURRENTROW,1)">
      <TR><TD><br></TD></TR>
      <TR>
       <TD><b>Primer Sets:</b></TD>
      </TR>
    <?/MIBLOCK>
      <TR bgcolor=<?MIVAR>"$highlight"<?/MIVAR>> 
      <TD colspan=3>
      <TABLE>
       <TR>
         <TD><b>Strain:</b> <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID=$8">$9</A>  </TD>
         <TD align=left><b>Band Size</b>: $(IF,$(EQ,$2,NULL),Unknown,$2)</TD>
         <TD><b>Restr. Enz.:</B> $(IF,$(EQ,$3,NULL),None,$3)</TD>
         <TD><b>Anneal. Temp(C):</b> $(IF,$(EQ,$6,NULL),Unknown,$6)</TD>
       </TR>
       <TR>
	 <TD>&nbsp;&nbsp;</TD>
         <TD align=left colspan=3><font size=2><b>F-PRIMER:</b> $(IF,$(EQ,$4,NULL),Unknown,$4)</font></TD>
          <TD align=left colspan=3><font size=2><B>R-PRIMER: </b>$(IF,$(EC,$marker_type,RAPD),N/A,$(IF,$(EQ,$5,NULL),Unknown,$5))</font></TD>
       </TR>
      </TABLE>
      </TD></TR>
 <?/MISQL>

 </TABLE>
  
 <?MIVAR NAME=$mapdetails_mode>standalone<?/MIVAR>
 <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>


 <?/MIBLOCK>
</HTML>
<?/MIBLOCK>
<!------------- end standalone mode ------------------------------------->




<!-------------- start details mode ------------------------------------->

<?MIBLOCK COND="$(EC,$mapdetails_mode,details)">
<?MIVAR COND="$(EC,$orgOID,$detOID)">
<script>
	function new_attrib_delmarker(formobj, oid) {
		var del_marker=formobj.elements[0].value;
		var pub_id=formobj.elements[1].value;
		if ((del_marker != '') && (pub_id != '')) {
		  window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-do-markerupdate.apg&caller=mappingdetail.apg&OID='+oid+'&attr=recattrib&attr_type=special-newattrib&old_value='+del_marker+'&new_value='+pub_id+'&target_table=$target_table&info=deletionmarker');
  		}
	}

	function Delete_attrib(subattr,data_zdbId,source_zdbId,info) {
		window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-do-markerupdate.apg&caller=mappingdetail.apg&OID=$detOID&dataOID='+data_zdbId+'&attr='+subattr+'&attr_type=special-listitem&old_value='+source_zdbId+'&new_value=deleted&target_table=$target_table&info='+info);
	}

	function doit_marker(attr,attr_type,print_name,lg) {
	  window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishupdate.apg&caller=mappingdetail.apg&OID=$detOID&attr='+attr+'&attr_type='+attr_type+'&print_name='+print_name+'&lg='+lg)
	}

	function Delete_marker(allele,marker_id) {
	  window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-do-fishupdate.apg&caller=mappingdetail.apg&OID=$detOID&attr='+allele+'&attr_type=marker-delete&old_value='+marker_id+'&new_value=deleted');
	}
</script>
<?/MIVAR>

  <?MIBLOCK COND="$(NXST,$detOID)">
  Eek! No detOID passed into details mode
  <?/MIBLOCK>  
  <?MIVAR NAME=$mapped>f<?/MIVAR>
  
  <!-- Now if it's a mutant deletion, also show present/missing markers -->
  <?MIBLOCK COND="$(>,$(POSITION,$detOID,FISH),0)">
	<?MISQL SQL="select chrom_change from fish_search where fish_id='$detOID';"><?/MISQL>
	 <?MIVAR NAME=$chrom_change>$1<?/MIVAR>

	 <?MIBLOCK COND="$(OR,$(EC,$chrom_change,deficiency),$(EC,$chrom_change,translocation),$(EC,$chrom_change,unknown))">
	   <A NAME="markers-missing"></a>
	  
	   <?MIVAR NAME=$last><?/MIVAR>
	   <?MIVAR name=marker_present>0<?/MIVAR>
	   <?MIVAR name=marker_missing>0<?/MIVAR>

	   <?MIBLOCK COND="$(XST,$UPDATE)">
	      <TR><TD colspan=3> <?MIVAR>
	      <TABLE width=100%  bgcolor = "$highlight" cellpadding=2>
                                 <?/MIVAR>
	      <TR><TD><b>Deletion Markers: 
	      <table>
	      <tr><td>
		<?MIVAR COND="$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE))">
		  <form name=mpdt_update>
    		  <br><b>Add Reference:</b> 
    		  Symbol:<input type=text name=attrib_delmarker>	
                  Reference:<input type=text name=attrib_delmarker_pubid>
    		  <input type=button value="Add" onClick=new_attrib_delmarker(this.form,"$detOID");> 
		  </form>
		<?/MIVAR>
               </td></tr><tr><td>

           <?/MIBLOCK>	

	   <?MISQL SQL="
		select b.mrkr_abbrev,a.marker_id,a.present_t,b.mrkr_type, a.mapdel_zdb_id
		from mapped_deletion a, marker b 
		where a.marker_id=b.mrkr_zdb_id 
		and allele='$abbrev' 
		union
		select b.abbrev,a.marker_id,a.present_t,'MUTANT', a.mapdel_zdb_id
		from mapped_deletion a, locus b 
		where a.marker_id=b.zdb_id 
		and allele='$abbrev' 
		order by 3,4 ;">
		
		<?MIVAR NAME=mrkrZdbId>$2<?/MIVAR>
		<?MIVAR NAME=mapdelZdbId>$5<?/MIVAR>
	    <?MIBLOCK COND="$(AND,$(=,$MI_CURRENTROW,1),$(NXST,$UPDATE))">
	      <TR><TD colspan=3><?MIVAR>
	      <TABLE width=100%  bgcolor = "$highlight" cellpadding=2>
                                <?/MIVAR>
	      <TR><TD><b>Deletion Markers: 
	      <table>
	      <tr><td>
 	
             <?/MIBLOCK>
	

	   <?MIBLOCK COND="$(AND,$(NC,$last,$3),$(EC,$3,F))">
	      <?MIVAR COND="$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE))">
	       <INPUT TYPE=button value="Add" onClick=doit_marker('marker','selection','missing',0)> 	   
	      <?/MIVAR>
	    	    
	       <b>Missing:</b>
	       <?MIVAR name=marker_missing>1<?/MIVAR>
	    <?/MIBLOCK>

	   <?MIBLOCK COND="$(AND,$(NC,$last,$3),$(EC,$3,t))">
	     <?MIVAR name=marker_present>1<?/MIVAR>
	     </td></tr>
             <tr><td align=left>
             <?MIVAR>$(SETVAR,$last,)<?/MIVAR><?MICOMMENT>reset $last to control ";" display<?/MICOMMENT>    
	     <?MIVAR COND="$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE))">	    
	       <INPUT TYPE=button value="Add" onClick=doit_marker('marker','selection','present',0)> 
	     <?/MIVAR>	
	     <b>Present:</b>
	   <?/MIBLOCK>
	  
	  $(IF,$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE)),"<font size=-1><input type=button value=delete onClick=Delete_marker('"$allele"','"$mrkrZdbId"')>")

	  $(IF, $(AND,$(NXST,$UPDATE),$(NE,$last,)),;)
	  <A href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$mrkrZdbId">$1</A> 
          <!---- we need to save the OID, and set it to the detOID when calling the miniref_display.apg which calls showpubs.apg--------!> 
          <?MIVAR NAME=savedOID>$OID<?/MIVAR>
	  <?MISQL SQL="select WebExplode(object,'OID=$detOID&dataId=$mapdelZdbId&type=recattrib') from webPages where ID='aa-miniref_display.apg';">$1<?/MISQL>
	  <?MIVAR>$(SETVAR,$OID,$savedOID)<?/MIVAR>

	  $(SETVAR,$last,$3)
	  <?/MISQL>

	
	  <?MIBLOCK COND="$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE),$(EC,$marker_missing,0))">
	    </TD></TR><TR><TD align=left>
	    <INPUT TYPE=button value="Add" onClick=doit_marker('marker','selection','missing',0)> 
	    <b>Missing:</b><br>
	  <?/MIBLOCK>

	  <?MIBLOCK COND="$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE),$(EC,$marker_present,0))">
	    </TD></TR><TR><TD align=left>
	    <INPUT TYPE=button value="Add" onClick=doit_marker('marker','selection','present',0)> 
	    <b>Present:</b><br>
	  <?/MIBLOCK>

	  <?MIVAR COND="$(>,$MI_ROWCOUNT,0)">
	    $(SETVAR,$mapped,t) 
	  <?/MIVAR>
          <?MIVAR COND="$(OR,$(>,$MI_ROWCOUNT,0),$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE)))">
	   </td></tr></table>
 	   </TD></TR></TABLE>
	  </TD></TR>
	  <?/MIVAR>           
	<?/MIBLOCK> <!-- ends deficiency -->
     <?/MIBLOCK>   
    	
  <!----------------------------------------------------->


  <TR><TD valign=top colspan=3>
    <TABLE width="100%"  bgcolor=<?MIVAR>$highlight<?/MIVAR>>

  <!------------Reference Panel Mapping ------------------>

  <?MIVAR NAME=$override>$(IF,$(OR,$(EC,$ZDB_access,root),$(EC,$ZDB_access,fishauth)),true,false)<?/MIVAR> 
   <?MISQL SQL="
	select a.owner, lg_location, refcross_id as panel_id, or_lg, c.abbrev as panel_abbrev, b.full_name,a.metric,day(a.entry_date::date),month(a.entry_date::date), year(a.entry_date::date), map_name, disp_order 
	from mapped_marker a, outer person b, panels c  
	where a.marker_id='$detOID' 
	and or_lg is not null 
	and a.owner=b.zdb_id 
	and a.refcross_id = c.zdb_id 
        and marker_type <> 'SNP'
	order by c.disp_order;">

    <?MIVAR NAME=$upd_date>$10<?/MIVAR>
    <?MIBLOCK COND="$(EC,$10,)">
      <?MIVAR NAME=$upd_date> <?/MIVAR>
    <?/MIBLOCK>

    <font size=-1>
    <TR><TD>      
        LG&nbsp;<b>$4</b><b>&nbsp;$2</b>&nbsp;$7 (<A HREF=/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-crossview.apg&OID=$3>$5 Panel</A>) 
          $(IF,$(ISNULL,$11),,<br>&nbsp;&nbsp;Mapped as $11)
    </TD>
    
     <TD> <font size=-1>mapped by <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-persview.apg&OID=$1">$6</A></font> </TD> <TD><font size=-1><A HREF="javascript:view_scores('$3','$4','$detOID','$abbrev');">Scoring Data</A>
     </TD> </TR>
     </font>
     <?MIVAR NAME=$mapped>t<?/MIVAR>	
    <?/MISQL>

   <!---------- ************************************** ------------>	  
   <?MIBLOCK COND="$(>,$MI_ROWCOUNT,0)">
     <TR><TD></TD> 
	      <TD colspan=2><b>View Map: &nbsp;</b>
              <?MIVAR NAME=$vmpanels><?/MIVAR>
		<?MISQL SQL="select abbrev, disp_order from panels order by disp_order;">
		 <?MIVAR NAME=$vmpanels>$vmpanels&$1=1<?/MIVAR>
		<?/MISQL>
              <?MIVAR>
	      <A HREF="/<!--|CGI_BIN_DIR_NAME|-->/view_zmapplet.cgi?&userid=$userid&OID=$detOID&view_map=view_map$vmpanels">Merged</A> &nbsp;&nbsp;&nbsp;
	      <A HREF="/<!--|CGI_BIN_DIR_NAME|-->/view_mapplet.cgi?&userid=$userid&OID=$detOID&view_map=view_map$vmpanels">Individual Panels</A>
              <?/MIVAR>
             </TD>
     </TR>	
    <?/MIBLOCK>
  <!------------ OID is the only member in a linkage ---------------->
   
   <?MISQL SQL="
	select lnkg_comments, recattrib_source_zdb_id, lnkg_or_lg, lnkg_zdb_id 
	  from linkage_member, linkage, record_attribution
	 where lnkgmem_member_zdb_id = '$detOID'
           and lnkgmem_linkage_zdb_id = lnkg_zdb_id
	   and lnkgmem_linkage_zdb_id = recattrib_data_zdb_id
           and lnkgmem_linkage_zdb_id in (
		 select lnkgmem_linkage_zdb_id 
		   from linkage_member
		group by lnkgmem_linkage_zdb_id 
		  having count(*) = 1 )
           ;">
     
    <?MIVAR NAME=$distance><?/MIVAR>
    <?MIVAR NAME=$lod><?/MIVAR>
    <?MIVAR NAME=$metric><?/MIVAR>
    <?MIVAR NAME=$pair_id>null<?/MIVAR>
    <?MIVAR NAME=$lg>$3<?/MIVAR>
    <?MIVAR NAME=$map_comments>$1<?/MIVAR>
    <?MIVAR NAME=$link_id>$4<?/MIVAR>
    <?MICOMMENT>*** 07/28/03 we decided to show LG Unknown when LG is 0, instead of hiding it.<?/MICOMMENT>
    <?MIVAR COND="$(EC,$lg,0)">$(SETVAR,$lg,<font size=-1>Unknown</font>)<?/MIVAR>
    $(IF,$(>,$(POSITION,$2,PER),0),$(SETVAR,$sourceviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-persview.apg&OID="),$(SETVAR,$sourceviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-pubview2.apg&OID="))
   
    <?MIBLOCK COND="$(>,$(POSITION,$2,PER),0)">
      <?MISQL SQL="select full_name
		    from person
		   where zdb_id = '$2';">
	<?MIVAR NAME=$source_name>$1<?/MIVAR>
       <?/MISQL>
    <?MIELSE>
	<?MIVAR NAME=$source_name><?/MIVAR>				 	
 	<?MISQL SQL="select pub_mini_ref
		    from publication
		   where zdb_id = '$2';">
	  <?MIVAR NAME=$source_name>$1<?/MIVAR>
        <?/MISQL>
    <?/MIBLOCK>
   
     $(IF,$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE)),"<TR><TD><INPUT TYPE=button value=Update onClick=edit_linkage('"$link_id"','"$distance"')></TD>","<TR>")	
     <TD>LG $lg</TD>
     <TD><A href="$sourceviewer$2">$source_name</a></TD><TD><A HREF=javascript:show_detail('$link_id','$detOID','$(IF,$(XST,$abbrev),$abbrev)','$(IF,$(XST,$abbrev),$abbrev)');>Details</A></TD><TR>
      <?MIVAR NAME=$mapped>t<?/MIVAR>
	
    <?/MISQL>

  <!---------------- mapping info from independant linkage --------------->

  <?MIVAR NAME=$MI_NULL><?/MIVAR>
  <?MIVAR NAME=$curviewer><?/MIVAR>

   <!-- get independent linkage info for other members of linkage or for marker itself if it is the only linkage member -->
  
	
   <?MISQL SQL="
      select mrkr_zdb_id, mrkr_abbrev, mrkr_type, mrkrtype_type_display,
	     lnkg_comments, lnkg_zdb_id, lnkg_or_lg
        from linkage_member lmthis, linkage_member lmother, linkage, marker,
	     marker_types
	where lmthis.lnkgmem_member_zdb_id = '$detOID' and
	      lmthis.lnkgmem_linkage_zdb_id = lmother.lnkgmem_linkage_zdb_id
	  and lmthis.lnkgmem_member_zdb_id <> lmother.lnkgmem_member_zdb_id
	  and lmother.lnkgmem_linkage_zdb_id = lnkg_zdb_id
	  and lmother.lnkgmem_member_zdb_id = mrkr_zdb_id
	  and mrkr_type = marker_type
      UNION
      select f.zdb_id, l.abbrev, 'MUTANT', 'Mutant', 
	     lnkg_comments, lnkg_zdb_id, lnkg_or_lg
	from linkage_member lmthis, linkage_member lmother, linkage, fish f,
	     locus l
	where lmthis.lnkgmem_member_zdb_id = '$detOID' and
	      lmthis.lnkgmem_linkage_zdb_id = lmother.lnkgmem_linkage_zdb_id
	  and lmthis.lnkgmem_member_zdb_id <> lmother.lnkgmem_member_zdb_id
	  and lmother.lnkgmem_linkage_zdb_id = lnkg_zdb_id
	  and lmother.lnkgmem_member_zdb_id = f.zdb_id
	  and f.locus = l.zdb_id
      order by 6;">
   
    <?MIVAR NAME=$distance><?/MIVAR>
    <?MIVAR NAME=$lod><?/MIVAR>
    <?MIVAR NAME=$metric><?/MIVAR>
    <?MIVAR NAME=$pair_id>null<?/MIVAR>
    <?MIVAR NAME=$member_zdb_id>$1<?/MIVAR>
    <?MIVAR NAME=$member_abbrev>$2<?/MIVAR>
    <?MIVAR NAME=$member_type>$3<?/MIVAR>
    <?MIVAR NAME=$member_type_display>$4<?/MIVAR>
    <?MIVAR NAME=$map_comments>$5<?/MIVAR>
    <?MIVAR NAME=$link_id>$6<?/MIVAR>
    <?MIVAR NAME=$lg>$7<?/MIVAR>
    <?MIVAR COND="$(EC,$lg,0)">$(SETVAR,$lg,<font size=-1>Unknown</font>)<?/MIVAR>

    <?MIBLOCK COND="$(=,$MI_CURRENTROW,1)">
      <TR><TD colspan=3><p><b>Markers Linked To <?MIVAR>$abbrev<?/MIVAR>:</b>
      </TD></TR>
      <TR>    
        <TD colspan=3>
        <TABLE width=100%>
        <?MIVAR NAME=subtable>y<?/MIVAR>
    <?/MIBLOCK> 

    $(IF,$(EC,$member_type,MUTANT),$(SETVAR,$curviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-fishview.apg&OID="), $(SETVAR,$curviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID="))

    <?MISQL SQL="select lpmem_linkage_pair_zdb_id from linkage_pair_member a
      where lpmem_member_zdb_id = '$member_zdb_id' 
       and lpmem_linkage_zdb_id = '$link_id'
       and exists (select 'x' from linkage_pair_member b 
          where a.lpmem_linkage_zdb_id = '$link_id'
            and a.lpmem_linkage_pair_zdb_id = b.lpmem_linkage_pair_zdb_id
            and b.lpmem_member_zdb_id = '$detOID');">
      <?MIVAR NAME=$pair_id>$1<?/MIVAR>
    <?/MISQL>

    <?MIBLOCK COND="$(NC,$pair_id,null)">
      <?MISQL SQL="select lnkgpair_distance, lnkgpair_lod, lnkgpair_metric from linkage_pair
	where lnkgpair_zdb_id = '$pair_id';">
	<?MIVAR NAME=$distance>$1<?/MIVAR>	
	<?MIVAR NAME=$lod>$2<?/MIVAR>	
	<?MIVAR NAME=$metric>$3<?/MIVAR>	
       <?/MISQL>
    <?/MIBLOCK>

    <TR>
    $(IF,$(AND,$(EC,$orgOID,$detOID),$(XST,$UPDATE)),"<TD><INPUT TYPE=button value=Update onClick=edit_linkage('"$link_id"','"$member_zdb_id"')></TD>","<TD> &nbsp;</TD>")


    <?MIVAR NAME=$source_display><?/MIVAR>
    <?MISQL SQL=" select recattrib_source_zdb_id, full_name, recattrib_source_significance 
                    from record_attribution, person
	           where recattrib_data_zdb_id ='$link_id'
		     and recattrib_source_zdb_id = zdb_id
		UNION 
		  select recattrib_source_zdb_id, pub_mini_ref, recattrib_source_significance 
                    from record_attribution, publication
	           where recattrib_data_zdb_id ='$link_id'
		     and recattrib_source_zdb_id = zdb_id
		  order by 3
		; ">
             <?MIVAR NAME=$source_id>$1<?/MIVAR>
    	     <?MIVAR NAME=$source_name>$2<?/MIVAR>
	     $(IF,$(>,$(POSITION,$source_id,PER),0),$(SETVAR,$sourceviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-persview.apg&OID="),$(SETVAR,$sourceviewer,"/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-pubview2.apg&OID="))
	     <?MIVAR>$(SETVAR,$source_display,$source_display<A href='$sourceviewer$source_id'>$source_name</a>&nbsp;&nbsp;)<?/MIVAR>
   
    <?/MISQL>
   
    <?MIBLOCK COND="$(AND,$(NC,$map_comments,NULL),$(NC,$map_comments,""))">
      <?MIVAR>
       $(IF,$(XST,$locus_abbrev),$(SETVAR,$abbrev,$locus_abbrev))
        <TD><A HREF="$curviewer$member_zdb_id">$member_abbrev</A> ($member_type_display)</TD>
        <TD> LG $lg $(IF,$(NC,$distance,),;) $distance $metric $(IF,$(NC,$lod,),;) $lod</TD>
	<TD>$source_display</TD><TD>&nbsp; &nbsp;</TD>
        <TD><A HREF=javascript:show_detail("$link_id","$member_zdb_id","$member_abbrev","$(IF,$(XST,$abbrev),$abbrev)");>Details</A></TD>
      <?/MIVAR>
    <?MIELSE>
      <?MIVAR>
        <TD><A HREF="$curviewer$member_zdb_id">$member_abbrev</A> ($member_type_display)</TD>
        <TD> LG $lg $(IF,$(NC,$distance,),;) $distance $metric $(IF,$(NC,$lod,),;) $lod</TD>
	<TD>$source_display</TD><TD></TD>
	<?/MIVAR>
    <?/MIBLOCK>    

  </TR>
  <?MIVAR NAME=$mapped>t<?/MIVAR>	
 <?/MISQL>
 
 <?MIBLOCK COND="$(AND,$(XST,$subtable),$(EC,$subtable,y))">
  </TABLE>
  </TD></TR>
  <?MIVAR> $(SETVAR,$subtable,n)<?/MIVAR>
 <?/MIBLOCK> 
  
  <!----------------- Markers encoded by --------------->
  
  <?MISQL SQL="SELECT mrel_mrkr_2_zdb_id, mrkr_abbrev
             FROM marker_relationship,  marker
	     WHERE mrel_mrkr_1_zdb_id = '$detOID'
	       and mrel_type = 'gene encodes small segment' 
	       and mrel_mrkr_2_zdb_id = mrkr_zdb_id
	       and (   exists
		       ( SELECT 'x' 
		           FROM mapped_marker
		           WHERE mrel_mrkr_2_zdb_id = marker_id )
		    or exists
		       ( SELECT 'x' 
		           FROM linkage_member
		           WHERE mrel_mrkr_2_zdb_id = lnkgmem_member_zdb_id ) )
      ;">
    <?MIVAR NAME=$insideq_abbrev>$2<?/MIVAR>
    <?MIVAR NAME=$insideq_OID>$1<?/MIVAR>

    <?MIBLOCK COND="$(=,$MI_CURRENTROW,1)">
      <TR><?MIVAR>
        <TD><p><b>Markers Encoded By $abbrev:</b></TD>
      </TR><?/MIVAR>
      <TR><TD><table cols=2>
      <?MIVAR NAME=$table>y<?/MIVAR>
    <?/MIBLOCK>

     <tr><td>
        <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$insideq_OID"><b>$insideq_abbrev</b></A>
         </td>
    <?MISQL SQL="
      select WebExplode(object, '&mapdetails_mode=mini&split=space&hide_empty=t&oID=$insideq_OID')
      from webPages 
      where ID = 'aa-mappingdetail.apg';">
	<td> $1 </td>
    </tr>
    <?/MISQL>
    <?MIVAR NAME=$mapped>t<?/MIVAR>	
  <?/MISQL>
  <?MIBLOCK COND="$(AND,$(XST,$table),$(EC,$table,y))">
   <?MIVAR>$(SETVAR,$table,n)<?/MIVAR>
   </table> 
   </TD></TR>
  <?/MIBLOCK>
 <!------------------- end Marker encoded in ----------->

 <!----------------- Markers contained by --------------->
  
  <?MISQL SQL="SELECT mrel_mrkr_2_zdb_id, mrkr_abbrev
             FROM marker_relationship,  marker
	     WHERE mrel_mrkr_1_zdb_id = '$detOID'
	       and mrel_type in ('clone contains small segment',
				 'clone contains gene') 
	       and mrel_mrkr_2_zdb_id = mrkr_zdb_id
	       and (   exists
		       ( SELECT 'x' 
		           FROM mapped_marker
		           WHERE mrel_mrkr_2_zdb_id = marker_id )
		    or exists
		       ( SELECT 'x' 
		           FROM linkage_member
		           WHERE mrel_mrkr_2_zdb_id = lnkgmem_member_zdb_id ) )
  ;">
  <?MIVAR NAME=$insideq_abbrev>$2<?/MIVAR>
  <?MIVAR NAME=$insideq_OID>$1<?/MIVAR>

  <?MIBLOCK COND="$(=,$MI_CURRENTROW,1)">
    <TR><?MIVAR>
      <TD><p><b>Markers Contained in $abbrev:</b></TD>
    </TR><?/MIVAR>
    <TR><TD><table cols=2> 
    <?MIVAR NAME=$table>y<?/MIVAR>	
  <?/MIBLOCK>

  <?MISQL SQL="
    select WebExplode(object, '&mapdetails_mode=mini&split=space&hide_empty=t&oID=$insideq_OID')
      from webPages 
      where ID = 'aa-mappingdetail.apg';">
    <tr><td>
        <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$insideq_OID"><b>$insideq_abbrev</b></A>
       </td>
       <td> $1 </td>
     </tr>
   <?/MISQL>

  <?MIVAR NAME=$mapped>t<?/MIVAR>	
  <?/MISQL>
  <?MIBLOCK COND="$(AND,$(XST,$table),$(EC,$table,y))">
  </table><?MIVAR>$(SETVAR,$table,n)<?/MIVAR>
  </TD></TR>
  <?/MIBLOCK>

  <!------------------- end Marker contained in ----------->



   <!---------------- Clone containing --------------------->
   <?MISQL SQL="SELECT mrel_mrkr_1_zdb_id, mrkr_abbrev
             FROM marker_relationship,  marker
	     WHERE mrel_mrkr_2_zdb_id = '$detOID'
	       and mrel_type in ('clone contains small segment',
				 'clone contains gene') 
	       and mrel_mrkr_1_zdb_id = mrkr_zdb_id
	       and (   exists
		       ( SELECT 'x' 
		           FROM mapped_marker
		           WHERE mrel_mrkr_1_zdb_id = marker_id )
		    or exists
		       ( SELECT 'x' 
		           FROM linkage_member
		           WHERE mrel_mrkr_1_zdb_id = lnkgmem_member_zdb_id ) )
  ;">
  <?MIVAR NAME=$clone_abbrev>$2<?/MIVAR>
  <?MIVAR NAME=$clone_OID>$1<?/MIVAR>
  <?MIBLOCK COND="$(=,$MI_CURRENTROW,1)">  
    <TR><?MIVAR>
      <TD><p><b>Mapped Clones Containing $abbrev:</b></TD>
    </TR><?/MIVAR>
    <TR><TD><table cols=2>
    <?MIVAR NAME=$table>y<?/MIVAR>
  <?/MIBLOCK>

  <?MISQL SQL="
    select WebExplode(object, '&mapdetails_mode=mini&split=space&hide_empty=t&oID=$clone_OID')
      from webPages 
      where ID = 'aa-mappingdetail.apg';">
    <tr>
      <td>
        <A HREF="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$clone_OID"><b>$clone_abbrev</b></A>
      </td>
      <td> $1 </td>
     </tr>
   <?/MISQL>
   <?MIVAR NAME=$mapped>t<?/MIVAR>	
  <?/MISQL>
  <?MIBLOCK COND="$(AND,$(XST,$table),$(EC,$table,y))">
  </table><?MIVAR>$(SETVAR,$table,n)<?/MIVAR>
  </TD></TR>
  <?/MIBLOCK>
 <!------------------- end Clone containing ------------------->
 
 </TABLE></TD></TR>
<?MIBLOCK COND="$(EC,$mapped,t)"> <p><TR><TD> <hr width=80%></TD></TR> 
  <?MIVAR>$(SETVAR,$mapped, f)<?/MIVAR>
<?/MIBLOCK>
<?/MIBLOCK>



<!-------------- end details mode ------->