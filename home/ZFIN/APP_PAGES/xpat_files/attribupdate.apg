<?MICOMMENT>

FILE:     attribupdate.apg
PREFIX:   attrup_

Adds attribution to zdb_id


INPUT VARS:

  REQUIRED:
    $OID :: publication zdb-id
    $AUTHORIZED :: this is a subroutine. the authorization must occur in the calling page.

  OPTIONAL:  
      pubcur_G_attrib_data_zdb :: the data being attributed
      pubcur_G_attrib_table :: the table where the data is stored
      pubcur_G_attrib_column :: the column_name pubcur_G_attrib_table
      xpcur_G_mrkr_attrib :: mrkr abbrev 
      xpcur_G_fish_attrib :: fish abbrev 
      
   
      

OUTPUT VARS:
  None.

OUTPUT:
  None

EFFECTS  
  Add records to record_attribution.
  
  Set cookie pubcur_c_attribution_update to 'no'.  

<?/MICOMMENT>

<?MIERROR>
<html>
<script src="/javascript/header.js"></script>
<p>Looks like we are having trouble processing your request. You can...</p>
<ul>
    <li>try reloading the page to see if the problem persists</li>
    <li>head back to the <a href="/">home page</a></li>
    <li>send us an <a href="mailto:zfinadmn@zfin.org">email</a> and tell us about it</li>
</ul>

<?MIBLOCK COND="$(EC,$AUTHORIZED,root)">
    <p class="error">ROOT ONLY DEBUGGING</p>
    <pre><?MIVAR>
SQL:     $MI_SQL
Code:    $MI_ERRORCODE
State:   $MI_ERRORSTATE
Message: $MI_ERRORMSG
<?/MIVAR></pre>
<?/MIBLOCK>
<script src="/javascript/footer.js"></script>
</html>
<?/MIERROR>

<?MIBLOCK COND="$(EC,$AUTHORIZED,root)">

    <?MICOMMENTS>
       ================================================
         Set the default type to standard.
       ================================================
    <?/MICOMMENTS>  
  
  <?MIVAR NAME=attrup_attrib_type>$(IF,$(XST,$pubcur_G_attrib_type),$pubcur_G_attrib_type,standard)<?/MIVAR>


  <?MICOMMENT> ================| Attribution |================ <?/MICOMMENT>
  <?MIBLOCK COND=$(XST,$pubcur_G_mrkr_attrib)>
  
    <?MICOMMENTS>
       ================================================
         Check that the mrkr_record exists. 
         Then, add a record to record attribution
       ================================================
    <?/MICOMMENTS>
    
    <?MISQL SQL="select mrkr_zdb_id 
                 from marker
                 where LOWER(mrkr_abbrev) = '$(LOWER,$pubcur_G_mrkr_attrib)'
                ;">
            <?MIVAR NAME=xpcurup_attrib_mrkr_zdb>$1<?/MIVAR>
    <?/MISQL>
    
    <?MIBLOCK COND=$(XST,$xpcurup_attrib_mrkr_zdb)>
      <?MISQL SQL="
        select count(*)::integer
        from record_attribution
        where recattrib_data_zdb_id = '$xpcurup_attrib_mrkr_zdb'
          and recattrib_source_zdb_id = '$OID'
        ;">
    <?/MISQL>
      
      <?MIBLOCK COND=$(=,$1,0)>
        <?MISQL SQL="
          insert into record_attribution(recattrib_data_zdb_id,recattrib_source_zdb_id)
          values ('$xpcurup_attrib_mrkr_zdb','$OID');">
        <?/MISQL>    
      
        <?MISQL SQL="
          select WebExplode(object,'permission=root&recweb_rec_id= $xpcurup_attrib_mrkr_zdb&recweb_pers_id=$ZDB_ident&recweb_pers_name=$ZDB_name&recweb_table_column=record_attribution&recweb_new_value=$OID&recweb_comments=create+new+record') 
          from webPages where ID='aa-record_web_update.apg';">
        <?/MISQL>
      <?/MIBLOCK>
      
      <?MIBLOCK COND="$(AND,$(XST,$xpcur_c_auto_on),$(EC,$xpcur_c_auto_on,on))">
        <?MIVAR NAME=xpcur_c_gene_only>$xpcurup_attrib_mrkr_zdb<?/MIVAR>
        <?MIVAR>
          <SCRIPT>
            setCookie('gene_only','$xpcurup_attrib_mrkr_zdb','pubcur_c_')
          </SCRIPT>      
        <?/MIVAR>
      <?/MIBLOCK>
    <?MIELSE>
      <?MIVAR NAME=xpcurup_alert>Could not find $pubcur_G_mrkr_attrib in the marker table.<?/MIVAR>    
    <?/MIBLOCK>
  <?/MIBLOCK>
  
  <?MIBLOCK COND=$(XST,$pubcur_G_fish_attrib)>
  
    <?MICOMMENTS>
       ================================================
         Check that the feature_record exists. 
         Then, add a record to record attribution
       ================================================
    <?/MICOMMENTS>
    
    <?MISQL SQL="select feature_zdb_id 
                 from feature
                 where LOWER(feature_abbrev) = '$(LOWER,$pubcur_G_fish_attrib)'
                ;">
            <?MIVAR NAME=xpcurup_attrib_fish_zdb>$1<?/MIVAR>
    <?/MISQL>
    
    <?MIBLOCK COND=$(XST,$xpcurup_attrib_fish_zdb)>
      <?MISQL SQL="
        select count(*)::integer
        from record_attribution
        where recattrib_data_zdb_id = '$xpcurup_attrib_fish_zdb'
          and recattrib_source_zdb_id = '$OID'
        ;">
      <?/MISQL>
    
      <?MIBLOCK COND=$(EC,$1,0)>
        <?MISQL SQL="
          insert into record_attribution(recattrib_data_zdb_id,recattrib_source_zdb_id)
          values ('$xpcurup_attrib_fish_zdb','$OID');">
        <?/MISQL>   
      
        <?MISQL SQL="
          select WebExplode(object,'permission=root&recweb_rec_id=$xpcurup_attrib_fish_zdb&recweb_pers_id=$ZDB_ident&recweb_pers_name=$ZDB_name&recweb_table_column=record_attribution&recweb_new_value=$OID&recweb_comments=create+new+record') 
          from webPages where ID='aa-record_web_update.apg';">
        <?/MISQL>
      <?/MIBLOCK>
      
      <?MIVAR NAME=xpcur_G_xpatex_fish>$xpcurup_attrib_fish_zdb<?/MIVAR>
      
    <?MIELSE>
      <?MIVAR NAME=xpcurup_alert>Could not find $pubcur_G_fish_attrib in the feature table.<?/MIVAR>    
    <?/MIBLOCK>
  <?/MIBLOCK>


  <?MIBLOCK COND="$(AND,$(XST,$pubcur_G_attrib_data_zdb), 
                        $(XST,$pubcur_G_attrib_table), 
                        $(XST,$pubcur_G_attrib_column))">
  
    <?MICOMMENTS>
       ================================================
         Check that the record exists. 
         Then, add a record to record attribution
       ================================================
    <?/MICOMMENTS>
    
    <?MISQL SQL="select count(*)::integer 
                 from $pubcur_G_attrib_table
                 where $pubcur_G_attrib_column = '$pubcur_G_attrib_data_zdb'
                ;">
    <?/MISQL>
    
    <?MIBLOCK COND=$(EC,$1,1)>
      <?MISQL SQL="
        select count(*)::integer
        from record_attribution
        where recattrib_data_zdb_id = '$pubcur_G_attrib_data_zdb'
          and recattrib_source_zdb_id = '$OID'
          and recattrib_source_type = '$attrup_attrib_type'
        ;">
      <?/MISQL>
    
      <?MISQL COND=$(EC,$1,0) SQL="
        insert into record_attribution(recattrib_data_zdb_id,recattrib_source_zdb_id)
        values ('$pubcur_G_attrib_data_zdb','$OID');">
      <?/MISQL>   
      
      <?MISQL SQL="
        select WebExplode(object,'permission=root&recweb_rec_id=$pubcur_G_attrib_data_zdb&recweb_pers_id=$ZDB_ident&recweb_pers_name=$ZDB_name&recweb_table_column=record_attribution&recweb_new_value=$OID&recweb_comments=create+new+record') 
        from webPages where ID='aa-record_web_update.apg';">
      <?/MISQL>
    
    <?MIELSE>
      <?MIVAR NAME=xpcurup_alert>Could not find $pubcur_G_attrib_data_zdb in $pubcur_G_attrib_table .<?/MIVAR>    
    <?/MIBLOCK>
    
    <?MIVAR>
      $(UNSETVAR,$pubcur_G_attrib_data_zdb)
      $(UNSETVAR,$pubcur_G_attrib_table)
      $(UNSETVAR,$pubcur_G_attrib_column)
    <?/MIVAR>
    
  <?/MIBLOCK>

  <?MIBLOCK COND=$(AND,$(XST,$pubcur_G_remove_attrib),$(NE,$pubcur_G_remove_attrib,-))>
      
      <?MIVAR NAME=pub_OID>$OID<?/MIVAR>
      <?MIVAR NAME=OID>$pubcur_G_remove_attrib<?/MIVAR>
      <?MISQL SQL="select WebExplode(object,'citlink_data_page=citgeneric.apg') from webPages where ID='aa-cittotalcount.apg';">$1<?/MISQL>
      <?MIVAR NAME=citlink_total_count_before>$citlink_total_count<?/MIVAR> 
      
      <?MISQL SQL="
        delete from record_attribution
	  where recattrib_data_zdb_id = '$OID'
	    and recattrib_source_zdb_id = '$pub_OID';">
      <?/MISQL>

      <?MISQL SQL="select WebExplode(object,'citlink_data_page=citgeneric.apg') from webPages where ID='aa-cittotalcount.apg';">$1<?/MISQL>

      <?MIBLOCK COND="$(AND,$(EC,$citlink_total_count,$citlink_total_count_before),$(!=,$citlink_total_count,0))">
        <?MIVAR NAME=xpcurup_alert>The data is still connected through other types of data.<?/MIVAR>
      <?/MIBLOCK>  

      <?MISQL SQL="
        select WebExplode(object,'permission=root&recweb_rec_id=$OID&recweb_pers_id=$ZDB_ident&recweb_pers_name=$ZDB_name&recweb_table_column=record_attribution&recweb_old_value=$pub_OID&recweb_new_value=none&recweb_comments=delete+record') 
        from webPages where ID='aa-record_web_update.apg';">
      <?/MISQL>      
  
  
      <?MIVAR NAME=OID>$pub_OID<?/MIVAR>
  <?/MIBLOCK>

    
    <?MIVAR COND=$(XST,$xpcurup_alert)>
      <script>
        alert('$xpcurup_alert');
      </script>
    <?/MIVAR>    
  
    <SCRIPT>
      setCookie('attribution_update','no','pubcur_c_')
    </SCRIPT>   
     
<?/MIBLOCK>  <?MICOMMENT> authorize = root <?/MICOMMENT>
