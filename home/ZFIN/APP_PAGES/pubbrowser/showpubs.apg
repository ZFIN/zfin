<?MICOMMENT>
***
FILE: SHOWPUBS.HTML

Within the viewers for all of the data types, you always want to do the same 
thing when it comes to pubs. This file factors out the commonality; everything 
just webexplodes this file. It assumes the existence of OID, which should be 
the zdb_id of the data record that you want the pubs for.ECK 8/30/97. Added 
sensitivity to UPDATE flag: If UPDATE exists, it tosses up a "Delete" button 
next to each pub. And added a "Add pub" to both primary and secondary pubs. 
THESE ASSUME THE EXISTENCE OF "Delete-listitem"  and "doit" functions (see 
fishview for example) in the viewing page! Obviously these functions should 
be connected to the "do-<class>update" script.

NOTE:
Because this page drops temporary tables it cannot be webexploded from
inside a select statement.  This page must first be retrieved with a 
select statement and then passed to webexplode from an execute function 
statement.  See discussion of the MIqry2pass variable in the Web
Datablade documentation.

INPUT VARS:
OID  -- the zdb_id of the rec
rtype -- return type,decide the return page,
         especially useful since different attributed items
         of one OID also use this file
title  --
name   --
abbrev -- for title display

orgOID -- OID for a gene, or fish or locus... record when
         OID is used for some specific item like 'DALIAS'
info  -- record attribution source type
pubOrder -- the column # to order results by (must be a number because of 'union')
OUTPUT VARS:

***        
<?/MICOMMENT>

<html>
<head>

<?MIERROR>
<html>
<script src="/javascript/header.js"></script>
<p>Looks like we are having trouble processing your request. You can...</p>
<ul>
    <li>try reloading the page to see if the problem persists</li>
    <li>head back to the <a href="/">home page</a></li>
    <li>send us an <a href="mailto:zfinadmn@zfin.org">email</a> and tell us about it</li>
</ul>

<?MIBLOCK COND="$(EC,$AUTHORIZED,root)">
    <p class="error">ROOT ONLY DEBUGGING</p>
    <pre><?MIVAR>
SQL:     $MI_SQL
Code:    $MI_ERRORCODE
State:   $MI_ERRORSTATE
Message: $MI_ERRORMSG
<?/MIVAR></pre>
<?/MIBLOCK>
<script src="/javascript/footer.js"></script>
</html>
<?/MIERROR>

<?MIBLOCK COND="$(NXST,$OID)">
<p> ERROR -- something bad happened -- no OID passed in!
<?/MIBLOCK>

<?MIVAR NAME=$MI_NOVALUE><?/MIVAR>
<?MIVAR NAME=$MI_NULL><?/MIVAR>
	
<?MIVAR COND="$(NXST,$rtype)" NAME=$rtype><?/MIVAR>
<?MIVAR COND="$(NXST,$title)" NAME=$title><?/MIVAR>
<?MIVAR COND="$(NXST,$name)" NAME=$name><?/MIVAR>
<?MIVAR COND="$(NXST,$abbrev)" NAME=$abbrev><?/MIVAR>
<?MIVAR COND="$(NXST,$mrkr_abbrev)" NAME=$mrkr_abbrev><?/MIVAR>
<?MIVAR COND="$(NXST,$mrkr_name)" NAME=$mrkr_name><?/MIVAR>

<?MIVAR COND="$(NXST,$orgOID)" NAME=$orgOID>$OID<?/MIVAR>
<?MIVAR COND="$(NXST,$info)" NAME=$info><?/MIVAR>
<?MIVAR COND="$(NXST,$pubOrder)" NAME=$pubOrder>authors_lower<?/MIVAR>
<?MIVAR NAME=$pubOrderType>, recattrib_source_type desc<?/MIVAR>

<?MIVAR COND="$(NXST,$add_cit_count)" NAME=$add_cit_count>0<?/MIVAR>

<?MIVAR COND="$(NXST,$return_page1)" NAME=$return_page1><?/MIVAR>
<?MIVAR COND="$(NXST,$return_page2)" NAME=$return_page2><?/MIVAR>
<?MIVAR COND="$(NXST,$target_table)" NAME=$target_table><?/MIVAR>

<?MIVAR COND="$(NXST,$query_from)" NAME=$query_from><?/MIVAR>
<?MIVAR COND="$(NXST,$query_where)" NAME=$query_where><?/MIVAR>
<?MIVAR COND="$(NXST,$mutsearch)" NAME=$mutsearch><?/MIVAR>
<?MIVAR COND="$(NXST,$pubcount)" NAME=$pubcount><?/MIVAR>
<?MIVAR COND="$(NXST,$caller)" NAME=$caller><?/MIVAR>
<?MIVAR COND="$(NXST,$geno_name)" NAME=$geno_name><?/MIVAR>
<?MIVAR COND="$(NXST,$feature_name)" NAME=$feature_name><?/MIVAR>
<?MIVAR COND="$(NXST,$ao_name)" NAME=$ao_name><?/MIVAR>
<?MIVAR COND="$(NXST,$goflag)" NAME=$goflag><?/MIVAR>
<?MIVAR NAME=cit_G_filter><?/MIVAR>
<?MIVAR COND="$(NXST,$recattrsrctype)" NAME=recattrsrctype>standard<?/MIVAR>
<?MIVAR COND=$(NC,$recattrsrctype,standard) NAME=cit_G_filter>and recattrib_source_type = '$recattrsrctype'<?/MIVAR>

<?MIVAR NAME=pub_G_display>links<?/MIVAR>
<?MISQL SQL="select count (*) from zdb_active_data where zactvd_zdb_id='$OID'"><?/MISQL>
  <?MIVAR NAME=$recattribcount>$1<?/MIVAR>
 
<?MIBLOCK COND="$(EC,$rtype,xpat)">
  <?MIBLOCK COND="$(NXST,$total_count)">
   <?MIVAR NAME=$total_count>$pubcount<?/MIVAR>
  <?/MIBLOCK>
<?/MIBLOCK>
<?MIVAR COND="$(NXST,$related_data_attrib_to_OID)" NAME=$related_data_attrib_to_OID><?/MIVAR>

<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Dropping fish table
<?/MISQL>

<?MIBLOCK COND="$(XST,$fish_table_created)">
<?MISQL SQL="drop table fish_search_list"><?/MISQL>
<?/MIBLOCK>

<?MIBLOCK COND="$(NC,$mutsearch,)">
<?MISQL SQL="select geno_zdb_id as fsl_zdb_id 
	from genotype 
	where (lower(geno_display_name) like '$mutsearch'
      	 or  lower(geno_handle) like '$mutsearch'  
	union 
	  select feature_zdb_id as fsl_zdb_id 
		from feature 
		where (lower(feature_name) like '$mutsearch'
		or  lower(feature_abbrev) like '$mutsearch') 
	  into temp fish_search_list"><?/MISQL>
<?MIVAR NAME=fish_table_created>true<?/MIVAR>
<?/MIBLOCK>
<?MIBLOCK COND="$(EC,$rtype,marker)">
  <?MIBLOCK COND="$(>,$(POSITION,$OID,GENE),0)">
   <?MISQL SQL="select get_mrkr_abbrev_html_link('$OID') from marker
               where mrkr_zdb_id='$OID'">
               <?MIVAR NAME=$mrkr_abbrev>$1<?/MIVAR>
    <?/MISQL>
  <?MIELSE>
   <?MISQL SQL="select get_mrkr_name_html_link('$OID') from marker
               where mrkr_zdb_id='$OID'">
               <?MIVAR NAME=$mrkr_name>$1<?/MIVAR>
   <?/MISQL>
<?/MIBLOCK>
<?/MIBLOCK>
<?MIBLOCK COND="$(AND,$(EC,$rtype,genotype),$(>,$(POSITION,$OID,GENO),0))">
   <?MISQL SQL="select get_geno_name_html_link('$OID') from genotype
               where geno_zdb_id='$OID'">
               <?MIVAR NAME=$geno_name>$1<?/MIVAR>
    <?/MISQL>
<?/MIBLOCK>
<?MIBLOCK COND="$(AND,$(EC,$rtype,genotype),$(>,$(POSITION,$OID,ALT),0))">
   <?MISQL SQL="select get_feature_name_html_link('$OID') from feature
               where feature_zdb_id='$OID'">
               <?MIVAR NAME=$feature_name>$1<?/MIVAR>
    <?/MISQL>
<?/MIBLOCK>
<?MIVAR>
$(IF,$(>,$(POSITION,$rtype,marker),0),
      $(SETVAR,$return_page1,aa-markerupdate.apg)
      $(SETVAR,$return_page2,aa-do-markerupdate.apg)
      $(SETVAR,$target_table,marker)
      )

$(IF,$(>,$(POSITION,$rtype,genotype),0),
      $(SETVAR,$return_page1,aa-genotypeview.apg)
      $(SETVAR,$return_page2,aa-do-markerupdate.apg)
      $(SETVAR,$jsdelatt_caller,genotypeview.apg)
      )

$(IF,$(>,$(POSITION,$OID,XPAT),0),
      $(SETVAR,$return_page1,aa-xpatupdatePubs.apg)
      $(SETVAR,$return_page2,aa-do-xpatupdatePubs.apg)
      $(SETVAR,$target_table,expression_experiment)
      )

$(IF,$(>,$(POSITION,$rtype,locus),0),
       $(SETVAR,$return_page1,aa-locusupdate.apg)
       $(SETVAR,$return_page2,aa-do-locusupdate.apg)
       $(SETVAR,$target_table,"")
       )

$(IF,$(>,$(POSITION,$rtype,goview),0),
       $(SETVAR,$return_page1,aa-markergoview.apg)
       $(SETVAR,$return_page2,aa-do-markergoedit.apg)
       $(SETVAR,$target_table,"")
       )


<?/MIVAR>


  <SCRIPT>
    <?MIVAR>
    
      function doit(attr,attr_type,print_name) {
        window.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=$return_page1&OID=$orgOID&dataOID=$OID&attr='+attr+'&attr_type='+attr_type+'&print_name='+print_name+'&target_table=$target_table');
      }

        <?MISQL SQL="select WebExplode(object,'jsdelatt_OID=$OID&jsdelatt_Mival=$return_page2&jsdelatt_page_var=__attr_type=special-listitem__new_value=deleted') 
        from webPages where ID='aa-js-delete_attrib.apg';">$1<?/MISQL>
        

      function Delete_listitem(item_name,item_id,source_type) {
        var url = '/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=$return_page2&OID=$OID&dataOID=$orgOID&attr='+item_name+'&attr_type=special-listitem&old_value='+item_id+'&new_value=deleted&target_table=$target_table&info=$info&source_type='+source_type ;
        
        window.location.replace(url);
      }
  
      function result_order(pubOrder,total_count,count_of_real_pub,evidence,infer,goterm,goflag)
      {
        var url = '/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-showpubs.apg&OID=$OID&rtype=$rtype&name=$(URLENCODE,$name)&abbrev=$abbrev&title=$(URLENCODE,$title)&total_count='+total_count+'&count_of_real_pub='+count_of_real_pub+'&pubOrder='+pubOrder+'&infer='+infer+'&goflag='+goflag+'&goterm='+goterm+'&evidence='+evidence;
        $(IF,$(XST,$UPDATE),url += '&UPDATE=1';)
    
        location.replace(url);
      }  

      function xpatresult(pubOrder,total_count,count_of_real_pub,evidence)
      {
        var url = '/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-showpubs.apg&OID=$OID&rtype=$rtype&name=$(URLENCODE,$name)&title=$(URLENCODE,$title)&query_from=$query_from&query_where=$(URLENCODE,$query_where)$(IF,$(XST,$mutsearch),&mutsearch=$(URLENCODE,$mutsearch))&caller=$caller&total_count='+total_count+'&count_of_real_pub='+count_of_real_pub+'&pubOrder='+pubOrder+'&evidence='+evidence;
        $(IF,$(XST,$UPDATE),url += '&UPDATE=1';)
    
        location.replace(url);
      }
  
   <?/MIVAR> 
 </SCRIPT>
</HEAD>
<?MICOMMENT>
        var url = '/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-showpubs.apg&OID=$OID&rtype=$rtype&name=$(URLENCODE,$name)&query_from=$query_from&query_where=$(URLENCODE,$query_where)$(IF,$(XST,$mutsearch),&mutsearch=$(URLENCODE,$mutsearch))&caller=$caller&total_count='+total_count+'&count_of_real_pub='+count_of_real_pub+'&pubOrder='+pubOrder+'&evidence='+evidence;
        $(IF,$(XST,$UPDATE),url += '&UPDATE=1';)
    
        location.replace(url);
<?/MICOMMENT>

<?MIVAR NAME=$userid>GUEST<?/MIVAR>

<?MICOMMENT> *** ----------------------- *** <?/MICOMMENT>

  <?MIBLOCK COND="$(XST,$UPDATE)">
        <?MIVAR>
       		<TITLE>Update Publication list </TITLE>
       	<?/MIVAR>
  <?MIELSE>
        <?MIVAR>
      		<TITLE>ZFIN Publication list </TITLE>
    	<?/MIVAR>
  <?/MIBLOCK>

  <?MISQL SQL="select WebExplode(object,'') 
		 from webPages 
		 where ID='aa-htmlpageheader.apg';">$1<?/MISQL>
  
  <?MIBLOCK COND="$(=,$recattribcount,0)">
<form><center><font size=4>
        <?MIVAR> <b>Requested ID not found in ZFIN.<?/MIVAR></font>
       </form>
<?MIELSE>
  <?MISQL COND="$(NXST,$UPDATE)"  SQL="select WebExplode(object,'') from webPages where ID='aa-secure_navigation.apg';">$1<?/MISQL>

  <?MICOMMENT>since genotype records are not like markers or images, they do not
              have record owner. Only root could edit.
  <?/MICOMMENT>
  <?MIVAR NAME=$perm_level>$(IF,$(EC,$rtype,genotype),root,owns)<?/MIVAR>
  
  <?MISQL COND="$(XST,$UPDATE)"  SQL="select WebExplode(object,'permission=$perm_level&rtype=$rtype') from webPages where ID='aa-secure_navigation.apg';">$1<?/MISQL>

<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Page Header
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MISQL COND="$(AND,$(NXST,$UPDATE),$(NC,$rtype,goview))" SQL="select WebExplode(object,'rtype=$rtype&calling_page=citation') from webPages where ID='aa-data_mgr.apg';">$1<?/MISQL>

<?MIVAR COND="$(XST,$UPDATE)">
        <form>
	  <center>
       <a 
       style="font-size: large;"
       href="javascript:" 
      onClick="document.location.replace('/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-showpubs.apg&orgOID=$orgOID&OID=$OID&rtype=$rtype&title=$(URLENCODE,$title)&name=$(URLENCODE,$name)&abbrev=$abbrev$(IF,$(XST,$total_count),&total_count=$total_count)$(IF,$(XST,$count_of_real_pub),&count_of_real_pub=$count_of_real_pub)$(IF,$(XST,$recattrsrctype),&recattrsrctype=$recattrsrctype)')"
      >[View Pubs]</a>
	   </font>
	  </center>
        </form>
<?/MIVAR>

  <?MIVAR NAME=related_data_attrib_to_OID>
      recattrib_data_zdb_id in (select mrel_zdb_id 
				 	from marker_relationship 
					where mrel_mrkr_2_zdb_id = '$OID')
    or
      recattrib_data_zdb_id in (select mrel_zdb_id 
					from marker_relationship 
					where mrel_mrkr_1_zdb_id = '$OID')
    or
      recattrib_data_zdb_id in (select dalias_zdb_id 
					from data_alias 
					where dalias_data_zdb_id = '$OID')
    or
      recattrib_data_zdb_id in (select dblink_zdb_id 
					from db_link 
					where dblink_linked_recid = '$OID')
    or
      recattrib_data_zdb_id in (select ortho_zdb_id
					from ortholog_evidence, ortholog
					where ortho_zebrafish_gene_zdb_id = '$OID'
					and oev_ortho_Zdb_id = ortho_Zdb_id)    
    or
      recattrib_data_zdb_id in (select mrkrgoev_zdb_id 
					from marker_go_term_evidence 
					where mrkrgoev_mrkr_zdb_id = '$OID')
    or 
      recattrib_data_zdb_id in (select fmrel_zdb_id 
                                        from feature_marker_relationship, marker 
                                        where fmrel_mrkr_zdb_id = mrkr_zdb_id
                                          and mrkr_zdb_id = '$OID')
    or 
      recattrib_data_zdb_id in (select genofeat_zdb_id 
                                        from genotype_feature, feature_marker_relationship, marker 
                                        where genofeat_feature_zdb_id = fmrel_ftr_zdb_id
                                          and fmrel_mrkr_zdb_id = mrkr_zdb_id
                                          and mrkr_zdb_id = '$OID')
   or 
      recattrib_data_zdb_id in (select genofeat_zdb_id 
                                        from genotype_feature, feature
                                        where genofeat_feature_zdb_id = feature_zdb_id
                                          and feature_zdb_id = '$OID')
  <?/MIVAR>
   

<TABLE width=100%><TR><TD bgcolor=#cccccc>
<?MISQL SQL="select WebExplode(object,'citlink_data_page=citgeneric.apg')
                 from webPages where ID='aa-cittotalcount.apg';">$1<?/MISQL>
<font size=+2><b>CITATIONS</b></font>
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Citation Count
<?/MISQL>
<?MICOMMENT> *** 
	want to include pubs associated with alleles of the locus and 
	with locus itself.  
	marker, locus and fish page will pass along total_count. Only for 
	the attribution list, need to recalculate the pubs 
	for the data items. *** <?/MICOMMENT>
<?MIBLOCK COND="$(XST,$total_count)">
  <?MIBLOCK COND="$(NE,$rtype,goview)">
    <?MIBLOCK COND="$(NXST,$attribtype)">
      <?MIVAR>($citlink_total_count total) <?/MIVAR>
    <?/MIBLOCK> 
   <?MIELSE>
   
   <?MIVAR>($total_count total) <?/MIVAR>
   <?/MIBLOCK>
<?MIELSE>
  <?MIBLOCK COND="$(NXST,$attribtype)">
    <?MIBLOCK COND="$(NE,$rtype,xpat)">
      <?MISQL SQL="
        select count(distinct recattrib_source_zdb_id)::integer 
          from record_attribution
         where (recattrib_data_zdb_id = '$OID'
            or $related_data_attrib_to_OID)
           and get_obj_type(recattrib_source_zdb_id) = 'PUB'
           $(IF,$(XST,$recattrsrctype),and recattrib_source_type = '$recattrsrctype');">
	<?MIVAR NAME=$sp_counter>$1<?/MIVAR>
	<?MIVAR>	($sp_counter total)<?/MIVAR> 
      <?/MISQL>	
    <?MIELSE>
      <br>
      <i>Click on a publication to view summary of gene expression reported.</i>
    <?/MIBLOCK>  
<?/MIBLOCK>    
<?/MIBLOCK>    
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Citation Count End
<?/MISQL>
</TD></TR></TABLE>
<p>
<?MIVAR NAME=pub_G_display>links<?/MIVAR>
<form>
<?MICOMMENT> *** ------------- Title display------------ *** <?/MICOMMENT>
<font size=+1><b>
  <?MIVAR COND="$(NC,$title,)">$title: <?/MIVAR>
  <?MIVAR COND="$(NC,$name,)">
    $(IF,$(OR,$(>,$(POSITION,$OID,OEVDISP),0),$(>,$(POSITION,$OID,GENE),0)),<i>$name</i>,$mrkr_name)
    <br>
  <?/MIVAR>

  <?MICOMMENT>previously I made a bad decision of passing $title to CITATION page, $marker_type_display would be a better choice. But to avoid changing all the view pages, stay on it for a bit longer<?/MICOMMENT>
  <?MIVAR NAME=$marker_type_display>$(SUBSTR,$title,1,$(-,$(POSITION,$title,Name),2))<?/MIVAR>

  <?MICOMMENT>we need a grace solution, not now, when feature redo comes.
       The full title'd better be a submodule. 
  <?/MICOMMENT>
  <?MIBLOCK COND="$(AND,$(NC,$abbrev,),$(NC,$abbrev,''))">
     <?MIVAR>
	$(IF,$(OR,$(>,$(POSITION,$OID,GENE),0),$(>,$(POSITION,$OID,OEVDISP),0)),$marker_type_display Symbol:&nbsp;<i>$mrkr_abbrev</i>)
	$(IF,$(OR,$(>,$(POSITION,$OID,GENO),0),$(>,$(POSITION,$OID,ALT),0)),Abbreviation:&nbsp;$geno_name)
     <?/MIVAR><br>
    <?MIELSE>
     <?MIVAR>
	$(IF,$(!=,$(POSITION,$OID,GENO),0),Genotype Name:&nbsp;$geno_name <?MIVAR><a class="popup-link data-popup-link" href="/action/genotype/genotype-detail-popup?zdbID=$OID"></a><?/MIVAR>)
	$(IF,$(>,$(POSITION,$OID,ALT),0),Feature Name:&nbsp;$feature_name)
	$(IF,$(>,$(POSITION,$OID,ANAT),0),Anatomy Name:&nbsp;$ao_name)
      <?/MIVAR><br>
  <?/MIBLOCK>

  <?MIBLOCK COND="$(>,$(POSITION,$OID,GEN0),1)">
   Genotype name=<?MIVAR>$geno_name<?/MIVAR>
  <?/MIBLOCK>


</b></font>	

    
<?MIVAR>
    <?MIVAR COND="$(NXST,$total_count)" NAME=$total_count><?/MIVAR>
    <?MIVAR COND="$(NXST,$count_of_real_pub)" NAME=$count_of_real_pub>-9<?/MIVAR>
    <?MIVAR COND="$(NXST,$evidence)" NAME=$evidence><?/MIVAR>
    <?MIVAR COND="$(NXST,$infer)" NAME=$infer><?/MIVAR>
    <?MIVAR COND="$(NXST,$goterm)" NAME=$goterm><?/MIVAR>
    <?MIVAR COND="$(NXST,$goflag)" NAME=$goflag><?/MIVAR>
<?MIBLOCK COND="$(NC,$rtype,xpat)">
<?MICOMMENT>  ==================== value= will not change value with Safari need special case ============== <?/MICOMMENT>
<?MIVAR>
    <input type=button name=resultOrder onClick="result_order($(IF,$(EC,$pubOrder,authors_lower),'pyear desc','authors_lower'),'$total_count','$count_of_real_pub','$evidence', '$infer', '$goterm', '$goflag')" value="$(IF,$(EC,$pubOrder,authors_lower),Order By Date,Order By Author)"> 
    <script>
      if (navigator.userAgent.indexOf('Safari') != -1) {
        resultOrder.value="$(IF,$(EC,$pubOrder,6),Order By Date,Order By Author)";
      }
    </script>
<?/MIVAR>


<?MICOMMENT>  ==================== hide "order by" button for rtype=xpat ============== <?/MICOMMENT>
<?MICOMMENT>
<?MIBLOCK COND="$(EC,pigs,flying)">
<?MIELSE>
<?MIVAR>
  <?MIBLOCK COND="$(NXST,$total_count)">
   <?MIVAR NAME=$total_count>$pubcount<?/MIVAR>
  <?/MIBLOCK>
    <input type=button name=resultOrderxpat onClick="xpatresult($(IF,$(EC,$pubOrder,6),'9 desc','6'),'$total_count','','','')"
           value="$(IF,$(EC,$pubOrder,6),Order By Date,Order By Author)"> 
<?/MIVAR>   
<?/MIBLOCK>
<?/MICOMMENT>

<?/MIBLOCK>
<?/MIVAR>		
<?MICOMMENT> *** ---------------- *** <?/MICOMMENT>

<?MIVAR COND="$(XST,$UPDATE)">
  <?MICOMMENT> no add button for genotype citation on this page <?/MICOMMENT>
  <?MIVAR COND="$(NC,$rtype,genotype)"> 
     <INPUT TYPE=button value="Add Publication" onClick="doit('rel_pub','selection','Add')"> 
  <?/MIVAR>

  <?MIBLOCK COND="$(AND,$(NXST,$attribtype),$(>,$(POSITION,$OID,ALT),0))">
   <b> Please use the individual  <?MIVAR><A HREF='/$OID'>allele</A><?/MIVAR> record to enter allele-specific publications.</b>
   <br>
  <?/MIBLOCK>
<?/MIVAR> 

<?MIBLOCK COND=$(XST,$cellpad)>
  <?MIVAR NAME=$showpubs_cellPadding>cellpadding="2"<?/MIVAR>
<?MIELSE>
  <?MIVAR NAME=$showpubs_cellPadding><?/MIVAR>
<?/MIBLOCK>

<?MIVAR NAME=showpubs_tr_color><!--|HIGHLIGHT_COLOR|--><?/MIVAR>
<?MIVAR NAME=showpubs_tr_bg>$showpubs_tr_color<?/MIVAR>


<TABLE cellspacing = 0 <?MIVAR>$showpubs_cellPadding<?/MIVAR>>


<?MICOMMENT>  *** for GO annotation reference, deal separate *** <?/MICOMMENT> 
<?MIBLOCK COND="$(NC,$rtype,goview)"> 


  <?MIBLOCK COND="$(=,$count_of_real_pub,-9)">
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Count Real Pubs
<?/MISQL>
    <?MIVAR NAME=$count_of_real_pub>0<?/MIVAR>
	
	
    
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Count Real Pub 2
<?/MISQL>    	


  <?/MIBLOCK>  <?MICOMMENT> Count of real_pub = -9<?/MICOMMENT>
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Count Real Pub End
<?/MISQL>

  <?MIBLOCK COND="$(=,$(POSITION,$rtype,xpat),0)">
    <?MIVAR COND="$(>,$count_of_real_pub,0)">
      <TR><TD><b>Publications  ($(FIX,$count_of_real_pub)): </b></TD></TR>
    <?/MIVAR>
  <?/MIBLOCK>

  <?MIBLOCK COND="$(NXST,$attribtype)">

<?MICOMMENT> authors_lower not authors must be sent to citgeneric.apg for correct ordering <?/MICOMMENT>
    <?MIBLOCK COND=$(EC,$pubOrder,authors)>
      <?MIVAR NAME=$citpubOrder>p.pub_authors_lower<?/MIVAR>
    <?MIELSE>
      <?MIVAR NAME=$citpubOrder>$pubOrder<?/MIVAR>
    <?/MIBLOCK>

    <?MIBLOCK COND="$(>,$(POSITION,$OID,ALT),0)">
<?MIBLOCK COND="$(EQ,$pubOrder,authors_lower)">
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
      <?/MISQL>
<?MIELSE>
<?MIVAR NAME=$pubOrderType><?/MIVAR>
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
<?/MISQL>
<?/MIBLOCK>
      <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-pub_rowdisplay.apg';">$1<?/MISQL>

    <?/MIBLOCK>


   <?MIBLOCK COND="$(AND,$(=,$(POSITION,$OID,ALT),0),$(=,$(POSITION,$OID,GENO),0),$(=,$(POSITION,$rtype,xpat),0))">
<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 Before SQL
<?/MISQL>
<?MIBLOCK COND="$(EQ,$pubOrder,authors_lower)">
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
      <?/MISQL>
<?MIELSE>
<?MIVAR NAME=$pubOrderType><?/MIVAR>
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
      <?/MISQL>


<?/MIBLOCK>

<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 MADE SQL
<?/MISQL>

      <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-pub_rowdisplay.apg';">$1<?/MISQL>

<?MISQL COND=$(XST,$debug_timing) SQL="
  execute function get_time()">
  <br>$1 LINKS displayed
<?/MISQL>

   <?/MIBLOCK>


  <?MIBLOCK COND="$(>,$(POSITION,$OID,GENO),0)">
<?MIBLOCK COND="$(EQ,$pubOrder,authors_lower)">
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
      <?/MISQL>
<?MIELSE>
<?MIVAR NAME=$pubOrderType><?/MIVAR>
      <?MISQL SQL="
        select WebExplode(object,'&sp_G_orderby=order by $pubOrder$pubOrderType&sp_G_jtype_option=published') 
        from webPages where ID='aa-citgeneric.apg';">
          <?MIVAR NAME=sp_G_sql>$sp_G_returnvar<?/MIVAR>
      <?/MISQL>
<?/MIBLOCK>
    <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-pub_rowdisplay.apg';">$1<?/MISQL>

  <?/MIBLOCK>









  <TR><TD>&nbsp;</TD></TR>

     <?MIVAR NAME=sp_G_jtype_option>unpublished<?/MIVAR>
     
     <?MISQL SQL="select WebExplode(object,'citlink_data_page=citgeneric.apg') from webPages where ID='aa-cittotalcount.apg';">$1<?/MISQL>

     <?MIVAR NAME=add_cit_count>$citlink_total_count<?/MIVAR>

    <?MIBLOCK COND="$(AND,$(=,$(POSITION,$rtype,xpat),0),
                          $(=,$(POSITION,$OID,MRKRGO),0),
                          $(>,$add_cit_count,0) )">
   
   <?MIVAR COND="$(>,$add_cit_count,0)">
     <TR><TD><b>Additional Citations ($add_cit_count):</b></TD></TR>
   <?/MIVAR>

     <?MIVAR NAME=pub_G_display>links<?/MIVAR>
     <?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-pub_rowdisplay.apg';">$1<?/MISQL>


  <?/MIBLOCK> <?MICOMMENT> *** add_cit_count > 0 *** <?/MICOMMENT>

 
 <?/MIBLOCK> <?MICOMMENT> *** end of attribtype *** <?/MICOMMENT>

<?MIELSE COND="$(EC,$rtype,goview)"> 

<?MICOMMENT>count of pubs depends on inference as well as modifier flag. The following is done to establish a where clause in case an inference is present<?/MICOMMENT>
 <?MIBLOCK COND="$(EQ,$infer,f)">
   <?MIVAR NAME=$infwhere>and mrkrgoev_zdb_id not in (select infgrmem_mrkrgoev_zdb_id from inference_group_member where mrkrgoev_zdb_id=infgrmem_mrkrgoev_zdb_id)<?/MIVAR>
 <?MIELSE>
   <?MIVAR NAME=$infwhere>and mrkrgoev_zdb_id in (select infgrmem_mrkrgoev_zdb_id from inference_group_member where mrkrgoev_zdb_id=infgrmem_mrkrgoev_zdb_id and  infgrmem_inferred_from='$inf')<?/MIVAR>
 <?/MIBLOCK>

<?MICOMMENT> block to count pubs if flag is present<?/MICOMMENT>
 <?MIBLOCK COND="$(EQ,$goflag,)">
      <?MISQL SQL="
  	select distinct title, 
		p.zdb_id, 
		year(pub_date) as pyear, 
		authors, 
		jrnl_abbrev, 
  	                case
		          when pub_volume is not null
		          then pub_volume || ':'
	                else
		          ''
		        end,	
		pub_pages, 
	 	pub_authors_lower as authors_lower, 
		pub_date
   	  from publication p, marker_go_term_evidence, journal
     	 where mrkrgoev_source_zdb_id = p.zdb_id
	   and mrkrgoev_mrkr_zdb_id = '$OID'
	   and jrnl_zdb_id = pub_jrnl_zdb_id
	   and mrkrgoev_term_zdb_id ='$goterm'
	   and mrkrgoev_evidence_code  ='$evidence'
	   and p.jtype not in ('Curation','Unpublished')
       and mrkrgoev_gflag_name is null
       $infwhere order by $pubOrder;">
  	<TR bgcolor=$showpubs_tr_bg>
    	<TD align=left>
      	<DIV class="show_pubs">
		<A HREF="/$2">$4 ($3) $1. $5.$6$7</A>
        </DIV>
    	</TD>
  	</TR>

        <?MIVAR NAME=$showpubs_tr_bg>$(IF,$(EC,$showpubs_tr_bg,$showpubs_tr_color),,$showpubs_tr_color)<?/MIVAR>

  	<?/MISQL>

<?MICOMMENT> SQL for listing pubs of type Curation or Unpublished<?/MICOMMENT>
  <TR><TD>&nbsp;</TD><TR>
      <?MISQL SQL="
  	select distinct title, 
		p.zdb_id, 
		year(pub_date) as pyear, 
		authors, 
		jrnl_abbrev, 
  	                case
		          when pub_volume is not null
		          then pub_volume || ':'
	                else
		          ''
		        end,	
		pub_pages, 
	 	pub_authors_lower, 
		pub_date
   	  from publication p, marker_go_term_evidence, journal
     	 where mrkrgoev_source_zdb_id = p.zdb_id
	   and mrkrgoev_mrkr_zdb_id = '$OID'
	   and mrkrgoev_term_zdb_id ='$goterm'
	   and mrkrgoev_evidence_code  ='$evidence'
	   and jrnl_zdb_id = pub_jrnl_zdb_id
	   and p.jtype in ('Curation','Unpublished')
       and mrkrgoev_gflag_name is null
        $infwhere;">

  	<TR bgcolor=$showpubs_tr_bg>
    	<TD align=left>
      	<DIV class="show_pubs">
		<A HREF="/$2">$4 ($3) $1. $5.</A>
        </DIV>
    	</TD>
  	</TR>
        <?MIVAR NAME=$showpubs_tr_bg>$(IF,$(EC,$showpubs_tr_bg,$showpubs_tr_color),,$showpubs_tr_color)<?/MIVAR>

      <?/MISQL>
   
<?MIELSE>
      <?MISQL SQL="
  	select distinct title, 
		p.zdb_id, 
		year(pub_date) as pyear, 
		authors, 
		jrnl_abbrev, 
  	                case
		          when pub_volume is not null
		          then pub_volume || ':'
	                else
		          ''
		        end,	
		pub_pages, 
	 	pub_authors_lower, 
		pub_date
   	  from publication p, marker_go_term_evidence, journal
     	 where mrkrgoev_source_zdb_id = p.zdb_id
	   and mrkrgoev_mrkr_zdb_id = '$OID'
	   and jrnl_zdb_id = pub_jrnl_zdb_id
	   and mrkrgoev_term_zdb_id ='$goterm'
	   and mrkrgoev_evidence_code  ='$evidence'
	   and p.jtype not in ('Curation','Unpublished')
       and mrkrgoev_gflag_name is null
       $infwhere;">
  	<TR bgcolor=$showpubs_tr_bg>
    	<TD align=left>
      	<DIV class="show_pubs">
		<A HREF="/$2">$4 ($3) $1. $5.</A>
        </DIV>
    	</TD>
  	</TR>

        <?MIVAR NAME=$showpubs_tr_bg>$(IF,$(EC,$showpubs_tr_bg,$showpubs_tr_color),,$showpubs_tr_color)<?/MIVAR>

  	<?/MISQL>
<?MICOMMENT> SQL for listing pubs of type Curation or Unpublished<?/MICOMMENT>
  <TR><TD>&nbsp;</TD><TR>
      <?MISQL SQL="
  	select distinct title, 
		p.zdb_id, 
		year(pub_date) as pyear, 
		authors, 
		jrnl_abbrev, 
  	                case
		          when pub_volume is not null
		          then pub_volume || ':'
	                else
		          ''
		        end,	
		pub_pages, 
	 	pub_authors_lower, 
		pub_date
   	  from publication p, marker_go_term_evidence, journal
     	 where mrkrgoev_source_zdb_id = p.zdb_id
	   and mrkrgoev_mrkr_zdb_id = '$OID'
	   and jrnl_zdb_id = pub_jrnl_zdb_id
	   and mrkrgoev_term_zdb_id ='$goterm'
	   and mrkrgoev_evidence_code  ='$evidence'
	   and p.jtype  in ('Curation','Unpublished')
        and mrkrgoev_gflag_name is null
         $infwhere;">
  	<TR bgcolor=$showpubs_tr_bg>
    	<TD align=left>
      	<DIV class="show_pubs">
		<A HREF="/$2">$4 ($3) $1. $5.</A>
        </DIV>
    	</TD>
  	</TR>
        <?MIVAR NAME=$showpubs_tr_bg>$(IF,$(EC,$showpubs_tr_bg,$showpubs_tr_color),,$showpubs_tr_color)<?/MIVAR>

      <?/MISQL>
<?/MIBLOCK>

<?MICOMMENT> end block if flag present<?/MICOMMENT>


<?/MIBLOCK> <?MICOMMENT> end of go *** <?/MICOMMENT>

</TABLE>

</form>

<?MISQL COND=$(EC,1,0) SQL="drop table all_curation_pubs_temp;"><?/MISQL>

<?/MIBLOCK><?MICOMMENT> -- end of $AUTHORIZED check -- <?/MICOMMENT>
<?/MIBLOCK>
<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>
<?MIBLOCK COND="$(XST,$fish_table_created)">
  <?MICOMMENT> *** delete temp table, with dummy insert because otherwise it's an illegal statement  *** <?/MICOMMENT>

  <?MISQL SQL="insert into fish_search_list (fsl_zdb_id) values (NULL);
drop table fish_search_list;">
  <?/MISQL>
<?/MIBLOCK>
</HTML>

