<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>

<?MIBLOCK COND="$(XST,$mname)">
  <?MIVAR>  <TITLE>ZFIN Marker Added: $mname</TITLE>  <?/MIVAR>
<?MIELSE>
  <TITLE>ZFIN Add Marker</TITLE>
<?/MIBLOCK>

<?MIVAR COND="$(AND,$(NXST,$OID),$(XST,$temp_oid))" NAME=$OID>$temp_oid<?/MIVAR>



<?MISQL SQL="
  select WebExplode(object,'') 
    from webPages 
    where ID='aa-chromoscripts.apg';">
  $1
<?/MISQL>

  </head>


<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpageheader.apg';">$1<?/MISQL>


<?MICOMMENT>
  -- new_marker.apg.   A very simple data entry page (because it does not 
  -- need to support digressions) to allow entry of new MARKER 
  -- records.

  -- VARS:
  -- marker_type -- if it doesn't exist, it starts by asking you this. 
  --                If it exists, prompt for appropriate info.
  -- s_new       -- if it exists, create new record and print a confirmation.
  -- Others      -- if s_new exists, then name, abbrev, comments should
  --                also exist.
<?/MICOMMENT>

<basefont size=2>

<?MISQL SQL="
  select WebExplode(object,'page_title=New Marker&permission=root') 
    from webPages 
    where ID='aa-secure_navigation.apg';">$1
<?/MISQL>

<?MIBLOCK COND="$(NC,$AUTHORIZED,false)">

  <?MIBLOCK COND="$(NXST,$marker_type)">
    <h1>Create new marker</h1>

    <form name=newdata method=post action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->">
      <input type=hidden name=MIval value=aa-new_marker.apg>

      <b>Type of new marker to create:</b>
      <SELECT name=marker_type>
	<option>GENE
	<option>EST
	<option>RAPD
	<option>SSLP
	<option>STS
	<option>AFLP
      </SELECT>  

      <input type=submit value="create it">
    </form>
  <?/MIBLOCK>

  <?MIBLOCK COND="$(AND,$(XST,$marker_type),$(NXST,$s_new))">

    <?MIVAR>
      <h1>Describe new $(UPPER,$marker_type)</h1>
    <?/MIVAR>
    <SCRIPT>
      // whitespace characters
      var whitespace = " \t\n\r";
    
      // Check whether string s is empty.   
      
      function isEmpty(s)
      {   return ((s == null) || (s.length == 0))
      }
      
      
      
      // Returns true if string s is empty or 
      // whitespace characters only.
   
      function isWhitespace (s)
      
      {   var i;
      
          // Is s empty?
          if (isEmpty(s)) return true;
      
          // Search through string's characters one by one
          // until we find a non-whitespace character.
          // When we do, return false; if we don't, return true.
      
          for (i = 0; i < s.length; i++)
          {   
              // Check that current character isn't whitespace.
              var c = s.charAt(i);
      
              if (whitespace.indexOf(c) == -1) return false;
          }
      
          // All characters are whitespace.
          return true;
      }


      //Radio Buttons are stored as an array
      //Loop through the array
      //Return the checked item
      
      function GetChecked(radioButton)
      {
        for ( var i=0; i<radioButton.length; i++ )
        {
           if ( radioButton[i].checked == true )
           {
              return( radioButton[i].value );
           }
        }
      
        return("");
      }
      
      function validate(theform) 
      {
        var reserve = GetChecked(theform.reserve);
        var rsrvComment = theform.rsrvComment.value;
        
        if (theform.mname.value=='' || theform.abbrev.value=='') 
        {
	  alert('You must supply both name and abbreviation');
	  return false;
        } 
        
        if (reserve=='yes' && isWhitespace(rsrvComment)) 
        {
          alert('Missing Input: Reservations require a comment.');
          theform.rsrvComment.focus();
          return false;
        }
        
        return true;
      }
    </SCRIPT>

    <?MIVAR>
      <form name=newdata onSubmit="return validate(this);" method=post action="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->">
        <input type=hidden name=MIval value=aa-new_marker.apg>
        <input type=hidden name=marker_type value="$marker_type">

        <p><B>$(UPPER,$marker_type) name</b> (required):
        <input type=text name=mname size=80>

        <p><b>Abbreviation</b> (required):
        <input type=text name=abbrev size=15>
        
        <p>
        <b>Description:</b><br>
        <TEXTAREA rows=5 cols=50 name=comments></TEXTAREA>

        <?MIBLOCK COND=$(EC,$(LOWER,$marker_type),gene)>
        <p><b>Is this a reservation?</b>:
        Yes <input type=radio name=reserve value=yes> / No <input type=radio name=reserve value=no checked>
        <br>Comments: <input type=text name=rsrvComment size=50>
        <?/MIBLOCK>
        <p>

        <input type=submit name=s_new value="Submit new $(UPPER,$marker_type)">
      </form>
    <?/MIVAR>

  <?/MIBLOCK> <!-- ends specifying params -->

  <!-- if marker values submitted -->
  <?MIBLOCK COND="$(XST,$s_new)">
    <?MIVAR COND="$(NXST,$comments)" NAME=$comments><?/MIVAR>

    <?MIVAR NAME=$mname DELIMIT="'" REPLACE="''">$mname<?/MIVAR>
    <?MIVAR NAME=$abbrev DELIMIT="'" REPLACE="''">$abbrev<?/MIVAR>
    <?MIVAR NAME=$comments DELIMIT="'" REPLACE="''">$comments<?/MIVAR>

    <?MISQL SQL="execute function get_id('$(UPPER,$marker_type)');"><?/MISQL>
    <?MIVAR NAME=$new_id>$1<?/MIVAR>

    <?MISQL SQL="
      insert into zdb_active_data 
        (zactvd_zdb_id) 
        values ('$new_id');">
    <?/MISQL>

    <?MISQL SQL="
      insert into marker 
        (mrkr_zdb_id, mrkr_name, mrkr_abbrev, mrkr_type, mrkr_comments, mrkr_owner) 
        values ('$new_id', '$mname', '$abbrev', '$(UPPER,$marker_type)',
                '$comments', '$ZDB_ident');">
    <?/MISQL>

    <?MIBLOCK COND=$(EC,$reserve,yes)>
      <?MISQL SQL="execute function get_id('NOMEN');"><?/MISQL>
      <?MIVAR NAME=$mhist_id>$1<?/MIVAR>
      <?MIVAR NAME=$rsrvComment COND=$(NXST,$rsrvComment)><?/MIVAR>
    
      <?MISQL SQL="
        INSERT INTO zdb_active_data VALUES('$mhist_id');
        insert into marker_history ( 
                        mhist_zdb_id, 
                        mhist_mrkr_zdb_id, 
                        mhist_event, 
                        mhist_reason, 
                        mhist_date,
                        mhist_mrkr_name_on_mhist_date,
                        mhist_mrkr_abbrev_on_mhist_date,
                        mhist_comments )
               select '$mhist_id',
                        mrkr_zdb_id,
                        'reserved',
                        'per personal communication with authors',
                        CURRENT,
                        mrkr_name,
                        mrkr_abbrev,
                        '$rsrvComment'
               from marker
               where mrkr_zdb_id = '$new_id';">
      <?/MISQL>
    <?/MIBLOCK>

    <?MIVAR>
      <h1>Confirmation: $(UPPER,$marker_type) record added</h1>

      Click <A href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-markerview.apg&OID=$new_id">here</A>
      to view the new $marker_type record.
      <p>
      Click <A href="/<!--|WEBDRIVER_PATH_FROM_ROOT|-->?MIval=aa-ZDB_home.apg">here</A> 
      to return to the ZFIN home page.
    <?/MIVAR>

  <?/MIBLOCK>

<?/MIBLOCK> <!-- ends Authorized -->



<?MISQL SQL="select WebExplode(object,'') from webPages where ID='aa-htmlpagefooter.apg';">$1<?/MISQL>


