def env = System.getenv()
def dbname = env['DBNAME']

task deployPostgresFunctions {
    description = "deploy postgres function in PG"

    doLast {
        println "deploying postgres functions ..."
        int numberOfFunctions = runSqlFiles(".")
        println "Deployed functions: " + numberOfFunctions
    }
}

File[] fileList(String dir) {
    file(dir).listFiles().sort()
}

int runSqlFiles(String directory) {

    def env = System.getenv()
    def dbname = env['DBNAME']
    def pgbindir = env['PGBINDIR']


    int numberOfProc = 0;

    fileList(directory).each {
        File file ->
            if (file.getName().endsWith(".sql")) {
                String command = pgbindir + "/psql -d " + dbname + " -a -f " + file.getAbsoluteFile();
                // will execute command, return the text output from the executed command, and print to screen.
                //println command.execute().text
                command.execute().text
                numberOfProc++;
            }
            if (file.isDirectory()) {
                int number = runSqlFiles(file.getAbsolutePath())
                println "deployed " + number + " files in subdirectory: " + file.getName()
            }
    }
    return numberOfProc;
}

task dropFunctions() {
    doLast {
        description = "drop all functions from the database"
        exec { commandLine "bash", "-c", "psql $dbname < ./dropFunctions" }
    }
}