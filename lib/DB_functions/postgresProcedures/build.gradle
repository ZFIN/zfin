def env = System.getenv()
def dbname = env['DBNAME']

task deployPostgresProcedures {
    description = "deploy postgres procedures in PG"
    doLast {
        println "deploying postgres procedures ..."
        int numberOfTrigger = runSqlFiles(".")
        println "deployed " + numberOfTrigger + " procedures ..."
    }
}


File[] fileList(String dir) {
    file(dir).listFiles({ file -> file.isFile() } as FileFilter).sort()
}


int runSqlFiles(String directory){
    int numberOfTrigger = 0;
    fileList(directory).each {
        File file ->
            if (file.getName().endsWith(".sql")) {
                String command = "psql -d " + project.dbname + " -a -f " + file.getAbsoluteFile();
                //println command
                command.execute().text
                numberOfTrigger++;
            }
    }
    return numberOfTrigger;
}

/*
list all functions in postgres

SELECT  proname, proargnames, prosrc
FROM    pg_catalog.pg_namespace n
JOIN    pg_catalog.pg_proc p
ON      pronamespace = n.oid
WHERE   nspname = 'public ';
*/
