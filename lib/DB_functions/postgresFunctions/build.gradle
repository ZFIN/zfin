
def env = System.getenv()
def dbname = env['DBNAME']
def sourceroot = env['SOURCEROOT']

task deployPostgresFunctions {
    description = "deploy postgres function in PG"
    
    doLast {
        println "deploying postgres functions ..."
        int numberOfTrigger = runSqlFiles(".")
        println "deployed " + numberOfTrigger + " functions."
    }
}

task killConnectionsToPostgres {
     description = "kill all connections to postgres db defined in dbname."

     doLast {
     	 File file = file(sourceroot +'/killConnectionsToPostgres.sql');
	 println file.getPath();
    	 String command = "echo \"SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname ='" + dbname +"' AND pid <> pg_backend_pid();\" | " + "psql -d " + dbname;
	 println command
    	 command.execute().text
     }
}


File[] fileList(String dir) {
    file(dir).listFiles({ file -> file.isFile() } as FileFilter).sort()
}

int runSqlFiles(String directory){
    int numberOfTrigger = 0;
    fileList(directory).each {
        File file ->
            if (file.getName().endsWith(".sql")) {
                String command = "psql -d " + dbname + " -a -f " + file.getAbsoluteFile();
		// will execute command, return the text output from the executed command, and print to screen.
                println command.execute().text
                numberOfTrigger++;
            }
    }
    return numberOfTrigger;
}



