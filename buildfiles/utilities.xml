<?xml version="1.0" encoding="UTF-8"?>
<project name="utilities" basedir=".">

    <target name="check-entity" depends="compile,build-tests"
            description="Tests to make sure that the system is alive and working properly.">
        <echo message="Check entity changes"/>
        <java classname="org.zfin.util.database.InspectDataHistory" fork="yes" classpathref="extended.classpath"
              failonerror="true" maxmemory="1024M">
            <classpath refid="classpath"/>
            <arg value="-unloadDirectory"/>
            <arg value="/research/zunloads/databases/trunkdb"/>
            <arg value="-tableNames"/>
            <arg value="term"/>
            <arg value="-entityId"/>
            <arg value="ZDB-ANAT-081013-35"/>
            <arg value="-action"/>
            <arg value="TRACE_ENTITY"/>
            <arg value="-indexerLocation"/>
            <arg value="${TARGETROOT}/home/WEB-INF/unload-index"/>
        </java>
    </target>

    <target name="check-diff" depends="compile,build-tests"
            description="Tests to make sure that the system is alive and working properly.">
        <echo message="Check differences of database tables"/>
        <java classname="org.zfin.util.database.CompareDatabases" fork="yes" classpathref="extended.classpath"
              failonerror="true" maxmemory="512M">
            <classpath refid="classpath"/>
            <arg value="-databaseName"/>
            <arg value="testdb"/>
            <arg value="-tableNames"/>
            <arg value="expression_result"/>
        </java>
    </target>

    <target name="index-unloads" depends="compile"
            description="Tests to make sure that the system is alive and working properly.">
        <echo message="Check differences of database tables"/>
        <echo message="TARGETROOT value: '${TARGETROOT}'"/>
        <java classname="org.zfin.util.database.DatabaseIndexer" fork="yes" classpathref="extended.classpath"
              failonerror="true" maxmemory="512M">
            <classpath refid="classpath"/>
            <arg value="-updateIndex"/>
            <arg value="false"/>
            <arg value="-indexLastUnloads"/>
            <arg value="14"/>
            <arg value="-tables"/>
            <arg value="term,person"/>
        </java>
    </target>

    <target name="index-all" depends="compile"
            description="Tests to make sure that the system is alive and working properly.">
        <echo message="Check differences of database tables"/>
        <echo message="TARGETROOT value: '${TARGETROOT}'"/>
        <java classname="org.zfin.util.database.DatabaseIndexer" fork="yes" classpathref="extended.classpath"
              failonerror="true" maxmemory="2048M">
            <classpath refid="classpath"/>
            <arg value="-updateIndex"/>
            <arg value="false"/>
            <arg value="-indexLastUnloads"/>
            <arg value="5"/>
        </java>
    </target>

    <property name="indexerDir" value="${TARGETROOT}/home/WEB-INF/unload-index"/>

    <target name="remove-index-files" description="Tests to make sure that the system is alive and working properly.">
        <echo message="Remove Index Files in ${indexerDir}"/>
        <delete dir="${indexerDir}"/>
    </target>

    <target name="move-crick-to-watson" description="Synchornize Jenkins on crick with watson">
        <echo message="Synchronizing Jenkins jobs: copy Crick files onto Watson"/>
        <exec executable="rsync" failifexecutionfails="true">
            <arg value="-avz"/>
            <arg value="/net/crick.zfin.org/opt/zfin/www_homes/zfin.org/server_apps/jenkins/jenkins-home/jobs/"/>
            <arg value="/opt/zfin/www_homes/zfin.org/server_apps/jenkins/jenkins-home/jobs/"/>
        </exec>
        <echo message=":rsync SUCCESSFUL:"/>
    </target>


    <macrodef name="remove-old-files" description="Remove files older that a given date">
        <attribute name="removal.date"/>
        <attribute name="cleanup.dir"/>
        <sequential>
            <echo>Deleting files older than @{removal.date}</echo>
            <echo>Deleting files from dir: @{cleanup.dir}</echo>
            <delete includeemptydirs="true" verbose="true" failonerror="false">
                <fileset dir="@{cleanup.dir}" includes="**/*">
                    <date datetime="@{removal.date}" when="before"/>
                </fileset>
            </delete>
        </sequential>
    </macrodef>

</project>
