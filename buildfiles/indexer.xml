<?xml version="1.0" encoding="UTF-8"?>

<project name="IndexApp" default="run-indexer" basedir="../../">

    <property name="web.dir" value="${basedir}/home"/>
    <property name="web-inf.dir" value="${web.dir}/WEB-INF"/>
    <property name="classbin.dir" value="${web-inf.dir}/classes"/>
    <property name="lib" value="${basedir}/lib/Java"/>
    <property name="web.lib" value="${web-inf.dir}/lib"/>

    <property name="uniqueryDir" value="${basedir}/server_apps/quicksearch"/>
    <property name="newIndexDir" value="${uniqueryDir}/new_indexes"/>
    <property name="oldIndexDir" value="${uniqueryDir}/old_indexes"/>
    <property name="indexDir" value="${uniqueryDir}/indexes"/>
    <property name="indexAppDir" value="${uniqueryDir}"/>
    <property name="logsDir" value="${uniqueryDir}/logs"/>

    <property environment="env" />

    <!-- Classpath definitions -->
    <path id="classpath">
        <pathelement location="${classbin.dir}"/>
        <pathelement path="${logsDir}"/>
        <fileset dir="${web.lib}">
            <include name="*.jar"/>
        </fileset>
    </path>

    <path id="extended.classpath">
        <path refid="classpath"/>
        <fileset dir="${env.CATALINA_HOME}/endorsed">
            <include name="*.jar"/>
            <include name="*.zip"/>
        </fileset>
    </path>

    <target name="init">
        <tstamp/>
        <echo message="Regenerating Indexes."/>
    </target>

    <target name="create-new-index-folder" description="Remove this folder that should not be there and create 
                  the index folder if not present">
        <delete dir="${newIndexDir}"/>
        <mkdir dir="${newIndexDir}"/>
        <mkdir dir="${indexDir}"/>
    </target>

    <target name="rotate-indexes">
        <delete dir="${oldIndexDir}"/>
        <mkdir dir="${oldIndexDir}"/>
        <move todir="${oldIndexDir}">
            <fileset dir="${indexDir}"/>
        </move>
        <move todir="${indexDir}">
            <fileset dir="${newIndexDir}"/>
        </move>
    </target>

    <property name="unload-dir" value="${env.INDEXER_UNLOAD_DIRECTORY}" />

    <target name="unload-index">
        <tstamp>
            <format property="time-stamp" pattern="yyyy.MM.dd" />
        </tstamp>
        <echo message="Time stamp: ${time-stamp}" />
        <mkdir dir="${unload-dir}/${time-stamp}"/>
	<copy todir="${unload-dir}/${time-stamp}">
	     <fileset dir="${indexDir}"/>
        </copy>
    </target>


    <target name="run-indexer" depends="init" description="run the indexer">
        <echo message="Launching Java Indexer"/>
        <java classname="org.zfin.uniquery.Indexer" fork="yes" classpathref="extended.classpath" failonerror="true"
		maxmemory="2048m" >
            <classpath refid="classpath"/>
            <arg value="-u"/>
            <arg value="${indexAppDir}/etc/searchurls.txt"/>
            <arg value="-e"/>
            <arg value="${indexAppDir}/etc/excludeurls.txt"/>
            <arg value="-c"/>
            <arg value="${indexAppDir}/etc/crawlonlyurls.txt"/>
            <arg value="-t"/>
            <arg value="3"/>
            <arg value="-categoryDir"/>
            <arg value="${web-inf.dir}/conf"/>
            <arg value="-indexerDir"/>
            <arg value="${indexAppDir}"/>
            <arg value="-zfinPropertiesDir"/>
            <arg value="${web-inf.dir}/zfin.properties"/>
        </java>
    </target>

    <target name="run-indexer-test" depends="init" description="run the indexer">
        <echo message="Launching Java Indexer"/>
        <java classname="org.zfin.uniquery.Indexer" fork="yes" classpathref="extended.classpath" failonerror="true">
            <classpath refid="classpath"/>
            <arg value="-u"/>
            <arg value="${indexAppDir}/etc/searchurls.txt"/>
            <arg value="-e"/>
            <arg value="${indexAppDir}/etc/excludeurls.txt"/>
            <arg value="-c"/>
            <arg value="${indexAppDir}/etc/crawlonlyurls.txt"/>
            <arg value="-t"/>
            <arg value="1"/>
            <arg value="-indexerDir"/>
            <arg value="${indexAppDir}"/>
            <arg value="-categoryDir"/>
            <arg value="${web-inf.dir}/conf"/>
            <arg value="-numberOfDetailPages"/>
            <arg value="3"/>
            <arg value="-zfinPropertiesDir"/>
            <arg value="${web-inf.dir}/zfin.properties"/>
            <arg value="-createDetailPageList"/>
            <arg value="true"/>
        </java>
    </target>

    <target name="generate-detail-page-urls" depends="init" description="generates the list of all entity detail page urls">
        <echo message="Generate entity detail page URLs"/>
        <java classname="org.zfin.uniquery.GenerateEntityDetailPageUrls" fork="yes" classpathref="extended.classpath" failonerror="true">
            <classpath refid="classpath"/>
            <arg value="-log4jFilename"/>
            <arg value="${logsDir}/log4j.xml"/>
            <arg value="-webrootDirectory"/>
            <arg value="${web.dir}"/>
            <arg value="-workingDirectory"/>
            <arg value="server_apps/quicksearch"/>
            <arg value="-numberOfDetailPages"/>
            <arg value="0"/>
        </java>
    </target>

    <target name="generate-detail-page-urls-test" depends="init" description="generates the list of all entity detail page urls">
        <echo message="Generate entity detail page URLs"/>
        <java classname="org.zfin.uniquery.GenerateEntityDetailPageUrls" fork="yes" classpathref="extended.classpath" failonerror="true">
            <classpath refid="classpath"/>
            <arg value="-numberOfDetailPages"/>
            <arg value="6"/>
            <arg value="-log4jFilename"/>
            <arg value="${logsDir}/log4j.xml"/>
            <arg value="-webrootDirectory"/>
            <arg value="${web.dir}"/>
            <arg value="-workingDirectory"/>
            <arg value="server_apps/quicksearch"/>
            <arg value="-numberOfDetailPages"/>
            <arg value="5"/>
        </java>
    </target>

    <target name="index" depends="create-new-index-folder, run-indexer, rotate-indexes, unload-index"/>

    <target name="index-test" depends="create-new-index-folder, run-indexer-test, rotate-indexes, unload-index"/>

    <target name="usage">
        <echo>
            TARGETS
            run-indexer
        </echo>
    </target>

</project>
